<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COT Index Calculator â€” ICT Trader</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c0f;
    --surface: #111318;
    --border: #2a2f38;
    --border-bright: #3a4150;
    --text: #e8eaf0;
    --muted: #8b94a5;
    --accent: #c8a96e;
    --red: #e05c5c;
    --green: #5cc8a0;
    --yellow: #e0c05c;
    --neutral: #8899bb;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    min-height: 100vh;
    padding: 40px 20px 80px;
    background-image:
      radial-gradient(ellipse 60% 40% at 80% 10%, rgba(200,169,110,0.04) 0%, transparent 60%),
      radial-gradient(ellipse 40% 60% at 10% 80%, rgba(92,200,160,0.03) 0%, transparent 60%);
  }
  .container { max-width: 960px; margin: 0 auto; }

  header { margin-bottom: 40px; border-bottom: 1px solid var(--border-bright); padding-bottom: 24px; }
  .tag { font-size: 12px; letter-spacing: 0.2em; color: var(--accent); text-transform: uppercase; margin-bottom: 8px; }
  h1 { font-family: 'Syne', sans-serif; font-size: clamp(26px, 5vw, 40px); font-weight: 800; letter-spacing: -0.02em; line-height: 1.1; }
  h1 span { color: var(--accent); }
  .subtitle { margin-top: 8px; color: var(--muted); font-size: 14px; letter-spacing: 0.05em; }

  /* Tabs */
  .tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 0; }
  .tab-btn {
    font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700;
    letter-spacing: 0.12em; text-transform: uppercase;
    padding: 10px 20px; background: none; border: none;
    color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent;
    margin-bottom: -1px; transition: color 0.2s, border-color 0.2s;
  }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-btn:hover:not(.active) { color: var(--text); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* Grid */
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 24px; }
  .card-label { font-size: 12px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 14px; }

  .input-group { display: flex; flex-direction: column; gap: 12px; }
  .field { display: flex; flex-direction: column; gap: 5px; }
  label { font-size: 13px; color: var(--muted); letter-spacing: 0.08em; }

  input[type="text"], select {
    background: var(--bg); border: 1px solid var(--border-bright);
    color: var(--text); font-family: 'Space Mono', monospace;
    font-size: 16px; padding: 11px 14px; border-radius: 2px;
    outline: none; transition: border-color 0.2s; width: 100%;
  }
  input[type="text"]:focus, select:focus { border-color: var(--accent); }
  input[type="text"].input-error { border-color: var(--red); background: rgba(224,92,92,0.05); }
  .input-hint { font-size: 12px; color: var(--muted); margin-top: 2px; letter-spacing: 0.03em; }
  .input-hint.ok { color: var(--green); }
  .input-hint.error { color: var(--red); }

  .btn-calc {
    width: 100%; background: var(--accent); color: #0a0c0f;
    border: none; font-family: 'Syne', sans-serif; font-weight: 700;
    font-size: 14px; letter-spacing: 0.1em; text-transform: uppercase;
    padding: 13px; border-radius: 2px; cursor: pointer; margin-top: 4px;
    transition: opacity 0.2s, transform 0.1s;
  }
  .btn-calc:hover { opacity: 0.85; }
  .btn-calc:active { transform: scale(0.99); }

  /* Result */
  .result-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 4px; padding: 26px; margin-bottom: 16px; display: none;
  }
  .result-card.show { display: block; }
  .result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
  .result-pair { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 600; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; }
  .result-index { font-family: 'Syne', sans-serif; font-size: 50px; font-weight: 800; line-height: 1; letter-spacing: -0.03em; }
  .bias-badge { display: inline-block; padding: 3px 12px; border-radius: 2px; font-size: 12px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; margin-top: 6px; }
  .signal-text { font-size: 14px; color: var(--muted); margin-top: 4px; line-height: 1.6; }
  .formula-line { font-size: 13px; color: var(--muted); line-height: 1.8; }
  .formula-line span { color: var(--accent); }

  .gauge-wrap { margin: 20px 0 16px; }
  .gauge-track { height: 6px; border-radius: 3px; position: relative; margin-bottom: 6px;
    background: linear-gradient(90deg, var(--red) 0%, var(--red) 10%, var(--yellow) 25%, var(--yellow) 40%, var(--neutral) 50%, var(--yellow) 60%, var(--green) 75%, var(--green) 90%, #3dffc8 100%);
  }
  .gauge-needle { position: absolute; top: -5px; width: 3px; height: 16px; background: #fff; border-radius: 2px; transform: translateX(-50%); transition: left 0.6s cubic-bezier(0.34,1.56,0.64,1); box-shadow: 0 0 8px rgba(255,255,255,0.6); }
  .gauge-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--muted); letter-spacing: 0.05em; }
  .divider { height: 1px; background: var(--border); margin: 18px 0; }

  /* History */
  .history-section { margin-top: 4px; max-height: 340px; overflow-y: auto; }
  .history-item {
    display: flex; align-items: center; padding: 8px 0;
    border-bottom: 1px solid var(--border); font-size: 13px; gap: 6px;
  }
  .history-item:last-child { border-bottom: none; }
  .h-date { color: var(--muted); width: 46px; flex-shrink: 0; font-size: 12px; }
  .h-pair { color: var(--text); width: 56px; flex-shrink: 0; font-weight: 700; }
  .h-index { font-weight: 700; width: 48px; flex-shrink: 0; text-align: right; }
  .h-badge-wrap { flex: 1; min-width: 0; }
  .h-del {
    background: none; border: none; color: var(--muted); cursor: pointer;
    font-size: 16px; padding: 2px 6px; border-radius: 2px; line-height: 1;
    transition: color 0.15s, background 0.15s; flex-shrink: 0;
  }
  .h-del:hover { color: var(--red); background: rgba(224,92,92,0.1); }
  .no-history { color: var(--muted); font-size: 14px; padding: 20px 0; text-align: center; }

  .btn-row { display: flex; gap: 8px; margin-top: 12px; }
  .btn-sm {
    background: none; border: 1px solid var(--border-bright); color: var(--muted);
    font-family: 'Space Mono', monospace; font-size: 12px; letter-spacing: 0.06em;
    padding: 5px 10px; border-radius: 2px; cursor: pointer;
    transition: color 0.2s, border-color 0.2s;
  }
  .btn-sm:hover { color: var(--text); border-color: var(--muted); }
  .btn-sm.accent-btn { border-color: var(--accent); color: var(--accent); }
  .btn-sm.accent-btn:hover { background: rgba(200,169,110,0.1); }

  /* Reference table */
  .ref-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 16px; }
  .ref-title { padding: 12px 18px; font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { padding: 10px 16px; text-align: left; font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); border-bottom: 1px solid var(--border); font-weight: 400; white-space: nowrap; }
  td { padding: 11px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  .zone-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 7px; vertical-align: middle; }
  .action-note { color: var(--muted); font-size: 12px; }

  /* â”€â”€ COT MATRIX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .matrix-container { display: none; }
  .matrix-container.show { display: block; }

  .matrix-header-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 16px; flex-wrap: wrap; gap: 10px;
  }
  .matrix-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 800; letter-spacing: 0.05em; }
  .matrix-week { font-size: 12px; color: var(--muted); letter-spacing: 0.08em; }

  .matrix-table-wrap { overflow-x: auto; margin-bottom: 16px; }
  .matrix-table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 700px; }
  .matrix-table th { padding: 11px 14px; text-align: left; font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); border-bottom: 2px solid var(--border-bright); font-weight: 400; white-space: nowrap; }
  .matrix-table td { padding: 12px 14px; border-bottom: 1px solid var(--border); vertical-align: middle; white-space: nowrap; }
  .matrix-table tr:last-child td { border-bottom: none; }
  .matrix-table tr:hover td { background: rgba(255,255,255,0.02); }
  .pair-tag { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; }
  .trend-up { color: var(--green); }
  .trend-dn { color: var(--red); }
  .trend-flat { color: var(--muted); }

  .cot-bar-wrap { display: flex; align-items: center; gap: 8px; }
  .cot-bar-track { width: 100%; height: 4px; background: var(--border-bright); border-radius: 2px; flex-shrink: 0; }
  .cot-bar-fill { height: 100%; border-radius: 2px; transition: width 0.4s; }
  .cot-val { font-weight: 700; min-width: 38px; text-align: right; font-size: 14px; }

  /* Ranking */
  .ranking-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 20px; margin-bottom: 16px; }
  .ranking-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 14px; }
  .ranking-list { display: flex; flex-direction: column; gap: 6px; }
  .ranking-item { display: flex; align-items: center; gap: 10px; }
  .rank-num { width: 24px; font-size: 12px; color: var(--muted); flex-shrink: 0; }
  .rank-pair { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; width: 48px; flex-shrink: 0; }
  .rank-bar-track { flex: 1; height: 4px; background: var(--border-bright); border-radius: 2px; }
  .rank-bar-fill { height: 100%; border-radius: 2px; }
  .rank-idx { font-size: 13px; font-weight: 700; width: 42px; text-align: right; flex-shrink: 0; }
  .rank-label { font-size: 11px; color: var(--muted); width: 85px; flex-shrink: 0; text-align: right; }

  /* Best pairs */
  .pairs-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 20px; margin-bottom: 16px; }
  .pairs-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 14px; }
  .pairs-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
  @media (max-width: 600px) { .pairs-grid { grid-template-columns: 1fr; } }
  .pairs-section-label { font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 8px; }
  .pair-chip { display: inline-block; padding: 3px 8px; border-radius: 2px; font-size: 13px; font-weight: 700; margin: 2px 2px; letter-spacing: 0.03em; }

  .progress-bar { height: 2px; background: var(--border); margin-bottom: 12px; border-radius: 1px; overflow: hidden; }
  .progress-fill { height: 100%; background: var(--accent); border-radius: 1px; transition: width 0.3s; }
  .progress-label { font-size: 12px; color: var(--muted); margin-bottom: 4px; }

  .footer-note { margin-top: 40px; font-size: 12px; color: var(--muted); letter-spacing: 0.05em; text-align: center; border-top: 1px solid var(--border); padding-top: 20px; line-height: 1.8; }

  /* Matrix input panel */
  .matrix-input-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 20px; margin-bottom: 16px; }
  .matrix-input-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 4px; }
  .matrix-input-sub { font-size: 12px; color: var(--muted); margin-bottom: 14px; }
  .matrix-row-inputs { display: grid; grid-template-columns: 105px 1fr 1fr 1fr 1fr 1fr auto; gap: 6px; align-items: end; margin-bottom: 6px; }
  @media (max-width: 700px) { .matrix-row-inputs { grid-template-columns: 1fr 1fr 1fr; } }
  .matrix-row-inputs label { font-size: 11px; }
  .matrix-row-inputs .field { gap: 3px; }
  .matrix-row-inputs input { font-size: 14px; padding: 7px 8px; }
  .btn-add-row {
    background: rgba(200,169,110,0.1); border: 1px solid var(--accent);
    color: var(--accent); font-family: 'Space Mono', monospace; font-size: 12px;
    letter-spacing: 0.08em; padding: 7px 12px; border-radius: 2px; cursor: pointer;
    white-space: nowrap; transition: background 0.2s; align-self: end;
  }
  .btn-add-row:hover { background: rgba(200,169,110,0.2); }
  .matrix-entries { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; }
  .matrix-entry-row {
    display: flex; align-items: center; gap: 6px; padding: 6px 10px;
    background: var(--bg); border: 1px solid var(--border); border-radius: 2px; font-size: 13px;
  }
  .entry-pair { font-weight: 700; width: 50px; flex-shrink: 0; }
  .entry-vals { flex: 1; color: var(--muted); font-size: 12px; }
  .entry-idx { font-weight: 700; }
  .entry-del { background: none; border: none; color: var(--muted); cursor: pointer; padding: 2px 5px; border-radius: 2px; font-size: 16px; transition: color 0.15s; }
  .entry-del:hover { color: var(--red); }
  .btn-gen-matrix {
    width: 100%; background: var(--accent); color: #0a0c0f;
    border: none; font-family: 'Syne', sans-serif; font-weight: 700;
    font-size: 14px; letter-spacing: 0.1em; text-transform: uppercase;
    padding: 12px; border-radius: 2px; cursor: pointer; transition: opacity 0.2s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .btn-gen-matrix:hover { opacity: 0.85; }
  /* â”€â”€ GITHUB CONFIG BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .gh-config-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 4px;
    padding: 20px; margin-bottom: 16px; transition: all 0.3s;
  }
  .gh-config-card.collapsed { padding: 10px 20px; }
  .gh-config-header {
    display: flex; align-items: center; justify-content: space-between;
    gap: 10px; flex-wrap: wrap;
  }
  .gh-config-title {
    font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700;
    letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted);
  }
  .gh-config-title .gh-icon { color: var(--accent); margin-right: 6px; }
  .gh-config-body { margin-top: 14px; }
  .gh-config-body.hidden { display: none; }
  .gh-config-row {
    display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px;
    align-items: end;
  }
  @media (max-width: 600px) { .gh-config-row { grid-template-columns: 1fr; } }
  .gh-config-row .field label { font-size: 12px; }
  .gh-config-row input { font-size: 14px; padding: 8px 10px; }
  .gh-status-row {
    display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
  }
  .gh-status-text {
    font-size: 12px; color: var(--muted); letter-spacing: 0.04em;
  }
  .gh-status-text .gh-repo-link {
    color: var(--accent); font-weight: 700; text-decoration: none;
  }
  .gh-status-text .gh-repo-link:hover { text-decoration: underline; }
  .btn-gh-save {
    background: var(--accent); color: #0a0c0f; border: none;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 12px;
    letter-spacing: 0.1em; text-transform: uppercase;
    padding: 8px 16px; border-radius: 2px; cursor: pointer;
    transition: opacity 0.2s; white-space: nowrap;
  }
  .btn-gh-save:hover { opacity: 0.85; }
  .btn-gh-edit {
    background: none; border: 1px solid var(--border-bright); color: var(--muted);
    font-family: 'Space Mono', monospace; font-size: 11px; letter-spacing: 0.06em;
    padding: 4px 10px; border-radius: 2px; cursor: pointer;
    transition: color 0.15s, border-color 0.15s; white-space: nowrap;
  }
  .btn-gh-edit:hover { color: var(--text); border-color: var(--muted); }

  /* â”€â”€ FETCH CFTC BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .gh-fetch-row {
    display: flex; align-items: center; gap: 10px; margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .btn-fetch-cftc {
    background: var(--green); color: #0a0c0f; border: none;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 13px;
    letter-spacing: 0.08em; text-transform: uppercase;
    padding: 10px 20px; border-radius: 2px; cursor: pointer;
    transition: opacity 0.2s, background 0.3s, transform 0.1s;
    display: inline-flex; align-items: center; gap: 8px;
    position: relative; overflow: hidden;
  }
  .btn-fetch-cftc:hover:not(:disabled) { opacity: 0.88; }
  .btn-fetch-cftc:active:not(:disabled) { transform: scale(0.98); }
  .btn-fetch-cftc:disabled { opacity: 0.35; cursor: not-allowed; }
  .btn-fetch-cftc.loading { background: var(--accent); pointer-events: none; }
  .btn-fetch-cftc.success {
    background: var(--green);
    animation: flash-green 0.6s ease;
  }
  .btn-fetch-cftc.error { background: var(--red); }
  @keyframes flash-green {
    0%   { box-shadow: 0 0 0 0 rgba(92,200,160,0.5); }
    50%  { box-shadow: 0 0 16px 4px rgba(92,200,160,0.3); }
    100% { box-shadow: none; }
  }
  .fetch-spinner {
    display: inline-block; width: 14px; height: 14px;
    border: 2px solid rgba(0,0,0,0.2); border-top-color: #0a0c0f;
    border-radius: 50%; animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .fetch-status {
    font-size: 12px; color: var(--muted); letter-spacing: 0.04em;
    line-height: 1.5;
  }
  .fetch-status.error { color: var(--red); }
  .fetch-status.warn { color: var(--yellow); }
  .fetch-cache-info {
    font-size: 11px; color: var(--muted); letter-spacing: 0.04em;
    padding: 4px 0; line-height: 1.6;
  }
  .fetch-cache-info .cache-label { color: var(--accent); font-weight: 700; }

  /* â”€â”€ DATA SOURCE BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .data-source-badge {
    font-size: 10px; letter-spacing: 0.08em; text-transform: uppercase;
    padding: 2px 8px; border-radius: 2px; font-weight: 700;
    white-space: nowrap;
  }
  .data-source-badge.auto {
    color: var(--green); background: rgba(92,200,160,0.1);
    border: 1px solid rgba(92,200,160,0.2);
  }
  .data-source-badge.manual {
    color: var(--muted); background: rgba(136,153,187,0.08);
    border: 1px solid rgba(136,153,187,0.15);
  }

  /* â”€â”€ EXPORT PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .export-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 16px; display: none; }
  .export-panel.show { display: block; }
  .export-panel-head { padding: 12px 18px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 8px; }
  .export-panel-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--accent); }
  .export-fmt-tabs { display: flex; gap: 4px; }
  .efmt-btn {
    font-family: 'Space Mono', monospace; font-size: 12px; letter-spacing: 0.06em;
    padding: 5px 12px; background: none; border: 1px solid var(--border-bright);
    color: var(--muted); cursor: pointer; border-radius: 2px; transition: all 0.15s;
  }
  .efmt-btn:hover { color: var(--text); border-color: var(--muted); }
  .efmt-btn.active { background: rgba(200,169,110,0.12); border-color: var(--accent); color: var(--accent); }
  .export-body { padding: 0; position: relative; }
  .export-textarea {
    width: 100%; min-height: 280px; max-height: 420px;
    background: #070910; color: #8fa8c0;
    font-family: 'Space Mono', monospace; font-size: 13px; line-height: 1.7;
    padding: 16px 20px; border: none; resize: vertical; outline: none;
    display: block;
  }
  .export-actions { display: flex; gap: 8px; padding: 12px 18px; border-top: 1px solid var(--border); background: var(--bg); flex-wrap: wrap; align-items: center; }
  .exp-filename { font-size: 12px; color: var(--muted); margin-left: auto; letter-spacing: 0.05em; }
  /* Toast */
  .exp-toast { position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%); background: var(--green); color: #0a0c0f; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; letter-spacing: 0.08em; padding: 10px 22px; border-radius: 2px; z-index: 999; pointer-events: none; opacity: 0; transition: opacity 0.2s; }
  .exp-toast.show { opacity: 1; }
  .exp-toast.error-toast { background: var(--red); }
  .exp-toast.warn-toast { background: var(--yellow); color: #0a0c0f; }

  /* â”€â”€ MOMENTUM / CHANGE % â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .momentum-tag {
    font-size: 10px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
    padding: 2px 6px; border-radius: 2px; white-space: nowrap;
  }
  .momentum-tag.accel { color: var(--green); background: rgba(92,200,160,0.1); }
  .momentum-tag.decel { color: var(--yellow); background: rgba(224,192,92,0.1); }
  .momentum-tag.stable { color: var(--muted); background: rgba(136,153,187,0.06); }
  .change-pct { font-size: 12px; font-weight: 700; }

  /* â”€â”€ OI CONFLUENCE BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .oi-badge {
    font-size: 9px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
    padding: 2px 6px; border-radius: 2px; white-space: nowrap;
  }
  .oi-badge.strong { color: #0a0c0f; background: var(--green); }
  .oi-badge.reversal { color: #0a0c0f; background: var(--yellow); }
  .oi-badge.weak { color: var(--muted); background: rgba(136,153,187,0.12); border: 1px solid var(--border); }

  /* â”€â”€ OI CONFLUENCE STAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .oi-star { font-size: 11px; margin-left: 3px; vertical-align: middle; }
  .oi-star.confirmed { color: var(--green); }
  .oi-star.weak { color: var(--muted); opacity: 0.5; }
  .oi-star.diverge { color: var(--yellow); }
  .pair-chip .oi-conf-label {
    font-size: 9px; opacity: 0.7; margin-left: 4px; letter-spacing: 0.06em;
  }
  .psgrid-oi-dot {
    display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-left: 3px; vertical-align: middle;
  }

  /* â”€â”€ 4-WEEK HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .history4w-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 16px; }
  .history4w-header {
    padding: 14px 18px; cursor: pointer; display: flex; align-items: center; gap: 8px;
    font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700;
    letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted);
    transition: color 0.15s; user-select: none;
  }
  .history4w-header:hover { color: var(--text); }
  .history4w-header .toggle-arrow { transition: transform 0.2s; }
  .history4w-header.open .toggle-arrow { transform: rotate(90deg); }
  .history4w-body { display: none; padding: 0 18px 16px; }
  .history4w-body.open { display: block; }
  .h4w-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
  .h4w-item {
    background: var(--bg); border: 1px solid var(--border); border-radius: 3px; padding: 12px;
  }
  .h4w-pair { font-weight: 700; font-size: 13px; margin-bottom: 8px; }
  .h4w-row { display: flex; align-items: center; gap: 6px; font-size: 12px; padding: 3px 0; }
  .h4w-label { color: var(--muted); width: 50px; flex-shrink: 0; font-size: 11px; }
  .h4w-val { font-weight: 700; width: 70px; flex-shrink: 0; text-align: right; }
  .h4w-bar { flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
  .h4w-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
  .h4w-avg { font-size: 11px; color: var(--muted); border-top: 1px dashed var(--border); margin-top: 6px; padding-top: 6px; }
  .h4w-avg-val { font-weight: 700; }
  .h4w-avg-diff { font-size: 10px; font-weight: 700; padding: 1px 4px; border-radius: 2px; }

  /* â”€â”€ SIGNALS / DIVERGENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .signals-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 18px; margin-bottom: 16px; }
  .signals-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--accent); margin-bottom: 14px; }
  .signal-item {
    display: flex; align-items: flex-start; gap: 10px; padding: 8px 0;
    border-bottom: 1px solid var(--border); font-size: 13px;
  }
  .signal-item:last-child { border-bottom: none; }
  .signal-icon { font-size: 16px; flex-shrink: 0; width: 24px; text-align: center; }
  .signal-type { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); padding: 2px 6px; border-radius: 2px; background: rgba(136,153,187,0.08); flex-shrink: 0; }
  .signal-detail { color: var(--text); line-height: 1.5; }
  .signal-pair { font-weight: 700; }
  .no-signals { color: var(--muted); font-size: 13px; font-style: italic; }
  .signals-manual { margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); }
  .signals-manual label { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--muted); cursor: pointer; margin-bottom: 8px; }
  .signals-manual input[type="checkbox"] { accent-color: var(--accent); width: 16px; height: 16px; }
  .signals-manual textarea {
    width: 100%; min-height: 40px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 2px; color: var(--text); font-family: 'Space Mono', monospace;
    font-size: 12px; padding: 8px 10px; resize: vertical; outline: none; margin-top: 6px;
  }
  .signals-manual textarea:focus { border-color: var(--accent); }

  /* â”€â”€ PAIR STRENGTH MATRIX 8Ã—8 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .psgrid-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 18px; margin-bottom: 16px; }
  .psgrid-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 14px; }
  .psgrid-wrap { overflow-x: auto; }
  .psgrid-table { border-collapse: collapse; }
  .psgrid-table th, .psgrid-table td { width: 48px; height: 38px; text-align: center; font-size: 11px; font-weight: 700; border: 1px solid var(--border); }
  .psgrid-table th { color: var(--muted); font-size: 10px; letter-spacing: 0.08em; background: var(--bg); position: sticky; }
  .psgrid-table th:first-child { left: 0; z-index: 2; }
  .psgrid-table thead th { top: 0; z-index: 1; }
  .psgrid-table td { cursor: default; transition: transform 0.1s; position: relative; }
  .psgrid-table td:hover { transform: scale(1.15); z-index: 5; box-shadow: 0 0 10px rgba(200,169,110,0.3); }
  .psgrid-table td.diag { background: var(--bg); cursor: default; }
  .psgrid-table td.diag:hover { transform: none; box-shadow: none; }
  .psgrid-legend { display: flex; gap: 14px; margin-top: 10px; font-size: 11px; color: var(--muted); flex-wrap: wrap; }
  .psgrid-legend-item { display: flex; align-items: center; gap: 4px; }
  .psgrid-legend-dot { width: 12px; height: 12px; border-radius: 2px; }

  /* â”€â”€ ACTION PLAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .actionplan-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 18px; margin-bottom: 16px; }
  .actionplan-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--accent); margin-bottom: 14px; }
  .ap-pairs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
  @media (max-width: 600px) { .ap-pairs-grid { grid-template-columns: 1fr; } }
  .ap-pair-row {
    background: var(--bg); border: 1px solid var(--border); border-radius: 3px; padding: 12px;
  }
  .ap-pair-label { font-weight: 700; font-size: 13px; margin-bottom: 8px; }
  .ap-pair-row select, .ap-pair-row input[type="text"] {
    width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 2px;
    color: var(--text); font-family: 'Space Mono', monospace; font-size: 12px;
    padding: 6px 8px; outline: none; margin-top: 4px;
  }
  .ap-pair-row select:focus, .ap-pair-row input[type="text"]:focus { border-color: var(--accent); }
  .ap-row-label { font-size: 11px; color: var(--muted); letter-spacing: 0.06em; margin-top: 8px; }
  .ap-notes-wrap { margin-top: 14px; }
  .ap-notes-wrap textarea {
    width: 100%; min-height: 60px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 2px; color: var(--text); font-family: 'Space Mono', monospace;
    font-size: 12px; padding: 10px 12px; resize: vertical; outline: none;
  }
  .ap-notes-wrap textarea:focus { border-color: var(--accent); }
  .ap-saved-hint { font-size: 11px; color: var(--green); margin-top: 6px; opacity: 0; transition: opacity 0.3s; }
  .ap-saved-hint.show { opacity: 1; }

  /* â”€â”€ IMPORT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .imp-overlay {
    position: fixed; inset: 0; z-index: 900;
    background: rgba(0,0,0,0.72); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .imp-overlay.show { opacity: 1; pointer-events: auto; }

  .imp-modal {
    background: var(--surface); border: 1px solid var(--border-bright);
    border-radius: 6px; width: 92%; max-width: 720px; max-height: 88vh;
    display: flex; flex-direction: column; overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }

  .imp-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px; border-bottom: 1px solid var(--border);
  }
  .imp-title {
    font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 800;
    letter-spacing: 0.08em; text-transform: uppercase; color: var(--accent);
  }
  .imp-close {
    background: none; border: none; color: var(--muted); font-size: 20px;
    cursor: pointer; padding: 4px 8px; border-radius: 2px; line-height: 1;
    transition: color 0.15s, background 0.15s;
  }
  .imp-close:hover { color: var(--text); background: rgba(255,255,255,0.05); }

  .imp-method-tabs {
    display: flex; gap: 0; border-bottom: 1px solid var(--border);
  }
  .imp-method-btn {
    flex: 1; font-family: 'Space Mono', monospace; font-size: 12px;
    letter-spacing: 0.06em; padding: 10px 10px 9px; background: none;
    border: none; border-bottom: 2px solid transparent;
    color: var(--muted); cursor: pointer; text-align: center;
    transition: color 0.15s, border-color 0.15s, background 0.15s;
    white-space: nowrap;
  }
  .imp-method-btn:hover:not(.active) { color: var(--text); background: rgba(255,255,255,0.02); }
  .imp-method-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

  .imp-body { padding: 16px 20px; overflow-y: auto; flex: 1; }

  .imp-panel { display: none; }
  .imp-panel.active { display: block; }

  .imp-label {
    font-size: 12px; color: var(--muted); letter-spacing: 0.08em;
    margin-bottom: 6px; display: block;
  }
  .imp-textarea {
    width: 100%; min-height: 140px; max-height: 220px;
    background: var(--bg); border: 1px solid var(--border-bright);
    color: var(--text); font-family: 'Space Mono', monospace;
    font-size: 13px; line-height: 1.6; padding: 12px 14px;
    border-radius: 2px; resize: vertical; outline: none;
    transition: border-color 0.2s;
  }
  .imp-textarea:focus { border-color: var(--accent); }
  .imp-textarea::placeholder { color: var(--muted); opacity: 0.6; }

  .imp-drop-zone {
    border: 2px dashed var(--border-bright); border-radius: 4px;
    padding: 32px 20px; text-align: center; cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
  }
  .imp-drop-zone:hover, .imp-drop-zone.drag-over {
    border-color: var(--accent); background: rgba(200,169,110,0.04);
  }
  .imp-drop-icon { font-size: 28px; margin-bottom: 8px; display: block; color: var(--muted); }
  .imp-drop-main { font-size: 14px; color: var(--text); margin-bottom: 4px; }
  .imp-drop-sub { font-size: 12px; color: var(--muted); letter-spacing: 0.04em; }
  .imp-file-input { display: none; }
  .imp-file-name {
    margin-top: 10px; font-size: 13px; color: var(--accent); font-weight: 700;
    display: none; text-align: center;
  }
  .imp-file-name.show { display: block; }

  .imp-hint {
    font-size: 12px; color: var(--muted); margin-top: 8px;
    line-height: 1.6; letter-spacing: 0.03em;
  }
  .imp-hint code {
    background: rgba(200,169,110,0.1); color: var(--accent);
    padding: 1px 5px; border-radius: 2px; font-size: 12px;
  }

  /* Preview */
  .imp-preview-wrap {
    margin-top: 14px; display: none;
  }
  .imp-preview-wrap.show { display: block; }

  .imp-preview-head {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 8px; flex-wrap: wrap; gap: 6px;
  }
  .imp-preview-title {
    font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700;
    letter-spacing: 0.12em; text-transform: uppercase; color: var(--text);
  }
  .imp-preview-count {
    font-size: 12px; color: var(--muted);
  }

  .imp-preview-table {
    width: 100%; border-collapse: collapse; font-size: 12px;
    background: var(--bg); border: 1px solid var(--border); border-radius: 2px;
  }
  .imp-preview-table th {
    padding: 7px 8px; text-align: left; font-size: 11px;
    letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--muted); border-bottom: 1px solid var(--border-bright);
    font-weight: 400; white-space: nowrap;
  }
  .imp-preview-table td {
    padding: 7px 8px; border-bottom: 1px solid var(--border);
    vertical-align: middle; white-space: nowrap;
  }
  .imp-preview-table tr:last-child td { border-bottom: none; }
  .imp-preview-table tr.imp-row-error td { background: rgba(224,92,92,0.06); }
  .imp-preview-table .imp-err-msg {
    color: var(--red); font-size: 11px; font-style: italic;
  }
  .imp-status {
    display: inline-block; padding: 2px 7px; border-radius: 2px;
    font-size: 11px; font-weight: 700; letter-spacing: 0.06em;
  }

  .imp-footer {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 20px; border-top: 1px solid var(--border);
    background: var(--bg); flex-wrap: wrap; gap: 8px;
  }
  .imp-footer-info { font-size: 12px; color: var(--muted); }
  .imp-footer-info .imp-ok { color: var(--green); font-weight: 700; }
  .imp-footer-info .imp-err { color: var(--red); font-weight: 700; }

  .btn-imp-load {
    background: var(--accent); color: #0a0c0f; border: none;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 13px;
    letter-spacing: 0.1em; text-transform: uppercase;
    padding: 9px 20px; border-radius: 2px; cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
  }
  .btn-imp-load:hover { opacity: 0.85; }
  .btn-imp-load:active { transform: scale(0.98); }
  .btn-imp-load:disabled { opacity: 0.35; cursor: not-allowed; }

  .btn-imp-import {
    background: rgba(200,169,110,0.1); border: 1px solid var(--accent);
    color: var(--accent); font-family: 'Space Mono', monospace; font-size: 12px;
    letter-spacing: 0.08em; padding: 7px 14px; border-radius: 2px; cursor: pointer;
    white-space: nowrap; transition: background 0.2s;
  }
  .btn-imp-import:hover { background: rgba(200,169,110,0.2); }
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="tag">â¬¡ ICT Trader Tools</div>
    <h1>COT <span>Index</span> Calculator</h1>
    <div class="subtitle">Commitment of Traders Â· 52-Week Normalized Positioning Â· Macro Bias Filter</div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('calc')">â¬¡ TÃ­nh COT Index</button>
    <button class="tab-btn" onclick="switchTab('matrix')">â¬¢ COT Matrix</button>
    <button class="tab-btn" onclick="switchTab('ref')">âŠ Báº£ng Tham Chiáº¿u</button>
  </div>

  <!-- â•â• TAB 1: CALCULATOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-panel active" id="tab-calc">
    <div class="grid">
      <!-- Input -->
      <div class="card">
        <div class="card-label">ThÃ´ng Sá»‘ Äáº§u VÃ o</div>
        <div class="input-group">
          <div class="field">
            <label>Cáº·p tiá»n / Äá»“ng tiá»n</label>
            <select id="pair">
              <option value="EUR">EUR â€“ Euro</option>
              <option value="GBP">GBP â€“ British Pound</option>
              <option value="USD">USD â€“ US Dollar Index</option>
              <option value="JPY">JPY â€“ Japanese Yen</option>
              <option value="AUD">AUD â€“ Australian Dollar</option>
              <option value="CAD">CAD â€“ Canadian Dollar</option>
              <option value="NZD">NZD â€“ New Zealand Dollar</option>
              <option value="CHF">CHF â€“ Swiss Franc</option>
              <option value="OTHER">Other</option>
            </select>
          </div>
          <div class="field">
            <label>Net Position Hiá»‡n Táº¡i</label>
            <input type="text" id="current" placeholder="VD: 45.000" autocomplete="off" />
            <div class="input-hint" id="hint-current">Dáº¥u cháº¥m = nghÃ¬n Â· Dáº¥u pháº©y = tháº­p phÃ¢n</div>
          </div>
          <div class="field">
            <label>Net Tuáº§n TrÆ°á»›c <span style="color:var(--muted);font-size:9px">(tuá»³ chá»n)</span></label>
            <input type="text" id="prev" placeholder="VD: 40.000" autocomplete="off" />
            <div class="input-hint" id="hint-prev">DÃ¹ng Ä‘á»ƒ tÃ­nh xu hÆ°á»›ng tuáº§n</div>
          </div>
          <div class="field">
            <label>Net Tháº¥p Nháº¥t (52 tuáº§n)</label>
            <input type="text" id="low52" placeholder="VD: -80.000" autocomplete="off" />
            <div class="input-hint" id="hint-low52">Cho phÃ©p sá»‘ Ã¢m: âˆ’80.000</div>
          </div>
          <div class="field">
            <label>Net Cao Nháº¥t (52 tuáº§n)</label>
            <input type="text" id="high52" placeholder="VD: 120.000" autocomplete="off" />
            <div class="input-hint" id="hint-high52">Pháº£i lá»›n hÆ¡n Net Tháº¥p Nháº¥t</div>
          </div>
          <button class="btn-calc" onclick="calculate()">â†— TÃ­nh COT Index</button>
        </div>
      </div>

      <!-- History -->
      <div class="card">
        <div class="card-label">Lá»‹ch Sá»­ TÃ­nh ToÃ¡n</div>
        <div class="history-section" id="historyList">
          <div class="no-history">ChÆ°a cÃ³ dá»¯ liá»‡u</div>
        </div>
        <div class="btn-row">
          <button class="btn-sm accent-btn" onclick="sendToMatrix()" title="ÄÆ°a lá»‹ch sá»­ vÃ o COT Matrix">â†— Gá»­i sang Matrix</button>
          <button class="btn-sm" onclick="clearHistory()" style="margin-left:auto">âœ• XoÃ¡ táº¥t cáº£</button>
        </div>
      </div>
    </div>

    <!-- Result -->
    <div class="result-card" id="resultCard">
      <div class="result-header">
        <div>
          <div class="result-pair" id="resPair">â€”</div>
          <div class="result-index" id="resIndex">â€”</div>
          <div class="bias-badge" id="resBadge">â€”</div>
        </div>
        <div style="text-align:right; max-width: 320px;">
          <div class="signal-text" id="resSignal">â€”</div>
          <div style="margin-top: 10px;" class="formula-line" id="resFormula"></div>
        </div>
      </div>
      <div class="gauge-wrap">
        <div class="gauge-track">
          <div class="gauge-needle" id="needle" style="left:0%"></div>
        </div>
        <div class="gauge-labels">
          <span>0 Bear</span><span>25</span><span>50 Neutral</span><span>75</span><span>100 Bull</span>
        </div>
      </div>
      <div class="divider"></div>
      <div class="formula-line" id="resCalc"></div>
    </div>
  </div>

  <!-- â•â• TAB 2: COT MATRIX â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-panel" id="tab-matrix">

    <!-- â•â•â• GITHUB CONFIG BANNER â•â•â• -->
    <div class="gh-config-card" id="ghConfigCard">
      <div class="gh-config-header">
        <span class="gh-config-title"><span class="gh-icon">â¬¡</span>GitHub Auto-Fetch CFTC</span>
        <span id="ghHeaderRight"></span>
      </div>
      <div class="gh-config-body" id="ghConfigBody">
        <div class="gh-config-row">
          <div class="field">
            <label>GitHub Username</label>
            <input type="text" id="ghUsername" placeholder="your-username" autocomplete="off" />
          </div>
          <div class="field">
            <label>TÃªn Repo</label>
            <input type="text" id="ghRepo" placeholder="cot-data" autocomplete="off" />
          </div>
          <button class="btn-gh-save" onclick="saveGhConfig()">LÆ°u</button>
        </div>
      </div>
    </div>

    <!-- â•â•â• FETCH CFTC BUTTON â•â•â• -->
    <div class="gh-fetch-row" id="ghFetchRow">
      <button class="btn-fetch-cftc" id="btnFetchCftc" onclick="fetchCftcFromGitHub()" disabled
        title="ChÆ°a cáº¥u hÃ¬nh GitHub â€” hÃ£y nháº­p Username vÃ  Repo á»Ÿ trÃªn">
        â¬¡ Láº¥y Dá»¯ Liá»‡u CFTC
      </button>
      <span class="fetch-status" id="fetchStatus"></span>
    </div>
    <div class="fetch-cache-info" id="fetchCacheInfo"></div>

    <!-- Input panel -->
    <div class="matrix-input-card">
      <div class="matrix-input-title">Nháº­p Dá»¯ Liá»‡u Matrix</div>
      <div class="matrix-input-sub">Nháº­p tá»«ng Ä‘á»“ng tiá»n Â· tá»‘i thiá»ƒu 2, tá»‘i Ä‘a 8 Â· Dá»¯ liá»‡u tá»« CFTC.gov má»—i thá»© SÃ¡u</div>

      <div class="matrix-row-inputs">
        <div class="field">
          <label>Äá»“ng tiá»n</label>
          <select id="m-pair">
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
            <option value="USD">USD</option>
            <option value="JPY">JPY</option>
            <option value="AUD">AUD</option>
            <option value="CAD">CAD</option>
            <option value="NZD">NZD</option>
            <option value="CHF">CHF</option>
          </select>
        </div>
        <div class="field">
          <label>Net hiá»‡n táº¡i</label>
          <input type="text" id="m-cur" placeholder="45.000" autocomplete="off" />
        </div>
        <div class="field">
          <label>Net tuáº§n trÆ°á»›c</label>
          <input type="text" id="m-prev" placeholder="40.000" autocomplete="off" />
        </div>
        <div class="field">
          <label>Net tháº¥p 52t</label>
          <input type="text" id="m-lo" placeholder="-80.000" autocomplete="off" />
        </div>
        <div class="field">
          <label>Net cao 52t</label>
          <input type="text" id="m-hi" placeholder="120.000" autocomplete="off" />
        </div>
        <div class="field">
          <label>Xu hÆ°á»›ng 4t <span style="color:var(--muted);font-size:9px">(tuá»³ chá»n)</span></label>
          <select id="m-trend4">
            <option value="">â€”</option>
            <option value="TÄƒng máº¡nh">TÄƒng máº¡nh</option>
            <option value="TÄƒng">TÄƒng</option>
            <option value="TÄƒng nháº¹">TÄƒng nháº¹</option>
            <option value="á»”n Ä‘á»‹nh">á»”n Ä‘á»‹nh</option>
            <option value="Giáº£m nháº¹">Giáº£m nháº¹</option>
            <option value="Giáº£m">Giáº£m</option>
            <option value="Giáº£m máº¡nh">Giáº£m máº¡nh</option>
          </select>
        </div>
        <button class="btn-add-row" onclick="addMatrixEntry()">+ ThÃªm</button>
      </div>

      <!-- Progress -->
      <div class="progress-label" id="progressLabel">0 / 8 Ä‘á»“ng tiá»n</div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>

      <!-- Entries list -->
      <div class="matrix-entries" id="matrixEntries"></div>

      <div style="display:flex;gap:8px;">
        <button class="btn-imp-import" onclick="openImportModal()" title="Import dá»¯ liá»‡u tá»« CSV, JSON, Markdown hoáº·c File">â¬† Import</button>
        <button class="btn-gen-matrix" id="btnGenMatrix" onclick="generateMatrix()" disabled style="flex:1">
          â¬¢ Táº¡o COT Matrix
        </button>
      </div>
    </div>

    <!-- â•â•â• IMPORT MODAL â•â•â• -->
    <div class="imp-overlay" id="impOverlay" onclick="if(event.target===this)closeImportModal()">
      <div class="imp-modal">
        <div class="imp-header">
          <span class="imp-title">â¬† Import Dá»¯ Liá»‡u</span>
          <button class="imp-close" onclick="closeImportModal()" title="ÄÃ³ng">Ã—</button>
        </div>

        <div class="imp-method-tabs">
          <button class="imp-method-btn active" onclick="switchImpMethod('csv')" id="impTab-csv">â‘  CSV / Paste</button>
          <button class="imp-method-btn" onclick="switchImpMethod('json')" id="impTab-json">â‘¡ JSON</button>
          <button class="imp-method-btn" onclick="switchImpMethod('md')" id="impTab-md">â‘¢ Markdown</button>
          <button class="imp-method-btn" onclick="switchImpMethod('file')" id="impTab-file">â‘£ Upload File</button>
        </div>

        <div class="imp-body">
          <!-- Panel 1: CSV / Paste -->
          <div class="imp-panel active" id="impPanel-csv">
            <label class="imp-label">Paste dá»¯ liá»‡u tá»« Excel, Google Sheets hoáº·c CSV</label>
            <textarea class="imp-textarea" id="impCsvText" placeholder="EUR	45000	40000	-80000	120000	TÄƒng máº¡nh
GBP	30000	25000	-50000	90000	Giáº£m
..."
              oninput="parseImportCSV()"></textarea>
            <div class="imp-hint">
              Thá»© tá»± cá»™t: <code>Pair</code> <code>Net Current</code> <code>Net Prev</code> <code>Net Low</code> <code>Net High</code> <code>Trend4W</code><br>
              Tá»± detect dáº¥u phÃ¢n cÃ¡ch: Tab â†¹, dáº¥u cháº¥m pháº©y (;), dáº¥u pháº©y (,)
            </div>
          </div>

          <!-- Panel 2: JSON -->
          <div class="imp-panel" id="impPanel-json">
            <label class="imp-label">Paste JSON array</label>
            <textarea class="imp-textarea" id="impJsonText" placeholder='[
  {"pair":"EUR","cur":45000,"prev":40000,"lo":-80000,"hi":120000,"t4":"TÄƒng máº¡nh"},
  {"pair":"GBP","current":30000,"prev":25000,"low52":-50000,"high52":90000}
]'
              oninput="parseImportJSON()"></textarea>
            <div class="imp-hint">
              Há»— trá»£ nhiá»u tÃªn field:<br>
              Net hiá»‡n táº¡i: <code>cur</code> <code>current</code> <code>net</code> <code>netCurrent</code><br>
              Net tháº¥p: <code>lo</code> <code>low</code> <code>low52</code> <code>netLow</code><br>
              Net cao: <code>hi</code> <code>high</code> <code>high52</code> <code>netHigh</code><br>
              Net trÆ°á»›c: <code>prev</code> <code>previous</code> <code>netPrev</code><br>
              Xu hÆ°á»›ng: <code>t4</code> <code>trend</code> <code>trend4w</code>
            </div>
          </div>

          <!-- Panel 3: Markdown -->
          <div class="imp-panel" id="impPanel-md">
            <label class="imp-label">Paste ná»™i dung Markdown Ä‘Ã£ xuáº¥t tá»« láº§n trÆ°á»›c</label>
            <textarea class="imp-textarea" id="impMdText" placeholder="# COT MATRIX â€” Tuáº§n 25/02/2026
...
| **EUR** | 45.000 | -80.000 | 120.000 | 40.000 | ... |
| **GBP** | 30.000 | -50.000 | 90.000  | 25.000 | ... |
..."
              oninput="parseImportMD()"></textarea>
            <div class="imp-hint">
              DÃ¡n toÃ n bá»™ file <code>.md</code> Ä‘Ã£ export. Tool sáº½ tá»± parse báº£ng COT Matrix.
            </div>
          </div>

          <!-- Panel 4: Upload File -->
          <div class="imp-panel" id="impPanel-file">
            <div class="imp-drop-zone" id="impDropZone"
              onclick="document.getElementById('impFileInput').click()"
              ondragover="event.preventDefault();this.classList.add('drag-over')"
              ondragleave="this.classList.remove('drag-over')"
              ondrop="event.preventDefault();this.classList.remove('drag-over');handleImportFile(event.dataTransfer.files[0])">
              <span class="imp-drop-icon">ğŸ“‚</span>
              <div class="imp-drop-main">KÃ©o tháº£ file hoáº·c báº¥m Ä‘á»ƒ chá»n</div>
              <div class="imp-drop-sub">.csv Â· .json Â· .md Â· .txt</div>
            </div>
            <input type="file" class="imp-file-input" id="impFileInput" accept=".csv,.json,.md,.txt,.tsv" onchange="handleImportFile(this.files[0])">
            <div class="imp-file-name" id="impFileName"></div>
          </div>

          <!-- Shared Preview -->
          <div class="imp-preview-wrap" id="impPreview">
            <div class="imp-preview-head">
              <span class="imp-preview-title">Preview</span>
              <span class="imp-preview-count" id="impPreviewCount"></span>
            </div>
            <div style="overflow-x:auto">
              <table class="imp-preview-table">
                <thead><tr>
                  <th>Pair</th><th>Net Current</th><th>Net Prev</th>
                  <th>Net Low</th><th>Net High</th><th>Trend 4W</th>
                  <th>COT Index</th><th>Zone</th><th>Status</th>
                </tr></thead>
                <tbody id="impPreviewBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="imp-footer">
          <div class="imp-footer-info" id="impFooterInfo">ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ preview</div>
          <button class="btn-imp-load" id="btnImpLoad" onclick="loadImportToMatrix()" disabled>âœ“ Náº¡p vÃ o Matrix</button>
        </div>
      </div>
    </div>

    <!-- Matrix output -->
    <div class="matrix-container" id="matrixOutput">
      <div class="ref-card">
        <div class="ref-title">
          <span id="matrixTitleText">COT MATRIX</span>
          <span style="display:flex;align-items:center;gap:8px">
            <span class="data-source-badge" id="dataSourceBadge" style="display:none"></span>
            <span id="matrixWeekText" style="font-size:9px;color:var(--muted)"></span>
          </span>
        </div>
        <div class="matrix-table-wrap">
          <table class="matrix-table" id="matrixTable">
            <thead>
              <tr>
                <th style="min-width:70px">Äá»“ng tiá»n</th>
                <th style="text-align:right">Net Position</th>
                <th style="text-align:right">Thay Ä‘á»•i</th>
                <th>Momentum</th>
                <th style="text-align:right">Open Interest</th>
                <th style="min-width:140px">COT Index</th>
              </tr>
            </thead>
            <tbody id="matrixBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Ranking -->
      <div class="ranking-card">
        <div class="ranking-title">âŠ• Ranking Sá»©c Máº¡nh Äá»“ng Tiá»n (Máº¡nh â†’ Yáº¿u)</div>
        <div class="ranking-list" id="rankingList"></div>
      </div>

      <!-- Best Pairs -->
      <div class="pairs-card">
        <div class="pairs-title">âŠ• Best Pairs Theo COT</div>
        <div class="pairs-grid" id="pairsGrid"></div>
      </div>

      <!-- 4-Week History (collapsible) -->
      <div class="history4w-card" id="history4wCard" style="display:none">
        <div class="history4w-header" id="history4wHeader" onclick="toggle4wHistory()">
          <span class="toggle-arrow">â–¸</span> Lá»‹ch Sá»­ 4 Tuáº§n &amp; So SÃ¡nh Trung BÃ¬nh
        </div>
        <div class="history4w-body" id="history4wBody"></div>
      </div>

      <!-- Pair Strength Matrix 8x8 -->
      <div class="psgrid-card" id="psgridCard" style="display:none">
        <div class="psgrid-title">â—« Ma Tráº­n Sá»©c Máº¡nh Cáº·p Tiá»n</div>
        <div class="psgrid-wrap" id="psgridWrap"></div>
        <div class="psgrid-legend">
          <div class="psgrid-legend-item"><div class="psgrid-legend-dot" style="background:var(--green)"></div> Long máº¡nh</div>
          <div class="psgrid-legend-item"><div class="psgrid-legend-dot" style="background:rgba(92,200,160,0.4)"></div> Long nháº¹</div>
          <div class="psgrid-legend-item"><div class="psgrid-legend-dot" style="background:var(--border)"></div> Trung tÃ­nh</div>
          <div class="psgrid-legend-item"><div class="psgrid-legend-dot" style="background:rgba(224,92,92,0.4)"></div> Short nháº¹</div>
          <div class="psgrid-legend-item"><div class="psgrid-legend-dot" style="background:var(--red)"></div> Short máº¡nh</div>
          <div class="psgrid-legend-item" style="margin-left:auto; opacity:0.8; font-family:var(--font-mono); font-size:10px; letter-spacing:0.02em;">
            <span class="psgrid-oi-dot" style="background:#fff; opacity:0.6; margin:0 6px 0 0;"></span> Cháº¥m mÃ u: DÃ²ng tiá»n (OI) xÃ¡c nháº­n
          </div>
        </div>
      </div>

      <!-- Signals / Divergence Checklist -->
      <div class="signals-card" id="signalsCard" style="display:none">
        <div class="signals-title">âš¡ TÃ­n Hiá»‡u Äáº·c Biá»‡t</div>
        <div id="signalsAutoList"></div>
        <div class="signals-manual">
          <label><input type="checkbox" id="sigDivergence"> PhÃ¡t hiá»‡n Divergence COT vs Price</label>
          <label><input type="checkbox" id="sigOther"> TÃ­n hiá»‡u khÃ¡c cáº§n lÆ°u Ã½</label>
          <textarea id="sigNotes" placeholder="Ghi chÃº tÃ­n hiá»‡u thá»§ cÃ´ng..."></textarea>
        </div>
      </div>

      <!-- Action Plan -->
      <div class="actionplan-card" id="actionplanCard" style="display:none">
        <div class="actionplan-title">ğŸ“‹ Káº¿ Hoáº¡ch Tuáº§n NÃ y</div>
        <div class="ap-pairs-grid" id="apPairsGrid"></div>
        <div class="ap-notes-wrap">
          <div class="ap-row-label">GHI CHÃš Tá»”NG</div>
          <textarea id="apNotes" placeholder="Ghi chÃº chiáº¿n lÆ°á»£c tuáº§n nÃ y..." oninput="saveActionPlan()"></textarea>
        </div>
        <div class="ap-saved-hint" id="apSavedHint">âœ“ ÄÃ£ lÆ°u tá»± Ä‘á»™ng</div>
      </div>

      <!-- Export Panel -->
      <div class="export-panel" id="exportPanel">
        <div class="export-panel-head">
          <span class="export-panel-title">â¬‡ Xuáº¥t Káº¿t Quáº£</span>
          <div class="export-fmt-tabs">
            <button class="efmt-btn active" id="efmt-md"   onclick="switchExportFmt('md')">Markdown</button>
            <button class="efmt-btn"        id="efmt-json" onclick="switchExportFmt('json')">JSON</button>
            <button class="efmt-btn"        id="efmt-csv"  onclick="switchExportFmt('csv')">CSV</button>
            <button class="efmt-btn"        id="efmt-txt"  onclick="switchExportFmt('txt')">Summary</button>
          </div>
        </div>
        <div class="export-body">
          <textarea class="export-textarea" id="exportTextarea" readonly spellcheck="false"></textarea>
        </div>
        <div class="export-actions">
          <button class="btn-sm accent-btn" onclick="copyExport()">â˜ Copy</button>
          <button class="btn-sm accent-btn" onclick="downloadExport()">â¬‡ Táº£i vá»</button>
          <span class="exp-filename" id="expFilename"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â• TAB 3: REFERENCE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-panel" id="tab-ref">
    <div class="ref-card">
      <div class="ref-title"><span>Báº£ng Tham Chiáº¿u COT Index</span></div>
      <table>
        <thead>
          <tr><th>COT Index</th><th>Ã NghÄ©a</th><th>ICT Bias</th><th>HÃ nh Äá»™ng</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="zone-dot" style="background:var(--red)"></span>0 â€“ 10</td>
            <td>Cá»±c ká»³ bearish</td><td><span style="color:var(--red)">EXTREME BEAR</span></td>
            <td class="action-note">âš  Cáº©n tháº­n reversal tÄƒng</td>
          </tr>
          <tr>
            <td><span class="zone-dot" style="background:#e07a5c"></span>10 â€“ 25</td>
            <td>Bearish máº¡nh</td><td><span style="color:#e07a5c">BEARISH</span></td>
            <td class="action-note">Short bias â€“ monitor</td>
          </tr>
          <tr>
            <td><span class="zone-dot" style="background:var(--yellow)"></span>25 â€“ 40</td>
            <td>Bearish vá»«a</td><td><span style="color:var(--yellow)">BEARISH MILD</span></td>
            <td class="action-note">Short bias bÃ¬nh thÆ°á»ng</td>
          </tr>
          <tr>
            <td><span class="zone-dot" style="background:var(--neutral)"></span>40 â€“ 60</td>
            <td>Neutral</td><td><span style="color:var(--neutral)">NEUTRAL</span></td>
            <td class="action-note">Cáº§n tÃ­n hiá»‡u ICT khÃ¡c</td>
          </tr>
          <tr>
            <td><span class="zone-dot" style="background:#8bc88a"></span>60 â€“ 75</td>
            <td>Bullish vá»«a</td><td><span style="color:#8bc88a">BULLISH MILD</span></td>
            <td class="action-note">Long bias bÃ¬nh thÆ°á»ng</td>
          </tr>
          <tr>
            <td><span class="zone-dot" style="background:var(--green)"></span>75 â€“ 90</td>
            <td>Bullish máº¡nh</td><td><span style="color:var(--green)">BULLISH</span></td>
            <td class="action-note">Long bias â€“ monitor</td>
          </tr>
          <tr>
            <td><span class="zone-dot" style="background:#3dffc8"></span>90 â€“ 100</td>
            <td>Cá»±c ká»³ bullish</td><td><span style="color:#3dffc8">EXTREME BULL</span></td>
            <td class="action-note">âš  Cáº©n tháº­n reversal giáº£m</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="exp-toast" id="expToast"></div>

  <div class="footer-note">
    COT Index = (Net Hiá»‡n Táº¡i âˆ’ Net Tháº¥p Nháº¥t 52T) Ã· (Net Cao Nháº¥t âˆ’ Net Tháº¥p Nháº¥t) Ã— 100<br>
    Nguá»“n dá»¯ liá»‡u: CFTC.gov Â· Cáº­p nháº­t má»—i thá»© SÃ¡u Â· DÃ¹ng káº¿t há»£p ICT HTF Narrative &amp; Daily Bias
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ZONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ZONES = [
  { max: 10,  label: 'EXTREME BEAR',  color: '#e05c5c', bg: 'rgba(224,92,92,0.12)',
    signal: 'Positioning cá»±c bearish â€“ Spec Ä‘ang short quÃ¡ má»©c. Cáº©n tháº­n Smart Money cÃ³ thá»ƒ Ä‘ang accumulate Ä‘á»ƒ push giÃ¡ tÄƒng (reversal risk).',
    ictAction: 'Chá»‰ short náº¿u cÃ³ HTF confirmation rÃµ rÃ ng + liquidity target phÃ­a dÆ°á»›i.' },
  { max: 25,  label: 'BEARISH',       color: '#e07a5c', bg: 'rgba(224,122,92,0.12)',
    signal: 'Bearish máº¡nh. Spec Ä‘ang náº¯m nhiá»u short. PhÃ¹ há»£p short bias nhÆ°ng cáº§n monitor dáº¥u hiá»‡u MSS bullish.',
    ictAction: 'Æ¯u tiÃªn sell setup táº¡i OB/FVG premium. TrÃ¡nh buy ngÆ°á»£c xu hÆ°á»›ng.' },
  { max: 40,  label: 'BEARISH MILD',  color: '#e0c05c', bg: 'rgba(224,192,92,0.1)',
    signal: 'Bearish vá»«a pháº£i. Short bias há»£p lá»‡. Theo dÃµi xem positioning cÃ³ tiáº¿p tá»¥c tÄƒng vá» phÃ­a bearish hay Ä‘ang turn.',
    ictAction: 'Sell setup tiÃªu chuáº©n. KhÃ´ng aggressive, cáº§n LTF confirmation Ä‘áº§y Ä‘á»§.' },
  { max: 60,  label: 'NEUTRAL',       color: '#8899bb', bg: 'rgba(136,153,187,0.1)',
    signal: 'Positioning trung tÃ­nh. KhÃ´ng cÃ³ bias rÃµ rÃ ng tá»« COT. Cáº§n confluence tá»« ICT structure, liquidity, vÃ  price action.',
    ictAction: 'NO TRADE tá»« COT. DÃ¹ng HTF narrative + liquidity map lÃ m cÆ¡ sá»Ÿ chÃ­nh.' },
  { max: 75,  label: 'BULLISH MILD',  color: '#8bc88a', bg: 'rgba(139,200,138,0.1)',
    signal: 'Bullish vá»«a pháº£i. Long bias há»£p lá»‡. Spec Ä‘ang náº¯m nhiá»u long hÆ¡n má»©c trung bÃ¬nh.',
    ictAction: 'Buy setup tiÃªu chuáº©n. Æ¯u tiÃªn discount zone + OB/FVG.' },
  { max: 90,  label: 'BULLISH',       color: '#5cc8a0', bg: 'rgba(92,200,160,0.12)',
    signal: 'Bullish máº¡nh. Spec Ä‘ang long náº·ng. Xu hÆ°á»›ng tÄƒng rÃµ rÃ ng nhÆ°ng theo dÃµi khi gáº§n extreme.',
    ictAction: 'Æ¯u tiÃªn buy setup táº¡i OB/FVG discount. Háº¡n cháº¿ sell ngÆ°á»£c xu hÆ°á»›ng.' },
  { max: 101, label: 'EXTREME BULL',  color: '#3dffc8', bg: 'rgba(61,255,200,0.1)',
    signal: 'Positioning cá»±c bullish â€“ Spec Ä‘ang long quÃ¡ má»©c. Cáº©n tháº­n Smart Money cÃ³ thá»ƒ Ä‘ang distribute (reversal risk).',
    ictAction: 'Chá»‰ long náº¿u cÃ³ HTF confirmation + liquidity target phÃ­a trÃªn. Cáº©n tháº­n.' },
];

function getZone(val) { return ZONES.find(z => val < z.max) || ZONES[ZONES.length-1]; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VN NUMBER FORMAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseVN(raw) {
  if (!raw && raw !== 0) return NaN;
  const str = String(raw).trim().replace(/\s/g, '');
  if (!str) return NaN;
  const negative = str.startsWith('-') || str.startsWith('âˆ’');
  const abs = str.replace(/^[-âˆ’]/, '');
  const dots = (abs.match(/\./g) || []).length;
  const commas = (abs.match(/,/g) || []).length;
  let numeric;
  if (dots === 0 && commas === 0) {
    numeric = parseFloat(abs);
  } else if (dots > 0 && commas === 0) {
    const lastDotIdx = abs.lastIndexOf('.');
    const afterDot = abs.slice(lastDotIdx + 1);
    if (dots === 1 && afterDot.length !== 3) numeric = parseFloat(abs);
    else numeric = parseFloat(abs.replace(/\./g, ''));
  } else if (dots === 0 && commas > 0) {
    if (commas === 1) numeric = parseFloat(abs.replace(',', '.'));
    else numeric = parseFloat(abs.replace(/,/g, ''));
  } else {
    const lastDot = abs.lastIndexOf('.');
    const lastComma = abs.lastIndexOf(',');
    if (lastComma > lastDot) numeric = parseFloat(abs.replace(/\./g, '').replace(',', '.'));
    else numeric = parseFloat(abs.replace(/,/g, ''));
  }
  if (isNaN(numeric)) return NaN;
  return negative ? -numeric : numeric;
}

function fmtVN(num) { return num.toLocaleString('vi-VN'); }
function fmtIdx(val) { return val.toFixed(1).replace('.', ','); }

// Live hint for an input
function setupHint(inputId, hintId, defaultHint) {
  const el = document.getElementById(inputId);
  const hint = document.getElementById(hintId);
  if (!el || !hint) return;
  el.addEventListener('input', () => {
    const v = parseVN(el.value);
    if (!el.value.trim()) {
      el.classList.remove('input-error'); hint.textContent = defaultHint; hint.className = 'input-hint';
    } else if (isNaN(v)) {
      el.classList.add('input-error'); hint.textContent = 'âœ• Äá»‹nh dáº¡ng khÃ´ng há»£p lá»‡'; hint.className = 'input-hint error';
    } else {
      el.classList.remove('input-error'); hint.textContent = 'âœ“ Äá»c Ä‘Æ°á»£c: ' + fmtVN(v); hint.className = 'input-hint ok';
    }
  });
}
setupHint('current', 'hint-current', 'Dáº¥u cháº¥m = nghÃ¬n Â· Dáº¥u pháº©y = tháº­p phÃ¢n');
setupHint('prev',    'hint-prev',    'DÃ¹ng Ä‘á»ƒ tÃ­nh xu hÆ°á»›ng tuáº§n');
setupHint('low52',   'hint-low52',   'Cho phÃ©p sá»‘ Ã¢m: âˆ’80.000');
setupHint('high52',  'hint-high52',  'Pháº£i lá»›n hÆ¡n Net Tháº¥p Nháº¥t');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(id) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  event.currentTarget.classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY â€” with per-row delete
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let history = [];
try { history = JSON.parse(localStorage.getItem('cot_history') || '[]'); } catch(e) { history = []; }

function saveHistory() { localStorage.setItem('cot_history', JSON.stringify(history)); }

function deleteHistoryRow(idx) {
  history.splice(idx, 1);
  saveHistory();
  renderHistory();
}

function renderHistory() {
  const el = document.getElementById('historyList');
  if (!history.length) {
    el.innerHTML = '<div class="no-history">ChÆ°a cÃ³ dá»¯ liá»‡u</div>';
    return;
  }
  el.innerHTML = history.map((h, i) => `
    <div class="history-item">
      <span class="h-date">${h.date}</span>
      <span class="h-pair">${h.pair}</span>
      <span class="h-index" style="color:${h.color}">${h.idx}</span>
      <span class="h-badge-wrap">
        <span style="color:${h.color};background:${h.color}18;border:1px solid ${h.color}33;padding:2px 7px;font-size:9px;letter-spacing:0.08em;border-radius:2px;font-weight:700">${h.label}</span>
      </span>
      <button class="h-del" onclick="deleteHistoryRow(${i})" title="XoÃ¡ dÃ²ng nÃ y">Ã—</button>
    </div>
  `).join('');
}

function clearHistory() {
  if (history.length && !confirm('XoÃ¡ toÃ n bá»™ lá»‹ch sá»­?')) return;
  history = [];
  saveHistory();
  renderHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CALCULATE (Tab 1)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calculate() {
  const pairVal  = document.getElementById('pair').value;
  const pairText = document.getElementById('pair').selectedOptions[0].text.split('â€“')[0].trim();
  const cur  = parseVN(document.getElementById('current').value);
  const prev = parseVN(document.getElementById('prev').value);
  const lo   = parseVN(document.getElementById('low52').value);
  const hi   = parseVN(document.getElementById('high52').value);

  if (isNaN(cur) || isNaN(lo) || isNaN(hi)) {
    alert('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§: Net hiá»‡n táº¡i, Net tháº¥p nháº¥t, Net cao nháº¥t.\nVÃ­ dá»¥: 45.000 hoáº·c -80.500');
    return;
  }
  if (hi <= lo) { alert('Net Cao Nháº¥t pháº£i lá»›n hÆ¡n Net Tháº¥p Nháº¥t.'); return; }

  const range = hi - lo;
  const raw = ((cur - lo) / range) * 100;
  const idx = Math.min(100, Math.max(0, raw));
  const z = getZone(idx);

  const card = document.getElementById('resultCard');
  card.className = 'result-card show';
  card.style.borderColor = z.color;
  card.style.background = z.bg;

  document.getElementById('resPair').textContent = pairText;
  const idxEl = document.getElementById('resIndex');
  idxEl.textContent = fmtIdx(idx);
  idxEl.style.color = z.color;

  const badge = document.getElementById('resBadge');
  badge.textContent = z.label;
  badge.style.background = z.bg;
  badge.style.color = z.color;
  badge.style.border = `1px solid ${z.color}44`;

  document.getElementById('resSignal').textContent = z.signal;
  document.getElementById('resFormula').innerHTML = `<span>â†³ ICT Action:</span> ${z.ictAction}`;

  let prevNote = '';
  if (!isNaN(prev)) {
    const delta = cur - prev;
    const sign = delta >= 0 ? '+' : '';
    prevNote = ` Â· Î” tuáº§n: <span style="color:${delta>=0?'var(--green)':'var(--red)'}">${sign}${fmtVN(Math.round(delta))}</span>`;
  }

  document.getElementById('resCalc').innerHTML =
    `Formula: (${fmtVN(cur)} âˆ’ ${fmtVN(lo)}) Ã· (${fmtVN(hi)} âˆ’ ${fmtVN(lo)}) Ã— 100 = <span style="color:${z.color};font-weight:700">${idx.toFixed(2).replace('.',',')}</span>${prevNote}`;

  setTimeout(() => { document.getElementById('needle').style.left = idx + '%'; }, 50);

  const entry = {
    pair: pairText, pairVal,
    idx: fmtIdx(idx), idxNum: idx,
    label: z.label, color: z.color,
    cur, prev: isNaN(prev) ? null : prev, lo, hi,
    date: new Date().toLocaleDateString('vi-VN', {day:'2-digit',month:'2-digit'})
  };
  history.unshift(entry);
  if (history.length > 16) history = history.slice(0, 16);
  saveHistory();
  renderHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MATRIX â€” entries management
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let matrixEntries = [];

function updateMatrixProgress() {
  const n = matrixEntries.length;
  document.getElementById('progressLabel').textContent = `${n} / 8 Ä‘á»“ng tiá»n`;
  document.getElementById('progressFill').style.width = (n / 8 * 100) + '%';
  document.getElementById('btnGenMatrix').disabled = n < 2;
}

function renderMatrixEntries() {
  const el = document.getElementById('matrixEntries');
  if (!matrixEntries.length) { el.innerHTML = ''; updateMatrixProgress(); return; }
  el.innerHTML = matrixEntries.map((e, i) => {
    const z = getZone(e.idxNum);
    return `<div class="matrix-entry-row">
      <span class="entry-pair" style="color:${z.color}">${e.pair}</span>
      <span class="entry-vals">Net: ${fmtVN(e.cur)} Â· Lo: ${fmtVN(e.lo)} Â· Hi: ${fmtVN(e.hi)}${e.prev!==null?' Â· Prev: '+fmtVN(e.prev):''}</span>
      <span class="entry-idx" style="color:${z.color}">${fmtIdx(e.idxNum)}</span>
      <button class="entry-del" onclick="deleteMatrixEntry(${i})" title="XoÃ¡">Ã—</button>
    </div>`;
  }).join('');
  updateMatrixProgress();
}

function deleteMatrixEntry(i) {
  matrixEntries.splice(i, 1);
  renderMatrixEntries();
}

function addMatrixEntry() {
  if (matrixEntries.length >= 8) { alert('Tá»‘i Ä‘a 8 Ä‘á»“ng tiá»n.'); return; }
  const pair  = document.getElementById('m-pair').value;
  const cur   = parseVN(document.getElementById('m-cur').value);
  const prev  = parseVN(document.getElementById('m-prev').value);
  const lo    = parseVN(document.getElementById('m-lo').value);
  const hi    = parseVN(document.getElementById('m-hi').value);
  const t4    = document.getElementById('m-trend4').value;

  if (isNaN(cur) || isNaN(lo) || isNaN(hi)) { alert('Vui lÃ²ng nháº­p Ä‘á»§ Net hiá»‡n táº¡i, Net tháº¥p, Net cao.'); return; }
  if (hi <= lo) { alert('Net Cao Nháº¥t pháº£i lá»›n hÆ¡n Net Tháº¥p Nháº¥t.'); return; }
  if (matrixEntries.find(e => e.pair === pair)) { alert(`${pair} Ä‘Ã£ Ä‘Æ°á»£c thÃªm rá»“i.`); return; }

  const range = hi - lo;
  const raw = ((cur - lo) / range) * 100;
  const idxNum = Math.min(100, Math.max(0, raw));

  matrixEntries.push({ pair, cur, prev: isNaN(prev) ? null : prev, lo, hi, t4, idxNum });
  renderMatrixEntries();

  // Clear inputs
  ['m-cur','m-prev','m-lo','m-hi'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('m-trend4').value = '';
}

// Send history to matrix
function sendToMatrix() {
  if (!history.length) { alert('Lá»‹ch sá»­ trá»‘ng.'); return; }
  // Use the most recent entry per pairVal
  const seen = new Set();
  history.forEach(h => {
    if (!seen.has(h.pairVal) && h.lo !== undefined && h.hi !== undefined) {
      seen.add(h.pairVal);
      if (matrixEntries.length < 8 && !matrixEntries.find(e => e.pair === h.pair)) {
        const range = h.hi - h.lo;
        const raw = ((h.cur - h.lo) / range) * 100;
        const idxNum = Math.min(100, Math.max(0, raw));
        matrixEntries.push({ pair: h.pair, cur: h.cur, prev: h.prev, lo: h.lo, hi: h.hi, t4: '', idxNum });
      }
    }
  });
  renderMatrixEntries();
  // Switch to matrix tab
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-matrix').classList.add('active');
  document.querySelectorAll('.tab-btn')[1].classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GENERATE MATRIX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SVG ICONS (Replacing Emojis)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SVG_ICONS = {
  starFull: '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
  starHalf: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
  signalWarning: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>',
  signalTrending: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>',
  signalFlame: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c-2.28 0-3-1.86-3-3 1.3 1.3 2.83 2.11 4.5 2.11 1.7-1.12 2.5-3.08 2.5-5.11a7.7 7.7 0 0 1-1.39 3.51A4 4 0 0 0 15 15.01a4 4 0 1 1-6.5-3.01Z"/><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-8.15c-.5 4.15-2 6.5-4 8.15s-3 3.5-3 5.5a7 7 0 0 0 7 7Z"/></svg>',
  signalShuffle: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>',
  signalExhaust: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12H2"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><line x1="6" y1="16" x2="6.01" y2="16"/><line x1="10" y1="16" x2="10.01" y2="16"/></svg>',
  signalFlip: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>'
};

function generateMatrix() {
  if (matrixEntries.length < 2) return;

  // Sort by COT Index descending for ranking
  const sorted = [...matrixEntries].sort((a, b) => b.idxNum - a.idxNum);

  // â”€â”€ #1: Fill table with new columns â”€â”€
  const tbody = document.getElementById('matrixBody');
  tbody.innerHTML = matrixEntries.map(e => {
    const z = getZone(e.idxNum);
    const delta = e.delta !== undefined ? e.delta : ((e.prev !== null && !isNaN(e.prev)) ? e.cur - e.prev : null);
    const deltaStr = delta !== null
      ? `<span style="color:${delta>=0?'var(--green)':'var(--red)'};font-weight:700">${delta>=0?'+':''}${fmtVN(Math.round(delta))}</span>`
      : '<span style="color:var(--muted)">â€”</span>';

    // Change %
    const changePct = (delta !== null && e.prev !== null && e.prev !== 0) ? (delta / Math.abs(e.prev) * 100) : null;
    const changePctStr = changePct !== null
      ? `<span class="change-pct" style="color:${changePct>=0?'var(--green)':'var(--red)'}">${changePct>=0?'+':''}${changePct.toFixed(1)}%</span>`
      : '<span style="color:var(--muted)">â€”</span>';

    // Momentum
    const prevDelta = e.prev_delta !== undefined ? e.prev_delta : null;
    let momentumStr = '<span style="color:var(--muted)">â€”</span>';
    if (delta !== null && prevDelta !== null) {
      const absCur = Math.abs(delta), absPrev = Math.abs(prevDelta);
      if (absCur > absPrev * 1.2) momentumStr = '<span class="momentum-tag accel">â–² TÄƒng tá»‘c</span>';
      else if (absCur < absPrev * 0.8) momentumStr = '<span class="momentum-tag decel">â–½ Giáº£m tá»‘c</span>';
      else momentumStr = '<span class="momentum-tag stable">â€” á»”n Ä‘á»‹nh</span>';
    }

    const trendClass = (e.t4||'').includes('TÄƒng') ? 'trend-up' : (e.t4||'').includes('Giáº£m') ? 'trend-dn' : 'trend-flat';

    // OI with confluence badge
    const oi = (e.oi !== undefined && e.oi !== null) ? e.oi : null;
    const oiDelta = (e.oi_delta !== undefined && e.oi_delta !== null) ? e.oi_delta : null;
    let oiStr = '<span style="color:var(--muted)">â€”</span>';
    if (oi !== null) {
      let oiDeltaStr = '';
      if (oiDelta !== null) {
        const oiDColor = oiDelta >= 0 ? 'var(--green)' : 'var(--red)';
        const oiDSign = oiDelta >= 0 ? '+' : '';
        oiDeltaStr = `<div style="color:${oiDColor};font-size:10px;margin-top:2px;font-family:'Space Mono',monospace">Î” ${oiDSign}${fmtVN(oiDelta)}</div>`;
      }
      let badge = '';
      if (oiDelta !== null && delta !== null) {
        const deltaAligned = (oiDelta > 0) && ((delta > 0 && e.cur > 0) || (delta < 0 && e.cur < 0));
        if (deltaAligned) badge = '<span class="oi-badge strong" style="margin-top:4px;display:inline-block">STRONG</span>';
        else if (oiDelta > 0) badge = '<span class="oi-badge reversal" style="margin-top:4px;display:inline-block">REVERSAL?</span>';
        else badge = '<span class="oi-badge weak" style="margin-top:4px;display:inline-block">WEAK</span>';
      }
      oiStr = `<div style="font-weight:700;font-family:'Space Mono',monospace">${fmtVN(oi)}</div>` + oiDeltaStr + badge;
    }

    return `<tr>
      <td><span class="pair-tag" style="color:${z.color}">${e.pair}</span></td>
      <td style="text-align:right">
        <div style="font-weight:700;font-size:14px;font-family:'Space Mono',monospace">${fmtVN(e.cur)}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px" title="Tuáº§n trÆ°á»›c">Prev: <span style="font-family:'Space Mono',monospace">${e.prev !== null ? fmtVN(e.prev) : 'â€”'}</span></div>
      </td>
      <td style="text-align:right">
        <div style="font-family:'Space Mono',monospace;font-size:13px">${deltaStr}</div>
        <div style="font-size:11px;margin-top:4px;font-family:'Space Mono',monospace">${changePctStr}</div>
      </td>
      <td>
        <div style="margin-bottom:6px">${momentumStr}</div>
        <div><span class="${trendClass}">${e.t4 || 'â€”'}</span></div>
      </td>
      <td style="text-align:right;font-size:12px;line-height:1.4">
        ${oiStr}
      </td>
      <td>
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:6px">
          <span style="color:${z.color};font-weight:700;font-size:10px;text-transform:uppercase">${z.label}</span>
          <span class="cot-val" style="color:${z.color};font-size:14px;font-family:'Space Mono',monospace">${fmtIdx(e.idxNum)}</span>
        </div>
        <div>
          <div class="cot-bar-track"><div class="cot-bar-fill" style="width:${e.idxNum}%;background:${z.color}"></div></div>
        </div>
      </td>
    </tr>`;
  }).join('');

  // â”€â”€ Ranking â”€â”€
  const rankEl = document.getElementById('rankingList');
  rankEl.innerHTML = sorted.map((e, i) => {
    const z = getZone(e.idxNum);
    const isStrongest = i === 0;
    const isWeakest = i === sorted.length - 1;
    const tag = isStrongest ? ' â† Strongest' : isWeakest ? ' â† Weakest' : '';
    return `<div class="ranking-item">
      <span class="rank-num">${i+1}.</span>
      <span class="rank-pair" style="color:${z.color}">${e.pair}</span>
      <div class="rank-bar-track"><div class="rank-bar-fill" style="width:${e.idxNum}%;background:${z.color}"></div></div>
      <span class="rank-idx" style="color:${z.color}">${fmtIdx(e.idxNum)}</span>
      <span class="rank-label" style="color:${z.color}">${z.label}${tag}</span>
    </div>`;
  }).join('');

  // â”€â”€ Best Pairs â”€â”€
  const bulls = sorted.filter(e => e.idxNum >= 60);
  const bears = sorted.filter(e => e.idxNum <= 40);
  const neutrals = sorted.filter(e => e.idxNum > 40 && e.idxNum < 60);

  // â”€â”€ OI Confluence helper â”€â”€
  function getOIConfluence(e) {
    if (e.oi == null || e.oi_delta == null) return { type: 'none', label: '', star: '' };
    const delta = e.delta !== undefined ? e.delta : ((e.prev !== null && !isNaN(e.prev)) ? e.cur - e.prev : 0);
    const aligned = (e.oi_delta > 0) && ((delta > 0 && e.cur > 0) || (delta < 0 && e.cur < 0));
    if (aligned) return { type: 'confirmed', label: 'OI âœ“', star: `<span class="oi-star confirmed" title="OI xÃ¡c nháº­n xu hÆ°á»›ng">${SVG_ICONS.starFull}</span>` };
    if (e.oi_delta > 0 && ((delta > 0 && e.cur < 0) || (delta < 0 && e.cur > 0))) return { type: 'diverge', label: 'OI âš ', star: `<span class="oi-star diverge" title="OI mÃ¢u thuáº«n â€” reversal?">${SVG_ICONS.starHalf}</span>` };
    return { type: 'weak', label: 'OI â†“', star: `<span class="oi-star weak" title="OI giáº£m â€” tÃ­n hiá»‡u yáº¿u">${SVG_ICONS.starHalf}</span>` };
  }

  const longPairs = [];
  bulls.forEach(b => {
    bears.slice().reverse().forEach(br => {
      let score = b.idxNum - br.idxNum;
      // OI Confluence bonus: +10 if both sides have OI confirmation
      const bConf = getOIConfluence(b);
      const brConf = getOIConfluence(br);
      let oiTag = '';
      if (bConf.type === 'confirmed' && (brConf.type === 'confirmed' || brConf.type === 'weak')) {
        score += 10; oiTag = SVG_ICONS.starFull;
      } else if (bConf.type === 'confirmed' || brConf.type === 'confirmed') {
        score += 5; oiTag = SVG_ICONS.starHalf;
      }
      longPairs.push({ pair: `${b.pair}/${br.pair}`, score, oiTag });
    });
  });
  longPairs.sort((a,b) => b.score - a.score);

  const shortPairs = longPairs.map(p => {
    const parts = p.pair.split('/');
    return { pair: `${parts[1]}/${parts[0]}`, score: p.score, oiTag: p.oiTag };
  });

  const avoidPairs = [];
  neutrals.forEach((a, i) => neutrals.slice(i+1).forEach(b => avoidPairs.push(`${a.pair}/${b.pair}`)));

  const pairsEl = document.getElementById('pairsGrid');
  pairsEl.innerHTML = `
    <div>
      <div class="pairs-section-label" style="color:var(--green)">â†‘ LONG (Máº¡nh/Yáº¿u)</div>
      ${longPairs.slice(0,5).map(p => `<span class="pair-chip" style="color:var(--green);background:rgba(92,200,160,0.1);border:1px solid rgba(92,200,160,0.2)">${p.pair}${p.oiTag ? '<span class="oi-conf-label">'+p.oiTag+'</span>':''}</span>`).join('') || '<span style="color:var(--muted);font-size:11px">â€”</span>'}
    </div>
    <div>
      <div class="pairs-section-label" style="color:var(--red)">â†“ SHORT (Yáº¿u/Máº¡nh)</div>
      ${shortPairs.slice(0,5).map(p => `<span class="pair-chip" style="color:var(--red);background:rgba(224,92,92,0.1);border:1px solid rgba(224,92,92,0.2)">${p.pair}${p.oiTag ? '<span class="oi-conf-label">'+p.oiTag+'</span>':''}</span>`).join('') || '<span style="color:var(--muted);font-size:11px">â€”</span>'}
    </div>
    <div>
      <div class="pairs-section-label" style="color:var(--muted)">âš  TRÃNH (Neutral vs Neutral)</div>
      ${avoidPairs.slice(0,4).map(p => `<span class="pair-chip" style="color:var(--muted);background:rgba(136,153,187,0.08);border:1px solid rgba(136,153,187,0.15)">${p}</span>`).join('') || '<span style="color:var(--muted);font-size:11px">â€”</span>'}
    </div>
  `;

  // â”€â”€ #3: 4-Week History â”€â”€
  render4wHistory(matrixEntries, sorted);

  // â”€â”€ #5: Pair Strength Matrix 8Ã—8 â”€â”€
  renderPairStrengthGrid(sorted);

  // â”€â”€ #4: Signals â”€â”€
  renderSignals(matrixEntries);

  // â”€â”€ #6: Action Plan â”€â”€
  renderActionPlan(longPairs, shortPairs);

  // Week label
  const now = new Date();
  const weekLabel = _matrixWeekOverride || ('Tuáº§n ' + now.toLocaleDateString('vi-VN', {day:'2-digit',month:'2-digit',year:'numeric'}));
  document.getElementById('matrixTitleText').textContent = 'COT MATRIX';
  document.getElementById('matrixWeekText').textContent = weekLabel;

  // Data source badge
  const badge = document.getElementById('dataSourceBadge');
  if (_matrixDataSource === 'auto') {
    badge.className = 'data-source-badge auto';
    badge.textContent = 'â¬¡ CFTC Auto Â· ' + weekLabel;
    badge.style.display = 'inline-block';
  } else {
    badge.className = 'data-source-badge manual';
    badge.textContent = 'Manual';
    badge.style.display = 'inline-block';
  }

  // Store for export
  _matrixData = { entries: matrixEntries, sorted, longPairs, shortPairs, avoidPairs, weekLabel };

  // Show export panel, default to Markdown
  switchExportFmt('md');
  document.getElementById('exportPanel').classList.add('show');

  document.getElementById('matrixOutput').className = 'matrix-container show';
  document.getElementById('matrixOutput').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  4-WEEK HISTORY SECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggle4wHistory() {
  const header = document.getElementById('history4wHeader');
  const body = document.getElementById('history4wBody');
  header.classList.toggle('open');
  body.classList.toggle('open');
}

function render4wHistory(entries, sorted) {
  const hasHistory = entries.some(e => e.history_4w && e.history_4w.length >= 2);
  const card = document.getElementById('history4wCard');
  if (!hasHistory) { card.style.display = 'none'; return; }
  card.style.display = '';

  const body = document.getElementById('history4wBody');
  body.innerHTML = '<div class="h4w-grid">' + sorted.map(e => {
    const z = getZone(e.idxNum);
    const hist = e.history_4w || [e.cur];
    const allVals = hist.concat(e.avg_13w || 0, e.avg_26w || 0);
    const minV = Math.min(...allVals), maxV = Math.max(...allVals);
    const range = maxV - minV || 1;
    const barPct = v => Math.max(2, ((v - minV) / range) * 100);
    const weekLabels = ['Hiá»‡n táº¡i', 'W-1', 'W-2', 'W-3'];

    let html = `<div class="h4w-item">
      <div class="h4w-pair" style="color:${z.color}">${e.pair} <span style="color:${z.color};font-size:10px;opacity:0.7">${z.label}</span></div>`;

    hist.forEach((v, i) => {
      const c = i === 0 ? z.color : 'var(--muted)';
      html += `<div class="h4w-row">
        <span class="h4w-label">${weekLabels[i] || 'W-'+i}</span>
        <span class="h4w-val" style="color:${c}">${fmtVN(v)}</span>
        <div class="h4w-bar"><div class="h4w-bar-fill" style="width:${barPct(v)}%;background:${c}"></div></div>
      </div>`;
    });

    // Averages
    if (e.avg_13w !== undefined && e.avg_13w !== null) {
      const diff13 = e.cur - e.avg_13w;
      const diffColor = Math.abs(diff13) > Math.abs(e.avg_13w * 0.15) ? (diff13 > 0 ? 'var(--green)' : 'var(--red)') : 'var(--muted)';
      html += `<div class="h4w-avg">TB 3 thÃ¡ng: <span class="h4w-avg-val">${fmtVN(e.avg_13w)}</span>
        <span class="h4w-avg-diff" style="color:${diffColor}">${diff13>=0?'+':''}${fmtVN(diff13)}</span></div>`;
    }
    if (e.avg_26w !== undefined && e.avg_26w !== null) {
      const diff26 = e.cur - e.avg_26w;
      const diffColor = Math.abs(diff26) > Math.abs(e.avg_26w * 0.15) ? (diff26 > 0 ? 'var(--green)' : 'var(--red)') : 'var(--muted)';
      html += `<div class="h4w-avg">TB 6 thÃ¡ng: <span class="h4w-avg-val">${fmtVN(e.avg_26w)}</span>
        <span class="h4w-avg-diff" style="color:${diffColor}">${diff26>=0?'+':''}${fmtVN(diff26)}</span></div>`;
    }

    html += '</div>';
    return html;
  }).join('') + '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PAIR STRENGTH MATRIX 8Ã—8
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPairStrengthGrid(sorted) {
  const card = document.getElementById('psgridCard');
  if (sorted.length < 3) { card.style.display = 'none'; return; }
  card.style.display = '';

  const n = sorted.length;
  let html = '<table class="psgrid-table"><thead><tr><th></th>';
  sorted.forEach(e => { html += `<th>${e.pair}</th>`; });
  html += '</tr></thead><tbody>';

  sorted.forEach((row, ri) => {
    html += `<tr><th>${row.pair}</th>`;
    sorted.forEach((col, ci) => {
      if (ri === ci) { html += '<td class="diag">â€”</td>'; return; }
      const spread = row.idxNum - col.idxNum;
      const abs = Math.abs(spread);
      let bg, fg;
      if (spread > 40) { bg = 'var(--green)'; fg = '#0a0c0f'; }
      else if (spread > 20) { bg = 'rgba(92,200,160,0.4)'; fg = 'var(--green)'; }
      else if (spread > -20) { bg = 'var(--border)'; fg = 'var(--muted)'; }
      else if (spread > -40) { bg = 'rgba(224,92,92,0.4)'; fg = 'var(--red)'; }
      else { bg = 'var(--red)'; fg = '#0a0c0f'; }
      // OI tooltip: show OI status for both currencies
      const rowOI = row.oi_delta != null ? (row.oi_delta >= 0 ? `OIâ†‘${fmtVN(row.oi_delta)}` : `OIâ†“${fmtVN(row.oi_delta)}`) : '';
      const colOI = col.oi_delta != null ? (col.oi_delta >= 0 ? `OIâ†‘${fmtVN(col.oi_delta)}` : `OIâ†“${fmtVN(col.oi_delta)}`) : '';
      const oiTip = (rowOI || colOI) ? `\n${row.pair}: ${rowOI || 'â€”'} | ${col.pair}: ${colOI || 'â€”'}` : '';
      // OI dot: show if both have confirming OI
      let oiDot = '';
      if (abs > 20 && row.oi_delta != null && col.oi_delta != null) {
        const rowConf = (spread > 0 && row.oi_delta > 0) || (spread < 0 && row.oi_delta < 0);
        const colConf = (spread > 0 && col.oi_delta < 0) || (spread < 0 && col.oi_delta > 0);
        if (rowConf || colConf) oiDot = `<span class="psgrid-oi-dot" style="background:${spread > 0 ? 'var(--green)' : 'var(--red)'}"></span>`;
      }
      html += `<td style="background:${bg};color:${fg}" title="${row.pair}/${col.pair}: ${spread>=0?'+':''}${spread.toFixed(0)}${oiTip}">${spread>=0?'+':''}${spread.toFixed(0)}${oiDot}</td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById('psgridWrap').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIGNALS / DIVERGENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSignals(entries) {
  const card = document.getElementById('signalsCard');
  card.style.display = '';

  const signals = [];

  entries.forEach(e => {
    const z = getZone(e.idxNum);

    // Flip detection
    if (e.prev !== null && e.prev !== undefined) {
      if ((e.prev > 0 && e.cur < 0) || (e.prev < 0 && e.cur > 0)) {
        const dir = e.cur > 0 ? 'Short â†’ Long' : 'Long â†’ Short';
        signals.push({ icon: SVG_ICONS.signalFlip, type: 'FLIP', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> â€” ${dir}. Net chuyá»ƒn tá»« ${fmtVN(e.prev)} sang ${fmtVN(e.cur)}`, priority: 3 });
      }
    }

    // Extreme detection
    if (e.idxNum < 10) {
      signals.push({ icon: SVG_ICONS.signalWarning, type: 'EXTREME BEAR', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> â€” COT Index ${fmtIdx(e.idxNum)}. Cáº©n tháº­n reversal tÄƒng.`, priority: 2 });
    } else if (e.idxNum > 90) {
      signals.push({ icon: SVG_ICONS.signalWarning, type: 'EXTREME BULL', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> â€” COT Index ${fmtIdx(e.idxNum)}. Cáº©n tháº­n reversal giáº£m.`, priority: 2 });
    }

    // Strong momentum detection
    const delta = e.delta !== undefined ? e.delta : ((e.prev !== null) ? e.cur - e.prev : null);
    const prevDelta = e.prev_delta !== undefined ? e.prev_delta : null;
    if (delta !== null && prevDelta !== null && Math.abs(delta) > Math.abs(prevDelta) * 1.8) {
      signals.push({ icon: SVG_ICONS.signalTrending, type: 'MOMENTUM', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> â€” TÄƒng tá»‘c máº¡nh. Î” tuáº§n: ${fmtVN(delta)} vs tuáº§n trÆ°á»›c: ${fmtVN(prevDelta)}`, priority: 1 });
    }

    // â”€â”€ OI Signals â”€â”€
    if (e.oi != null && e.oi_prev != null && e.oi_delta != null) {
      const oiChangePct = (e.oi_delta / e.oi_prev) * 100;
      // OI Surge: >10% change
      if (Math.abs(oiChangePct) > 10) {
        const dir = oiChangePct > 0 ? 'tÄƒng' : 'giáº£m';
        signals.push({ icon: SVG_ICONS.signalFlame, type: 'OI SURGE', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> â€” OI ${dir} <strong>${Math.abs(oiChangePct).toFixed(1)}%</strong> (${fmtVN(e.oi_delta)}). DÃ²ng tiá»n ${dir === 'tÄƒng' ? 'má»›i Ä‘á»• vÃ o' : 'rÃºt ra máº¡nh'}.`, priority: 2 });
      }
      // OI Divergence: Net tÄƒng nhÆ°ng OI giáº£m (hoáº·c ngÆ°á»£c láº¡i)
      if (delta !== null) {
        const netUp = delta > 0;
        const oiDown = e.oi_delta < 0;
        if (netUp && oiDown && Math.abs(oiChangePct) > 3) {
          signals.push({ icon: SVG_ICONS.signalShuffle, type: 'OI DIVERG', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> â€” Net Position tÄƒng nhÆ°ng OI giáº£m ${Math.abs(oiChangePct).toFixed(1)}%. TÃ­n hiá»‡u <strong>short-covering</strong>, khÃ´ng pháº£i dÃ²ng tiá»n má»›i.`, priority: 2 });
        } else if (!netUp && !oiDown && Math.abs(oiChangePct) > 3) {
          signals.push({ icon: SVG_ICONS.signalShuffle, type: 'OI DIVERG', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> â€” Net Position giáº£m nhÆ°ng OI tÄƒng ${Math.abs(oiChangePct).toFixed(1)}%. DÃ²ng tiá»n má»›i Ä‘ang <strong>short</strong>.`, priority: 2 });
        }
      }
      // OI Exhaustion: OI giáº£m khi á»Ÿ vÃ¹ng Extreme
      if ((e.idxNum > 90 || e.idxNum < 10) && e.oi_delta < 0 && Math.abs(oiChangePct) > 2) {
        signals.push({ icon: SVG_ICONS.signalExhaust, type: 'OI EXHAUST', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> â€” Äang á»Ÿ ${e.idxNum > 90 ? 'EXTREME BULL' : 'EXTREME BEAR'} nhÆ°ng OI giáº£m ${Math.abs(oiChangePct).toFixed(1)}%. Xu hÆ°á»›ng cÃ³ thá»ƒ <strong>cáº¡n kiá»‡t Ä‘á»™ng lá»±c</strong>.`, priority: 3 });
      }
    }
  });

  signals.sort((a, b) => b.priority - a.priority);

  const listEl = document.getElementById('signalsAutoList');
  if (signals.length === 0) {
    listEl.innerHTML = '<div class="no-signals">KhÃ´ng cÃ³ tÃ­n hiá»‡u Ä‘áº·c biá»‡t tuáº§n nÃ y. Thá»‹ trÆ°á»ng tÆ°Æ¡ng Ä‘á»‘i á»•n Ä‘á»‹nh.</div>';
  } else {
    listEl.innerHTML = signals.map(s => `
      <div class="signal-item">
        <span class="signal-icon">${s.icon}</span>
        <span class="signal-type">${s.type}</span>
        <span class="signal-detail">${s.detail}</span>
      </div>
    `).join('');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACTION PLAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _apSaveTimer = null;

function renderActionPlan(longPairs, shortPairs) {
  const card = document.getElementById('actionplanCard');
  card.style.display = '';

  const topLong = longPairs.slice(0, 2);
  const topShort = shortPairs.slice(0, 2);
  const pairs = [...topLong.map(p => ({ pair: p.pair, bias: 'Long' })), ...topShort.map(p => ({ pair: p.pair, bias: 'Short' }))];
  if (pairs.length === 0) pairs.push({ pair: 'EUR/USD', bias: 'Neutral' });

  // Load saved plan
  const weekLabel = _matrixWeekOverride || '';
  const saved = loadActionPlan(weekLabel);

  const grid = document.getElementById('apPairsGrid');
  grid.innerHTML = pairs.map((p, i) => {
    const savedPair = saved && saved.pairs && saved.pairs[i] ? saved.pairs[i] : {};
    return `<div class="ap-pair-row">
      <div class="ap-pair-label">${p.pair}</div>
      <div class="ap-row-label">BIAS</div>
      <select id="apBias${i}" onchange="saveActionPlan()">
        <option value="Long" ${(savedPair.bias || p.bias)==='Long'?'selected':''}>Long</option>
        <option value="Short" ${(savedPair.bias || p.bias)==='Short'?'selected':''}>Short</option>
        <option value="Neutral" ${(savedPair.bias || p.bias)==='Neutral'?'selected':''}>Neutral</option>
      </select>
      <div class="ap-row-label">CONFIDENCE</div>
      <select id="apConf${i}" onchange="saveActionPlan()">
        <option value="Cao" ${(savedPair.conf)==='Cao'?'selected':''}>Cao</option>
        <option value="TB" ${(!savedPair.conf || savedPair.conf==='TB')?'selected':''}>Trung bÃ¬nh</option>
        <option value="Tháº¥p" ${(savedPair.conf)==='Tháº¥p'?'selected':''}>Tháº¥p</option>
      </select>
      <div class="ap-row-label">VÃ™NG GIÃ CHá»œ</div>
      <input type="text" id="apZone${i}" placeholder="VÃ­ dá»¥: 1.0800 â€“ 1.0850" value="${savedPair.zone || ''}" oninput="saveActionPlan()">
    </div>`;
  }).join('');

  // Auto-set Confidence from OI confluence (only if no saved plan)
  if (!saved || !saved.pairs || saved.pairs.length === 0) {
    pairs.forEach((p, i) => {
      const pairParts = p.pair.split('/');
      const base = matrixEntries.find(e => e.pair === pairParts[0]);
      const quote = matrixEntries.find(e => e.pair === pairParts[1]);
      let autoConf = 'TB';
      if (base && quote) {
        const baseOI = base.oi_delta != null ? base.oi_delta : 0;
        const quoteOI = quote.oi_delta != null ? quote.oi_delta : 0;
        const baseAligned = (p.bias === 'Long' && baseOI > 0) || (p.bias === 'Short' && baseOI < 0);
        const quoteAligned = (p.bias === 'Long' && quoteOI < 0) || (p.bias === 'Short' && quoteOI > 0);
        if (baseAligned && quoteAligned) autoConf = 'Cao';
        else if (baseAligned || quoteAligned) autoConf = 'TB';
        else autoConf = 'Tháº¥p';
      }
      const confEl = document.getElementById('apConf' + i);
      if (confEl) confEl.value = autoConf;
    });
  }

  // Restore notes
  document.getElementById('apNotes').value = (saved && saved.notes) || '';

  // Store pair count for saving
  document.getElementById('actionplanCard').dataset.pairCount = pairs.length;
  document.getElementById('actionplanCard').dataset.pairs = JSON.stringify(pairs.map(p => p.pair));
}

function saveActionPlan() {
  clearTimeout(_apSaveTimer);
  _apSaveTimer = setTimeout(() => {
    const weekLabel = _matrixWeekOverride || '';
    const pairCount = parseInt(document.getElementById('actionplanCard').dataset.pairCount || '0');
    const pairNames = JSON.parse(document.getElementById('actionplanCard').dataset.pairs || '[]');
    const pairs = [];
    for (let i = 0; i < pairCount; i++) {
      pairs.push({
        pair: pairNames[i] || '',
        bias: (document.getElementById('apBias'+i) || {}).value || 'Neutral',
        conf: (document.getElementById('apConf'+i) || {}).value || 'TB',
        zone: (document.getElementById('apZone'+i) || {}).value || ''
      });
    }
    const plan = {
      pairs,
      notes: document.getElementById('apNotes').value,
      savedAt: new Date().toISOString()
    };
    localStorage.setItem('cot_actionplan_' + weekLabel, JSON.stringify(plan));
    const hint = document.getElementById('apSavedHint');
    hint.classList.add('show');
    setTimeout(() => hint.classList.remove('show'), 2000);
  }, 500);
}

function loadActionPlan(weekLabel) {
  try { return JSON.parse(localStorage.getItem('cot_actionplan_' + weekLabel) || 'null'); }
  catch(e) { return null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _matrixData = null;
let _matrixDataSource = 'manual'; // 'manual' | 'auto'
let _currentFmt = 'md';

function switchExportFmt(fmt) {
  _currentFmt = fmt;
  ['md','json','csv','txt'].forEach(f => {
    document.getElementById('efmt-' + f).classList.toggle('active', f === fmt);
  });
  if (!_matrixData) return;
  const content = buildExport(fmt);
  document.getElementById('exportTextarea').value = content;
  const ext = fmt === 'txt' ? 'txt' : fmt === 'json' ? 'json' : fmt === 'csv' ? 'csv' : 'md';
  const slug = (_matrixData.weekLabel || 'cot').replace(/\s/g,'-').replace(/\//g,'-');
  document.getElementById('expFilename').textContent = `COT-Matrix-${slug}.${ext}`;
}

function buildExport(fmt) {
  const { entries, sorted, longPairs, shortPairs, avoidPairs, weekLabel } = _matrixData;

  if (fmt === 'md') return buildMarkdown(entries, sorted, longPairs, shortPairs, avoidPairs, weekLabel);
  if (fmt === 'json') return buildJSON(entries, weekLabel);
  if (fmt === 'csv') return buildCSV(entries, weekLabel);
  if (fmt === 'txt') return buildSummary(sorted, longPairs, shortPairs, avoidPairs, weekLabel);
  return '';
}

// â”€â”€ Shared: build signals for export (plain text, no HTML) â”€â”€
function buildSignalsForExport(entries) {
  const signals = [];
  entries.forEach(e => {
    const z = getZone(e.idxNum);
    // Flip detection
    if (e.prev !== null && e.prev !== undefined) {
      if ((e.prev > 0 && e.cur < 0) || (e.prev < 0 && e.cur > 0)) {
        const dir = e.cur > 0 ? 'Short â†’ Long' : 'Long â†’ Short';
        signals.push({ icon: 'ğŸ”„', type: 'FLIP', plainDetail: `${e.pair} â€” ${dir}. Net chuyá»ƒn tá»« ${fmtVN(e.prev)} sang ${fmtVN(e.cur)}`, priority: 3 });
      }
    }
    // Extreme detection
    if (e.idxNum < 10) {
      signals.push({ icon: 'âš ï¸', type: 'EXTREME BEAR', plainDetail: `${e.pair} â€” COT Index ${fmtIdx(e.idxNum)}. Cáº©n tháº­n reversal tÄƒng.`, priority: 2 });
    } else if (e.idxNum > 90) {
      signals.push({ icon: 'âš ï¸', type: 'EXTREME BULL', plainDetail: `${e.pair} â€” COT Index ${fmtIdx(e.idxNum)}. Cáº©n tháº­n reversal giáº£m.`, priority: 2 });
    }
    // Strong momentum detection
    const delta = e.delta !== undefined ? e.delta : ((e.prev !== null) ? e.cur - e.prev : null);
    const prevDelta = e.prev_delta !== undefined ? e.prev_delta : null;
    if (delta !== null && prevDelta !== null && Math.abs(delta) > Math.abs(prevDelta) * 1.8) {
      signals.push({ icon: 'ğŸ“ˆ', type: 'MOMENTUM', plainDetail: `${e.pair} â€” TÄƒng tá»‘c máº¡nh. Î” tuáº§n: ${fmtVN(delta)} vs tuáº§n trÆ°á»›c: ${fmtVN(prevDelta)}`, priority: 1 });
    }
    // OI Signals for export
    if (e.oi != null && e.oi_prev != null && e.oi_delta != null) {
      const oiChangePct = (e.oi_delta / e.oi_prev) * 100;
      if (Math.abs(oiChangePct) > 10) {
        const dir = oiChangePct > 0 ? 'tÄƒng' : 'giáº£m';
        signals.push({ icon: 'ğŸ”¥', type: 'OI SURGE', plainDetail: `${e.pair} â€” OI ${dir} ${Math.abs(oiChangePct).toFixed(1)}% (${fmtVN(e.oi_delta)}). DÃ²ng tiá»n ${dir === 'tÄƒng' ? 'má»›i Ä‘á»• vÃ o' : 'rÃºt ra máº¡nh'}.`, priority: 2 });
      }
      if (delta !== null) {
        const netUp = delta > 0, oiDown = e.oi_delta < 0;
        if (netUp && oiDown && Math.abs(oiChangePct) > 3) {
          signals.push({ icon: 'ğŸ”€', type: 'OI DIVERG', plainDetail: `${e.pair} â€” Net tÄƒng nhÆ°ng OI giáº£m ${Math.abs(oiChangePct).toFixed(1)}%. Short-covering, khÃ´ng pháº£i dÃ²ng tiá»n má»›i.`, priority: 2 });
        } else if (!netUp && !oiDown && Math.abs(oiChangePct) > 3) {
          signals.push({ icon: 'ğŸ”€', type: 'OI DIVERG', plainDetail: `${e.pair} â€” Net giáº£m nhÆ°ng OI tÄƒng ${Math.abs(oiChangePct).toFixed(1)}%. DÃ²ng tiá»n má»›i Ä‘ang short.`, priority: 2 });
        }
      }
      if ((e.idxNum > 90 || e.idxNum < 10) && e.oi_delta < 0 && Math.abs(oiChangePct) > 2) {
        signals.push({ icon: 'ğŸ’¨', type: 'OI EXHAUST', plainDetail: `${e.pair} â€” ${e.idxNum > 90 ? 'EXTREME BULL' : 'EXTREME BEAR'} nhÆ°ng OI giáº£m ${Math.abs(oiChangePct).toFixed(1)}%. Xu hÆ°á»›ng cáº¡n kiá»‡t Ä‘á»™ng lá»±c.`, priority: 3 });
      }
    }
  });
  signals.sort((a, b) => b.priority - a.priority);
  return signals;
}

// â”€â”€ Markdown â”€â”€
function buildMarkdown(entries, sorted, longPairs, shortPairs, avoidPairs, weekLabel) {
  let md = `# COT MATRIX â€” ${weekLabel}\n`;
  md += `> Nguá»“n: CFTC.gov Â· PhÆ°Æ¡ng phÃ¡p: ICT Â· Generated: ${new Date().toLocaleString('vi-VN')}\n\n---\n\n`;

  md += `## COT Matrix\n\n`;
  md += `| Äá»“ng tiá»n | Net hiá»‡n táº¡i | Net tháº¥p 52T | Net cao 52T | Net tuáº§n trÆ°á»›c | Î” Tuáº§n | Change % | Momentum | Xu hÆ°á»›ng 4T | COT Index | ÄÃ¡nh giÃ¡ |\n`;
  md += `|-----------|-------------:|-------------:|------------:|---------------:|-------:|---------:|----------|-------------|----------:|---------|\n`;
  entries.forEach(e => {
    const z = getZone(e.idxNum);
    const delta = e.delta !== undefined ? e.delta : (e.prev !== null ? e.cur - e.prev : null);
    const dStr = delta !== null ? (delta >= 0 ? `+${fmtVN(Math.round(delta))}` : fmtVN(Math.round(delta))) : 'â€”';
    const changePct = (delta !== null && e.prev !== null && e.prev !== 0) ? (delta / Math.abs(e.prev) * 100).toFixed(1) + '%' : 'â€”';
    let momentum = 'â€”';
    if (e.prev_delta !== undefined && e.prev_delta !== null && delta !== null) {
      const absCur = Math.abs(delta), absPrev = Math.abs(e.prev_delta);
      if (absCur > absPrev * 1.2) momentum = 'â–² TÄƒng tá»‘c';
      else if (absCur < absPrev * 0.8) momentum = 'â–½ Giáº£m tá»‘c';
      else momentum = 'â€” á»”n Ä‘á»‹nh';
    }
    md += `| **${e.pair}** | ${fmtVN(e.cur)} | ${fmtVN(e.lo)} | ${fmtVN(e.hi)} | ${e.prev !== null ? fmtVN(e.prev) : 'â€”'} | ${dStr} | ${changePct} | ${momentum} | ${e.t4 || 'â€”'} | **${fmtIdx(e.idxNum)}** | ${z.label} |\n`;
  });

  md += `\n---\n\n## Ranking (Máº¡nh â†’ Yáº¿u)\n\n`;
  sorted.forEach((e, i) => {
    const z = getZone(e.idxNum);
    const bar = 'â–ˆ'.repeat(Math.round(e.idxNum / 10)) + 'â–‘'.repeat(10 - Math.round(e.idxNum / 10));
    const tag = i === 0 ? ' â† **Strongest**' : i === sorted.length - 1 ? ' â† **Weakest**' : '';
    md += `${i+1}. **${e.pair}** \`${bar}\` ${fmtIdx(e.idxNum)} â€” ${z.label}${tag}\n`;
  });

  // 4-Week History section
  const hasHistory = entries.some(e => e.history_4w && e.history_4w.length >= 2);
  if (hasHistory) {
    md += `\n---\n\n## Lá»‹ch Sá»­ 4 Tuáº§n\n\n`;
    md += `| Äá»“ng tiá»n | W-3 | W-2 | W-1 | Hiá»‡n táº¡i | TB 3 thÃ¡ng | Î” vs TB3 | TB 6 thÃ¡ng | Î” vs TB6 |\n`;
    md += `|-----------|----:|----:|----:|---------:|-----------:|---------:|-----------:|---------:|\n`;
    sorted.forEach(e => {
      const hist = e.history_4w || [e.cur];
      const w3 = hist[3] !== undefined ? fmtVN(hist[3]) : 'â€”';
      const w2 = hist[2] !== undefined ? fmtVN(hist[2]) : 'â€”';
      const w1 = hist[1] !== undefined ? fmtVN(hist[1]) : 'â€”';
      const w0 = fmtVN(hist[0]);
      const avg13 = e.avg_13w != null ? fmtVN(e.avg_13w) : 'â€”';
      const avg26 = e.avg_26w != null ? fmtVN(e.avg_26w) : 'â€”';
      const d13 = e.avg_13w != null ? ((e.cur - e.avg_13w) >= 0 ? '+' : '') + fmtVN(e.cur - e.avg_13w) : 'â€”';
      const d26 = e.avg_26w != null ? ((e.cur - e.avg_26w) >= 0 ? '+' : '') + fmtVN(e.cur - e.avg_26w) : 'â€”';
      md += `| **${e.pair}** | ${w3} | ${w2} | ${w1} | ${w0} | ${avg13} | ${d13} | ${avg26} | ${d26} |\n`;
    });
  }

  // OI section (if data available)
  const hasOI = entries.some(e => e.oi != null);
  if (hasOI) {
    md += `\n---\n\n## Open Interest\n\n`;
    md += `| Äá»“ng tiá»n | OI | Î” OI | Confluence |\n`;
    md += `|-----------|---:|-----:|------------|\n`;
    entries.forEach(e => {
      const oi = e.oi != null ? fmtVN(e.oi) : 'â€”';
      const oiD = e.oi_delta != null ? ((e.oi_delta >= 0 ? '+' : '') + fmtVN(e.oi_delta)) : 'â€”';
      let conf = 'â€”';
      if (e.oi != null && e.oi_delta != null) {
        const delta = e.delta !== undefined ? e.delta : (e.prev !== null ? e.cur - e.prev : 0);
        if (e.oi_delta > 0 && delta > 0) conf = 'ğŸŸ¢ STRONG';
        else if (e.oi_delta > 0 && delta < 0) conf = 'ğŸŸ¡ REVERSAL?';
        else if (e.oi_delta <= 0) conf = 'âšª WEAK';
      }
      md += `| **${e.pair}** | ${oi} | ${oiD} | ${conf} |\n`;
    });
  }

  md += `\n---\n\n## Best Pairs Theo COT\n\n`;
  md += `### â†‘ LONG\n`;
  if (longPairs.length) longPairs.slice(0,5).forEach(p => { md += `- \`${p.pair}\`\n`; });
  else md += `- â€”\n`;
  md += `\n### â†“ SHORT\n`;
  if (shortPairs.length) shortPairs.slice(0,5).forEach(p => { md += `- \`${p.pair}\`\n`; });
  else md += `- â€”\n`;
  md += `\n### âš  TrÃ¡nh\n`;
  if (avoidPairs.length) avoidPairs.slice(0,4).forEach(p => { md += `- \`${p}\`\n`; });
  else md += `- â€”\n`;

  // Signals section
  const signals = buildSignalsForExport(entries);
  md += `\n---\n\n## TÃ­n Hiá»‡u Äáº·c Biá»‡t\n\n`;
  if (signals.length === 0) {
    md += `KhÃ´ng cÃ³ tÃ­n hiá»‡u Ä‘áº·c biá»‡t tuáº§n nÃ y.\n`;
  } else {
    signals.forEach(s => { md += `- ${s.icon} **${s.type}**: ${s.plainDetail}\n`; });
  }

  // Action Plan section
  const savedPlan = loadActionPlan(weekLabel);
  if (savedPlan && savedPlan.pairs && savedPlan.pairs.length > 0) {
    md += `\n---\n\n## Káº¿ Hoáº¡ch Tuáº§n NÃ y\n\n`;
    savedPlan.pairs.forEach(p => {
      md += `- **${p.pair}** â€” Bias: ${p.bias || 'Neutral'}, Confidence: ${p.conf || 'TB'}${p.zone ? ', VÃ¹ng giÃ¡: ' + p.zone : ''}\n`;
    });
    if (savedPlan.notes) {
      md += `\n**Ghi chÃº:**\n${savedPlan.notes}\n`;
    }
  }

  md += `\n---\n\n## Báº£ng Tham Chiáº¿u\n\n`;
  md += `| COT Index | ÄÃ¡nh giÃ¡ | Bias |\n|-----------|----------|------|\n`;
  md += `| 0â€“10 | EXTREME BEAR | âš  Cáº©n tháº­n reversal tÄƒng |\n`;
  md += `| 10â€“25 | BEARISH | Short bias â€“ monitor |\n`;
  md += `| 25â€“40 | BEARISH MILD | Short bias bÃ¬nh thÆ°á»ng |\n`;
  md += `| 40â€“60 | NEUTRAL | Cáº§n tÃ­n hiá»‡u ICT khÃ¡c |\n`;
  md += `| 60â€“75 | BULLISH MILD | Long bias bÃ¬nh thÆ°á»ng |\n`;
  md += `| 75â€“90 | BULLISH | Long bias â€“ monitor |\n`;
  md += `| 90â€“100 | EXTREME BULL | âš  Cáº©n tháº­n reversal giáº£m |\n`;
  return md;
}

// â”€â”€ JSON â”€â”€
function buildJSON(entries, weekLabel) {
  const data = {
    meta: { weekLabel, generated: new Date().toISOString(), source: 'CFTC.gov', method: 'ICT COT Index Calculator' },
    entries: entries.map(e => ({
      pair: e.pair,
      cur: e.cur,
      prev: e.prev,
      lo: e.lo,
      hi: e.hi,
      t4: e.t4 || '',
      cotIndex: parseFloat(e.idxNum.toFixed(2)),
      label: getZone(e.idxNum).label,
      delta: e.delta, prev_delta: e.prev_delta,
      oi: e.oi, oi_delta: e.oi_delta,
      history_4w: e.history_4w,
      avg_13w: e.avg_13w, avg_26w: e.avg_26w
    }))
  };
  return JSON.stringify(data, null, 2);
}

// â”€â”€ CSV â”€â”€
function buildCSV(entries, weekLabel) {
  const header = ['Pair','Net Current','Net Prev','Net Low 52W','Net High 52W','Delta Week','Change%','Momentum','Trend 4W','OI','OI Delta','COT Index','Label'];
  const rows = entries.map(e => {
    const delta = e.delta !== undefined ? e.delta : (e.prev !== null ? e.cur - e.prev : '');
    const changePct = (delta !== '' && e.prev !== null && e.prev !== 0) ? (delta / Math.abs(e.prev) * 100).toFixed(1) : '';
    let momentum = '';
    if (e.prev_delta !== undefined && e.prev_delta !== null && delta !== '') {
      const absCur = Math.abs(delta), absPrev = Math.abs(e.prev_delta);
      if (absCur > absPrev * 1.2) momentum = 'TÄƒng tá»‘c';
      else if (absCur < absPrev * 0.8) momentum = 'Giáº£m tá»‘c';
      else momentum = 'á»”n Ä‘á»‹nh';
    }
    return [
      e.pair, e.cur, e.prev ?? '', e.lo, e.hi,
      delta !== '' ? Math.round(delta) : '',
      changePct,
      momentum,
      e.t4 || '',
      e.oi != null ? e.oi : '',
      e.oi_delta != null ? e.oi_delta : '',
      e.idxNum.toFixed(2),
      getZone(e.idxNum).label
    ].join(',');
  });
  return `# COT Matrix - ${weekLabel}\n` + header.join(',') + '\n' + rows.join('\n');
}

// â”€â”€ Text Summary â”€â”€
function buildSummary(sorted, longPairs, shortPairs, avoidPairs, weekLabel) {
  let t = `COT MATRIX â€” ${weekLabel}\n`;
  t += '='.repeat(48) + '\n\n';

  t += 'RANKING (Máº¡nh â†’ Yáº¿u):\n';
  sorted.forEach((e, i) => {
    const z = getZone(e.idxNum);
    const tag = i === 0 ? ' â† Strongest' : i === sorted.length - 1 ? ' â† Weakest' : '';
    const bar = 'â–ˆ'.repeat(Math.round(e.idxNum / 10)) + 'â–‘'.repeat(10 - Math.round(e.idxNum / 10));
    t += `  ${i+1}. ${e.pair.padEnd(4)} [${bar}] ${fmtIdx(e.idxNum).padStart(5)}  ${z.label}${tag}\n`;
  });

  t += '\nBEST PAIRS THEO COT:\n';
  t += '  â†‘ LONG:  ' + (longPairs.slice(0,5).map(p => p.pair).join('  ') || 'â€”') + '\n';
  t += '  â†“ SHORT: ' + (shortPairs.slice(0,5).map(p => p.pair).join('  ') || 'â€”') + '\n';
  t += '  âš  TRÃNH: ' + (avoidPairs.slice(0,4).join('  ') || 'â€”') + '\n';

  // OI Overview block
  const hasOI = sorted.some(e => e.oi != null);
  if (hasOI) {
    t += '\n' + '-'.repeat(48) + '\n';
    t += 'OPEN INTEREST:\n';
    sorted.forEach(e => {
      if (e.oi == null) return;
      const oiD = e.oi_delta != null ? (e.oi_delta >= 0 ? '+' : '') + fmtVN(e.oi_delta) : 'â€”';
      const delta = e.delta !== undefined ? e.delta : (e.prev !== null ? e.cur - e.prev : 0);
      let conf = 'â€”';
      if (e.oi_delta != null) {
        const aligned = (e.oi_delta > 0) && ((delta > 0 && e.cur > 0) || (delta < 0 && e.cur < 0));
        if (aligned) conf = 'ğŸŸ¢ STRONG';
        else if (e.oi_delta > 0) conf = 'ğŸŸ¡ REVERSAL?';
        else conf = 'âšª WEAK';
      }
      t += `  ${e.pair.padEnd(4)} OI: ${fmtVN(e.oi).padStart(10)}  Î”: ${oiD.padStart(8)}  ${conf}\n`;
    });
  }

  // Signals block
  const signals = buildSignalsForExport(sorted);
  t += '\n' + '-'.repeat(48) + '\n';
  t += 'TÃN HIá»†U Äáº¶C BIá»†T:\n';
  if (signals.length === 0) {
    t += '  KhÃ´ng cÃ³ tÃ­n hiá»‡u Ä‘áº·c biá»‡t tuáº§n nÃ y.\n';
  } else {
    signals.forEach(s => { t += `  ${s.icon} ${s.type}: ${s.plainDetail}\n`; });
  }

  // Action Plan block
  const savedPlan = loadActionPlan(weekLabel);
  if (savedPlan && savedPlan.pairs && savedPlan.pairs.length > 0) {
    t += '\n' + '-'.repeat(48) + '\n';
    t += 'Káº¾ HOáº CH TUáº¦N NÃ€Y:\n';
    savedPlan.pairs.forEach(p => {
      t += `  ${p.pair} â€” Bias: ${p.bias || 'Neutral'}, Confidence: ${p.conf || 'TB'}${p.zone ? ', VÃ¹ng giÃ¡: ' + p.zone : ''}\n`;
    });
    if (savedPlan.notes) {
      t += `  Ghi chÃº: ${savedPlan.notes}\n`;
    }
  }

  t += '\n' + '-'.repeat(48) + '\n';
  t += `Generated: ${new Date().toLocaleString('vi-VN')}\n`;
  t += 'Nguá»“n: CFTC.gov Â· ICT COT Index Calculator\n';
  return t;
}

// â”€â”€ Actions â”€â”€
function copyExport() {
  const txt = document.getElementById('exportTextarea').value;
  navigator.clipboard.writeText(txt).then(() => showToast('âœ“ ÄÃ£ copy!')).catch(() => {
    document.getElementById('exportTextarea').select();
    document.execCommand('copy');
    showToast('âœ“ ÄÃ£ copy!');
  });
}

function downloadExport() {
  const txt = document.getElementById('exportTextarea').value;
  const filename = document.getElementById('expFilename').textContent || 'cot-matrix.md';
  const mimeMap = { md: 'text/markdown', json: 'application/json', csv: 'text/csv', txt: 'text/plain' };
  const ext = filename.split('.').pop();
  const blob = new Blob([txt], { type: (mimeMap[ext] || 'text/plain') + ';charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
  showToast('â¬‡ Äang táº£i vá»...');
}

function showToast(msg, type) {
  const t = document.getElementById('expToast');
  t.textContent = msg;
  t.className = 'exp-toast show' + (type === 'error' ? ' error-toast' : type === 'warn' ? ' warn-toast' : '');
  setTimeout(() => { t.className = 'exp-toast'; }, 2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _importParsed = []; // array of { pair, cur, prev, lo, hi, t4, idxNum, error }

function openImportModal() {
  document.getElementById('impOverlay').classList.add('show');
  clearImportState();
}

function closeImportModal() {
  document.getElementById('impOverlay').classList.remove('show');
}

function switchImpMethod(method) {
  ['csv','json','md','file'].forEach(m => {
    document.getElementById('impTab-' + m).classList.toggle('active', m === method);
    document.getElementById('impPanel-' + m).classList.toggle('active', m === method);
  });
  clearImportState();
}

function clearImportState() {
  _importParsed = [];
  document.getElementById('impPreview').classList.remove('show');
  document.getElementById('impPreviewBody').innerHTML = '';
  document.getElementById('impPreviewCount').textContent = '';
  document.getElementById('impFooterInfo').textContent = 'ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ preview';
  document.getElementById('btnImpLoad').disabled = true;
}

// â”€â”€ Shared: render preview table â”€â”€
function renderImportPreview(rows) {
  _importParsed = rows;
  const tbody = document.getElementById('impPreviewBody');
  const wrap = document.getElementById('impPreview');

  if (!rows.length) {
    wrap.classList.remove('show');
    tbody.innerHTML = '';
    document.getElementById('impPreviewCount').textContent = '';
    document.getElementById('impFooterInfo').textContent = 'ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ preview';
    document.getElementById('btnImpLoad').disabled = true;
    return;
  }

  wrap.classList.add('show');

  const okCount = rows.filter(r => !r.error).length;
  const errCount = rows.filter(r => r.error).length;

  document.getElementById('impPreviewCount').textContent = `${rows.length} dÃ²ng`;

  tbody.innerHTML = rows.map(r => {
    if (r.error) {
      return `<tr class="imp-row-error">
        <td style="font-weight:700">${r.pair || 'â€”'}</td>
        <td>${r.cur !== undefined && !isNaN(r.cur) ? fmtVN(r.cur) : 'â€”'}</td>
        <td>${r.prev !== null && r.prev !== undefined && !isNaN(r.prev) ? fmtVN(r.prev) : 'â€”'}</td>
        <td>${r.lo !== undefined && !isNaN(r.lo) ? fmtVN(r.lo) : 'â€”'}</td>
        <td>${r.hi !== undefined && !isNaN(r.hi) ? fmtVN(r.hi) : 'â€”'}</td>
        <td style="color:var(--muted)">${r.t4 || 'â€”'}</td>
        <td>â€”</td><td>â€”</td>
        <td><span class="imp-err-msg">âš  ${r.error}</span></td>
      </tr>`;
    }
    const z = getZone(r.idxNum);
    return `<tr>
      <td style="font-weight:700;color:${z.color}">${r.pair}</td>
      <td>${fmtVN(r.cur)}</td>
      <td>${r.prev !== null ? fmtVN(r.prev) : '<span style="color:var(--muted)">â€”</span>'}</td>
      <td>${fmtVN(r.lo)}</td>
      <td>${fmtVN(r.hi)}</td>
      <td style="color:var(--muted)">${r.t4 || 'â€”'}</td>
      <td><span style="color:${z.color};font-weight:700">${fmtIdx(r.idxNum)}</span></td>
      <td><span class="imp-status" style="color:${z.color};background:${z.bg}">${z.label}</span></td>
      <td style="color:var(--green)">âœ“</td>
    </tr>`;
  }).join('');

  let info = '';
  if (okCount) info += `<span class="imp-ok">${okCount} há»£p lá»‡</span>`;
  if (okCount && errCount) info += ' Â· ';
  if (errCount) info += `<span class="imp-err">${errCount} lá»—i</span>`;
  document.getElementById('impFooterInfo').innerHTML = info;
  document.getElementById('btnImpLoad').disabled = okCount === 0;
}

// â”€â”€ Shared: compute row with validation â”€â”€
function computeImportRow(pair, curRaw, prevRaw, loRaw, hiRaw, t4) {
  const p = (pair || '').trim().toUpperCase().replace(/[^A-Z]/g, '');
  const cur = typeof curRaw === 'number' ? curRaw : parseVN(curRaw);
  const prev = (prevRaw === null || prevRaw === undefined || prevRaw === '')
    ? null : (typeof prevRaw === 'number' ? prevRaw : parseVN(prevRaw));
  const lo = typeof loRaw === 'number' ? loRaw : parseVN(loRaw);
  const hi = typeof hiRaw === 'number' ? hiRaw : parseVN(hiRaw);

  const base = { pair: p || pair, cur, prev: (prev !== null && !isNaN(prev)) ? prev : null, lo, hi, t4: t4 || '' };

  if (!p) return { ...base, error: 'Thiáº¿u Pair' };
  if (isNaN(cur)) return { ...base, error: 'Net Current khÃ´ng há»£p lá»‡' };
  if (isNaN(lo)) return { ...base, error: 'Net Low khÃ´ng há»£p lá»‡' };
  if (isNaN(hi)) return { ...base, error: 'Net High khÃ´ng há»£p lá»‡' };
  if (hi <= lo) return { ...base, error: 'High pháº£i lá»›n hÆ¡n Low' };

  const range = hi - lo;
  const raw = ((cur - lo) / range) * 100;
  const idxNum = Math.min(100, Math.max(0, raw));
  return { ...base, idxNum, error: null };
}

// â”€â”€ â‘  CSV / Paste parser â”€â”€
function parseImportCSV() {
  const text = document.getElementById('impCsvText').value.trim();
  if (!text) { clearImportState(); return; }

  const lines = text.split(/\r?\n/).filter(l => l.trim());
  // Auto-detect separator
  const firstLine = lines[0];
  let sep = '\t';
  if (firstLine.includes('\t')) sep = '\t';
  else if (firstLine.includes(';')) sep = ';';
  else if (firstLine.includes(',')) sep = ',';

  // Skip header if detected
  const headerPatterns = /^(pair|Ä‘á»“ng|currency|symbol)/i;
  let dataLines = lines;
  if (headerPatterns.test(lines[0].split(sep)[0].trim())) {
    dataLines = lines.slice(1);
  }

  const rows = dataLines.map(line => {
    const cols = line.split(sep).map(c => c.trim());
    if (cols.length < 4) return computeImportRow(cols[0], cols[1], null, cols[2], cols[3], cols[4]);
    // Pair | Net Current | Net Prev | Net Low | Net High | Trend4W
    return computeImportRow(cols[0], cols[1], cols[2], cols[3], cols[4], cols[5]);
  });

  renderImportPreview(rows);
}

// â”€â”€ â‘¡ JSON parser â”€â”€
function parseImportJSON() {
  const text = document.getElementById('impJsonText').value.trim();
  if (!text) { clearImportState(); return; }

  let arr;
  try {
    const parsed = JSON.parse(text);
    // Support { entries: [...] } or [...]
    if (Array.isArray(parsed)) arr = parsed;
    else if (parsed && Array.isArray(parsed.entries)) arr = parsed.entries;
    else { renderImportPreview([{ pair: 'â€”', error: 'JSON pháº£i lÃ  array hoáº·c cÃ³ field "entries"' }]); return; }
  } catch (e) {
    renderImportPreview([{ pair: 'â€”', error: 'JSON khÃ´ng há»£p lá»‡: ' + e.message.slice(0, 60) }]);
    return;
  }

  const rows = arr.map(obj => {
    const pick = (...keys) => {
      for (const k of keys) {
        if (obj[k] !== undefined && obj[k] !== null) return obj[k];
        // Also check case-insensitive
        const lower = k.toLowerCase();
        for (const ok of Object.keys(obj)) {
          if (ok.toLowerCase() === lower) return obj[ok];
        }
      }
      return undefined;
    };

    const pair = pick('pair', 'currency', 'symbol', 'name') || '';
    const cur = pick('cur', 'current', 'net', 'netCurrent', 'net_current', 'Net Current');
    const prev = pick('prev', 'previous', 'netPrev', 'net_prev', 'Net Prev', 'Net Previous');
    const lo = pick('lo', 'low', 'low52', 'netLow', 'net_low', 'Net Low', 'Net Low 52W');
    const hi = pick('hi', 'high', 'high52', 'netHigh', 'net_high', 'Net High', 'Net High 52W');
    const t4 = pick('t4', 'trend', 'trend4w', 'trend_4w', 'Trend 4W') || '';

    return computeImportRow(pair, cur, prev, lo, hi, String(t4));
  });

  renderImportPreview(rows);
}

// â”€â”€ â‘¢ Markdown parser â”€â”€
function parseImportMD() {
  const text = document.getElementById('impMdText').value.trim();
  if (!text) { clearImportState(); return; }

  // Find the COT Matrix table (look for table rows with | Pair | data)
  const lines = text.split(/\r?\n/);
  const tableRows = [];
  let inTable = false;

  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed.startsWith('|')) { if (inTable) break; continue; }

    // Skip separator rows like |---|---|
    if (/^\|[\s\-:|]+\|$/.test(trimmed)) { inTable = true; continue; }

    // Skip header rows
    if (/Ä‘á»“ng tiá»n|pair|currency/i.test(trimmed) && /net|index/i.test(trimmed)) {
      inTable = true;
      continue;
    }

    if (!inTable) {
      // Could be the first data row without header detection
      const cells = trimmed.split('|').map(c => c.trim()).filter(c => c);
      if (cells.length >= 5) {
        // Check if first cell looks like a pair (3 letters, maybe bold)
        const pairTest = cells[0].replace(/\*\*/g, '').trim();
        if (/^[A-Z]{2,5}$/i.test(pairTest)) {
          inTable = true;
        }
      }
    }

    if (inTable) {
      const cells = trimmed.split('|').map(c => c.trim()).filter(c => c);
      if (cells.length >= 5) tableRows.push(cells);
    }
  }

  if (!tableRows.length) {
    renderImportPreview([{ pair: 'â€”', error: 'KhÃ´ng tÃ¬m tháº¥y báº£ng COT Matrix trong Markdown' }]);
    return;
  }

  // Parse table rows
  // Expected columns: Äá»“ng tiá»n | Net hiá»‡n táº¡i | Net tháº¥p 52T | Net cao 52T | Net tuáº§n trÆ°á»›c | Î” Tuáº§n | Xu hÆ°á»›ng 4T | COT Index | ÄÃ¡nh giÃ¡
  const rows = tableRows.map(cells => {
    const pair = cells[0].replace(/\*\*/g, '').trim();
    const cur = cells[1];
    // Columns 2,3 = lo, hi (matching export format)
    const lo = cells[2];
    const hi = cells[3];
    const prev = cells.length > 4 ? cells[4] : null;
    // Trend is usually column 6
    const t4 = cells.length > 6 ? cells[6] : '';

    return computeImportRow(pair, cur, prev === 'â€”' ? null : prev, lo, hi, t4 === 'â€”' ? '' : t4);
  });

  renderImportPreview(rows);
}

// â”€â”€ â‘£ File upload handler â”€â”€
function handleImportFile(file) {
  if (!file) return;

  const name = file.name.toLowerCase();
  const nameEl = document.getElementById('impFileName');
  nameEl.textContent = `ğŸ“ ${file.name}`;
  nameEl.classList.add('show');

  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result;

    // Auto-detect format from extension
    if (name.endsWith('.json')) {
      document.getElementById('impJsonText').value = content;
      switchImpMethod('json');
      parseImportJSON();
    } else if (name.endsWith('.md')) {
      document.getElementById('impMdText').value = content;
      switchImpMethod('md');
      parseImportMD();
    } else {
      // .csv, .tsv, .txt â†’ treat as CSV
      document.getElementById('impCsvText').value = content;
      switchImpMethod('csv');
      parseImportCSV();
    }
  };
  reader.readAsText(file);
}

// â”€â”€ Load parsed data into matrix â”€â”€
function loadImportToMatrix() {
  const valid = _importParsed.filter(r => !r.error);
  if (!valid.length) return;

  // Replace matrix entries with imported data
  matrixEntries = valid.map(r => ({
    pair: r.pair,
    cur: r.cur,
    prev: r.prev,
    lo: r.lo,
    hi: r.hi,
    t4: r.t4,
    idxNum: r.idxNum
  }));

  // Limit to 8
  if (matrixEntries.length > 8) matrixEntries = matrixEntries.slice(0, 8);

  renderMatrixEntries();
  closeImportModal();
  showToast(`âœ“ ÄÃ£ náº¡p ${matrixEntries.length} Ä‘á»“ng tiá»n vÃ o Matrix`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GITHUB CONFIG + AUTO-FETCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _matrixWeekOverride = null; // set by auto-fetch, used by generateMatrix

// â”€â”€ GitHub Config: Save / Edit / Init â”€â”€
function saveGhConfig() {
  const user = document.getElementById('ghUsername').value.trim();
  const repo = document.getElementById('ghRepo').value.trim();
  if (!user || !repo) { alert('Vui lÃ²ng nháº­p cáº£ Username vÃ  TÃªn Repo.'); return; }
  if (!/^[a-zA-Z0-9_.-]+$/.test(user) || !/^[a-zA-Z0-9_.-]+$/.test(repo)) {
    alert('Username hoáº·c Repo chá»©a kÃ½ tá»± khÃ´ng há»£p lá»‡.\nChá»‰ cho phÃ©p: a-z, 0-9, dáº¥u cháº¥m, gáº¡ch dÆ°á»›i, gáº¡ch ngang.');
    return;
  }
  localStorage.setItem('gh_username', user);
  localStorage.setItem('gh_repo', repo);
  showToast('âœ“ ÄÃ£ lÆ°u cáº¥u hÃ¬nh GitHub');
  renderGhConfigCollapsed(user, repo);
  enableFetchButton();
}

function editGhConfig() {
  const card = document.getElementById('ghConfigCard');
  card.classList.remove('collapsed');
  const body = document.getElementById('ghConfigBody');
  body.classList.remove('hidden');
  // Restore form inputs
  body.innerHTML = `
    <div class="gh-config-row">
      <div class="field">
        <label>GitHub Username</label>
        <input type="text" id="ghUsername" placeholder="your-username" autocomplete="off"
          value="${localStorage.getItem('gh_username') || ''}" />
      </div>
      <div class="field">
        <label>TÃªn Repo</label>
        <input type="text" id="ghRepo" placeholder="cot-data" autocomplete="off"
          value="${localStorage.getItem('gh_repo') || ''}" />
      </div>
      <button class="btn-gh-save" onclick="saveGhConfig()">LÆ°u</button>
    </div>`;
  document.getElementById('ghHeaderRight').innerHTML = '';
}

function renderGhConfigCollapsed(user, repo) {
  const card = document.getElementById('ghConfigCard');
  card.classList.add('collapsed');
  const body = document.getElementById('ghConfigBody');
  body.classList.add('hidden');
  document.getElementById('ghHeaderRight').innerHTML = `
    <div class="gh-status-row">
      <span class="gh-status-text">
        <a class="gh-repo-link" href="https://github.com/${user}/${repo}" target="_blank" rel="noopener">${user}/${repo}</a>
      </span>
      <button class="btn-gh-edit" onclick="editGhConfig()">âœ Sá»­a</button>
    </div>`;
}

function enableFetchButton() {
  const btn = document.getElementById('btnFetchCftc');
  btn.disabled = false;
  btn.title = '';
  // Check if cache exists for current week â†’ show "LÃ m má»›i" label
  const cached = loadCftcCache();
  if (cached) {
    btn.innerHTML = 'â¬¡ LÃ m Má»›i Dá»¯ Liá»‡u CFTC';
  } else {
    btn.innerHTML = 'â¬¡ Láº¥y Dá»¯ Liá»‡u CFTC';
  }
}

function initGhConfig() {
  const user = localStorage.getItem('gh_username');
  const repo = localStorage.getItem('gh_repo');
  if (user && repo) {
    renderGhConfigCollapsed(user, repo);
    enableFetchButton();
    document.getElementById('ghUsername').value = user;
    document.getElementById('ghRepo').value = repo;
  }
}

// â”€â”€ Cache â”€â”€
function saveCftcCache(payload) {
  const cacheObj = {
    timestamp: new Date().toISOString(),
    data: payload
  };
  localStorage.setItem('cftc_cache', JSON.stringify(cacheObj));
}

function loadCftcCache() {
  try {
    const raw = localStorage.getItem('cftc_cache');
    if (!raw) return null;
    return JSON.parse(raw);
  } catch(e) { return null; }
}

function renderCacheInfo() {
  const el = document.getElementById('fetchCacheInfo');
  const cached = loadCftcCache();
  if (!cached) { el.innerHTML = ''; return; }

  const ts = new Date(cached.timestamp);
  const meta = cached.data && cached.data.meta;
  const weekLabel = meta ? meta.weekLabel : '?';
  const dateStr = ts.toLocaleDateString('vi-VN', {day:'2-digit',month:'2-digit',year:'numeric'});
  const timeStr = ts.toLocaleTimeString('vi-VN', {hour:'2-digit',minute:'2-digit'});

  el.innerHTML = `<span class="cache-label">Cache:</span> Dá»¯ liá»‡u tuáº§n <strong>${weekLabel}</strong> â€” cache tá»« ${dateStr} lÃºc ${timeStr}`;
}

// â”€â”€ Fetch from GitHub â”€â”€
async function fetchCftcFromGitHub() {
  const user = localStorage.getItem('gh_username');
  const repo = localStorage.getItem('gh_repo');
  if (!user || !repo) { showToast('âš  ChÆ°a cáº¥u hÃ¬nh GitHub', 'warn'); return; }

  const btn = document.getElementById('btnFetchCftc');
  const statusEl = document.getElementById('fetchStatus');

  // Loading state
  btn.className = 'btn-fetch-cftc loading';
  btn.innerHTML = '<span class="fetch-spinner"></span> Äang táº£i...';
  btn.disabled = true;
  statusEl.textContent = '';
  statusEl.className = 'fetch-status';

  const url = `https://raw.githubusercontent.com/${user}/${repo}/main/data/cot-latest.json`;

  try {
    const res = await fetch(url);

    if (!res.ok) {
      // â”€â”€ Case: 404 â”€â”€
      if (res.status === 404) {
        btn.className = 'btn-fetch-cftc error';
        btn.innerHTML = 'âœ• KhÃ´ng tÃ¬m tháº¥y file';
        statusEl.innerHTML = '404 â€” File <code>data/cot-latest.json</code> chÆ°a tá»“n táº¡i.<br>GitHub Actions cÃ³ thá»ƒ chÆ°a cháº¡y láº§n Ä‘áº§u, hoáº·c file path khÃ¡c.';
        statusEl.className = 'fetch-status error';
        resetFetchBtnAfter(4000);
        return;
      }

      // â”€â”€ Case: 403 (private repo) â”€â”€
      if (res.status === 403) {
        btn.className = 'btn-fetch-cftc error';
        btn.innerHTML = 'âœ• Repo Private';
        statusEl.innerHTML = '403 â€” Repo cÃ³ thá»ƒ lÃ  private.<br>HÃ£y Ä‘á»•i repo sang <strong>public</strong> hoáº·c kiá»ƒm tra láº¡i tÃªn repo.';
        statusEl.className = 'fetch-status error';
        resetFetchBtnAfter(4000);
        return;
      }

      throw new Error(`HTTP ${res.status}`);
    }

    const text = await res.text();
    let payload;
    try {
      payload = JSON.parse(text);
    } catch(e) {
      // â”€â”€ Case: JSON sai format â”€â”€
      btn.className = 'btn-fetch-cftc error';
      btn.innerHTML = 'âœ• JSON lá»—i format';
      statusEl.innerHTML = `File JSON khÃ´ng parse Ä‘Æ°á»£c: ${e.message.slice(0,80)}<br><a href="https://github.com/${user}/${repo}/blob/main/scripts/fetch_cot.py" target="_blank" style="color:var(--accent)">Xem script fetch_cot.py â†’</a>`;
      statusEl.className = 'fetch-status error';
      resetFetchBtnAfter(4000);
      return;
    }

    // Validate structure
    if (!payload.entries || !Array.isArray(payload.entries) || payload.entries.length === 0) {
      btn.className = 'btn-fetch-cftc error';
      btn.innerHTML = 'âœ• Dá»¯ liá»‡u rá»—ng';
      statusEl.innerHTML = 'JSON cÃ³ format Ä‘Ãºng nhÆ°ng thiáº¿u <code>entries</code> hoáº·c entries rá»—ng.';
      statusEl.className = 'fetch-status error';
      resetFetchBtnAfter(4000);
      return;
    }

    // Validate required fields in entries
    const requiredFields = ['pair', 'cur', 'lo', 'hi'];
    const missingFields = [];
    for (const entry of payload.entries) {
      for (const f of requiredFields) {
        if (entry[f] === undefined || entry[f] === null) {
          missingFields.push(`${entry.pair || '?'}: thiáº¿u '${f}'`);
        }
      }
    }
    if (missingFields.length > 0) {
      btn.className = 'btn-fetch-cftc error';
      btn.innerHTML = 'âœ• Field thiáº¿u';
      statusEl.innerHTML = `CÃ¡c field báº¯t buá»™c bá»‹ thiáº¿u:<br>${missingFields.slice(0,5).join('<br>')}<br><a href="https://github.com/${user}/${repo}/blob/main/scripts/fetch_cot.py" target="_blank" style="color:var(--accent)">Kiá»ƒm tra script â†’</a>`;
      statusEl.className = 'fetch-status error';
      resetFetchBtnAfter(4000);
      return;
    }

    // â”€â”€ Case: Stale data (> 10 days old) â”€â”€
    if (payload.meta && payload.meta.fetchedAt) {
      const fetchedDate = new Date(payload.meta.fetchedAt);
      const daysDiff = (Date.now() - fetchedDate.getTime()) / (1000 * 60 * 60 * 24);
      if (daysDiff > 10) {
        statusEl.innerHTML = `âš  Dá»¯ liá»‡u Ä‘Ã£ cÅ© (${Math.floor(daysDiff)} ngÃ y trÆ°á»›c). CÃ³ thá»ƒ GitHub Actions Ä‘Ã£ khÃ´ng cháº¡y gáº§n Ä‘Ã¢y.`;
        statusEl.className = 'fetch-status warn';
      }
    }

    // â”€â”€ Success â†’ populate matrix â”€â”€
    saveCftcCache(payload);
    renderCacheInfo();

    // Convert entries to matrixEntries format
    matrixEntries = payload.entries.slice(0, 8).map(e => {
      const cur = typeof e.cur === 'number' ? e.cur : parseVN(e.cur);
      const prev = (e.prev !== null && e.prev !== undefined) ? (typeof e.prev === 'number' ? e.prev : parseVN(e.prev)) : null;
      const lo = typeof e.lo === 'number' ? e.lo : parseVN(e.lo);
      const hi = typeof e.hi === 'number' ? e.hi : parseVN(e.hi);
      const range = hi - lo;
      const idxNum = range > 0 ? Math.min(100, Math.max(0, ((cur - lo) / range) * 100)) : 50;
      return {
        pair: e.pair,
        cur, prev: (prev !== null && !isNaN(prev)) ? prev : null,
        lo, hi,
        t4: e.t4 || '',
        idxNum: e.idxNum !== undefined ? e.idxNum : idxNum,
        delta: e.delta, prev_delta: e.prev_delta,
        oi: e.oi, oi_prev: e.oi_prev, oi_delta: e.oi_delta,
        history_4w: e.history_4w, avg_13w: e.avg_13w, avg_26w: e.avg_26w
      };
    });

    renderMatrixEntries();

    // Set data source info
    _matrixDataSource = 'auto';
    const weekLabel = payload.meta ? payload.meta.weekLabel : '';
    _matrixWeekOverride = weekLabel ? `Tuáº§n ${weekLabel}` : null;

    // Auto-generate matrix
    generateMatrix();

    // Success state
    btn.className = 'btn-fetch-cftc success';
    btn.innerHTML = 'âœ“ ÄÃ£ táº£i xong!';
    const entryCount = payload.entries.length;
    if (!statusEl.textContent.includes('âš ')) {
      statusEl.textContent = `ThÃ nh cÃ´ng â€” ${entryCount} Ä‘á»“ng tiá»n tá»« ${weekLabel || 'CFTC'}`;
    }
    showToast(`âœ“ ÄÃ£ táº£i ${entryCount} Ä‘á»“ng tiá»n tá»« CFTC`);

    resetFetchBtnAfter(3000);

  } catch(err) {
    // â”€â”€ Case: Network offline / other errors â”€â”€
    btn.className = 'btn-fetch-cftc error';
    btn.innerHTML = 'âœ• Lá»—i káº¿t ná»‘i';

    const cached = loadCftcCache();
    if (cached && cached.data && cached.data.entries) {
      statusEl.innerHTML = `KhÃ´ng thá»ƒ káº¿t ná»‘i: ${err.message}.<br>` +
        `<button class="btn-gh-edit" onclick="loadFromCache()" style="margin-top:6px">â†» DÃ¹ng cache láº§n trÆ°á»›c</button>`;
    } else {
      statusEl.innerHTML = `KhÃ´ng thá»ƒ káº¿t ná»‘i: ${err.message}.<br>Kiá»ƒm tra káº¿t ná»‘i máº¡ng vÃ  thá»­ láº¡i.`;
    }
    statusEl.className = 'fetch-status error';
    resetFetchBtnAfter(4000);
  }
}

function loadFromCache() {
  const cached = loadCftcCache();
  if (!cached || !cached.data || !cached.data.entries) {
    showToast('âš  KhÃ´ng cÃ³ cache', 'warn');
    return;
  }

  const payload = cached.data;
  matrixEntries = payload.entries.slice(0, 8).map(e => {
    const cur = typeof e.cur === 'number' ? e.cur : parseVN(e.cur);
    const prev = (e.prev !== null && e.prev !== undefined) ? (typeof e.prev === 'number' ? e.prev : parseVN(e.prev)) : null;
    const lo = typeof e.lo === 'number' ? e.lo : parseVN(e.lo);
    const hi = typeof e.hi === 'number' ? e.hi : parseVN(e.hi);
    return {
      pair: e.pair, cur, prev: (prev !== null && !isNaN(prev)) ? prev : null,
      lo, hi, t4: e.t4 || '',
      idxNum: e.idxNum !== undefined ? e.idxNum : 50,
      delta: e.delta, prev_delta: e.prev_delta,
      oi: e.oi, oi_prev: e.oi_prev, oi_delta: e.oi_delta,
      history_4w: e.history_4w, avg_13w: e.avg_13w, avg_26w: e.avg_26w
    };
  });

  renderMatrixEntries();
  _matrixDataSource = 'auto';
  const weekLabel = payload.meta ? payload.meta.weekLabel : '';
  _matrixWeekOverride = weekLabel ? `Tuáº§n ${weekLabel}` : null;
  generateMatrix();

  document.getElementById('fetchStatus').textContent = `ÄÃ£ load tá»« cache â€” ${weekLabel}`;
  document.getElementById('fetchStatus').className = 'fetch-status';
  showToast(`âœ“ ÄÃ£ load ${matrixEntries.length} Ä‘á»“ng tiá»n tá»« cache`);
}

function resetFetchBtnAfter(ms) {
  setTimeout(() => {
    const btn = document.getElementById('btnFetchCftc');
    btn.className = 'btn-fetch-cftc';
    btn.disabled = false;
    const cached = loadCftcCache();
    btn.innerHTML = cached ? 'â¬¡ LÃ m Má»›i Dá»¯ Liá»‡u CFTC' : 'â¬¡ Láº¥y Dá»¯ Liá»‡u CFTC';
  }, ms);
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderHistory();
updateMatrixProgress();
initGhConfig();
renderCacheInfo();

// When user manually adds entry, mark source as manual
const _origAddMatrixEntry = addMatrixEntry;
addMatrixEntry = function() {
  _matrixDataSource = 'manual';
  _matrixWeekOverride = null;
  _origAddMatrixEntry();
};

document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.activeElement.closest('#tab-calc')) calculate();
});
</script>
</body>
</html>
