<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUS — Daily Bias Board</title>
<meta name="description" content="NEXUS Daily Bias Board — Xác định hướng giao dịch hàng ngày qua 6 bước: COT Bias, Rate Spread, News Risk, Assessment, Final Bias.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Mono:wght@400;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../shared/style.css">
<style>
/* ── Daily Bias page-specific styles ── */

/* ── Header ── */
.db-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
}
.db-header h1 {
  font-family: var(--font-display); font-size: 28px; font-weight: 800;
  letter-spacing: -0.02em; color: var(--text-primary);
}
.db-header h1 span { color: var(--accent); }
.db-date {
  font-family: var(--font-mono); font-size: 14px; color: var(--text-secondary);
}

/* ── Steps ── */
.db-step {
  background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--r-md);
  padding: 20px 24px; margin-bottom: 16px; transition: border-color 0.2s;
}
.db-step.completed { border-color: rgba(92,200,160,0.3); }
.db-step.active { border-color: var(--accent); border-left: 3px solid var(--accent); }

.db-step-header {
  display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
  cursor: pointer; user-select: none;
}
.db-step-num {
  width: 28px; height: 28px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-display); font-weight: 800; font-size: 13px;
  flex-shrink: 0;
  background: var(--bg-elevated); color: var(--text-muted); border: 1px solid var(--border);
  transition: all 0.2s;
}
.db-step.completed .db-step-num { background: var(--bull); color: var(--bg-primary); border-color: var(--bull); }
.db-step.active .db-step-num { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); }

.db-step-title {
  font-family: var(--font-display); font-size: 14px; font-weight: 700;
  color: var(--text-primary); letter-spacing: 0.03em;
}
.db-step-status {
  margin-left: auto; font-size: 10px; font-weight: 700; letter-spacing: 0.08em;
  padding: 2px 8px; border-radius: var(--r-sm); text-transform: uppercase;
}
.db-step-status.done { color: var(--bull); background: var(--bull-dim); }
.db-step-status.auto { color: var(--accent); background: var(--accent-dim); }
.db-step-status.pending { color: var(--text-muted); background: var(--bg-hover); }

.db-step-body { /* no base styles — collapsed state hides via .collapsed */ }
.db-step-body.collapsed { display: none; }

/* ── Pair Selector (Step 1) ── */
.db-pair-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: 8px;
}
.db-pair-chip {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--r-sm);
  padding: 10px 12px; cursor: pointer; transition: all 0.2s;
  font-family: var(--font-mono); font-size: 13px; font-weight: 700;
  color: var(--text-secondary);
}
.db-pair-chip:hover { border-color: var(--border-bright); color: var(--text-primary); }
.db-pair-chip.selected {
  border-color: var(--accent); color: var(--accent); background: var(--accent-dim);
}
.db-pair-chip .check { width: 14px; height: 14px; border-radius: 3px; border: 2px solid var(--border-bright); flex-shrink: 0; }
.db-pair-chip.selected .check { background: var(--accent); border-color: var(--accent); }
.db-pair-chip.recommended { border-color: rgba(200, 169, 110, 0.4); }
.db-pair-chip.recommended:hover { border-color: var(--accent); }

/* ── COT Bias Display (Step 2) ── */
.db-cot-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 10px;
}
.db-cot-card {
  background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--r-sm);
  padding: 12px 14px; text-align: center;
}
.db-cot-pair { font-family: var(--font-display); font-weight: 700; font-size: 14px; margin-bottom: 4px; }
.db-cot-index { font-family: var(--font-mono); font-size: 22px; font-weight: 700; }
.db-cot-label { font-size: 10px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; margin-top: 3px; }
.db-cot-bias {
  display: inline-block; padding: 2px 8px; border-radius: var(--r-sm);
  font-size: 11px; font-weight: 700; letter-spacing: 0.06em; margin-top: 6px;
}

/* ── Rate Table (Step 3) ── */
.db-rate-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.db-rate-table th {
  padding: 8px 10px; text-align: left; font-size: 11px; font-weight: 500;
  letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-secondary);
  border-bottom: 2px solid var(--border-bright); font-family: var(--font-body);
}
.db-rate-table td {
  padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: middle;
}
.db-rate-table tr:last-child td { border-bottom: none; }
.db-rate-input {
  width: 70px; background: var(--bg-primary); border: 1px solid var(--border);
  color: var(--text-primary); font-family: var(--font-mono); font-size: 13px;
  padding: 4px 6px; border-radius: var(--r-sm); text-align: center;
  outline: none; transition: border-color 0.2s;
}
.db-rate-input:focus { border-color: var(--accent); }
.db-spread-cell { font-weight: 700; font-family: var(--font-mono); }
.db-spread-pos { color: var(--bull); }
.db-spread-neg { color: var(--bear); }

/* ── News Risk (Step 4) ── */
.db-news-list { display: flex; flex-direction: column; gap: 6px; }
.db-news-item {
  display: flex; align-items: center; gap: 8px; padding: 8px 10px;
  background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--r-sm);
  font-size: 12px;
}
.db-news-impact {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.db-news-impact.high { background: var(--bear); box-shadow: 0 0 4px var(--bear); }
.db-news-impact.medium { background: var(--warn); }
.db-news-impact.low { background: var(--text-muted); }
.db-news-currency { font-weight: 700; color: var(--accent); font-family: var(--font-display); font-size: 11px; }
.db-news-time { font-family: var(--font-mono); color: var(--text-muted); font-size: 11px; }
.db-news-title { color: var(--text-primary); }

/* ── Assessment (Step 5) ── */
.db-assess-tabs {
  display: flex; gap: 4px; margin-bottom: 14px; flex-wrap: wrap;
}
.db-assess-tab {
  padding: 6px 14px; border-radius: var(--r-sm); font-family: var(--font-mono);
  font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s;
  border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-muted);
  position: relative;
}
.db-assess-tab:hover { border-color: var(--border-bright); color: var(--text-primary); }
.db-assess-tab.active { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
.db-assess-tab .tab-dot {
  width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-left: 6px;
}
.db-assess-tab .tab-dot.filled { background: var(--bull); }
.db-assess-tab .tab-dot.empty { background: var(--border); }
.db-assess-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.db-assess-field { display: flex; flex-direction: column; gap: 4px; }
.db-assess-field.full { grid-column: 1 / -1; }
.db-assess-field label {
  font-size: 11px; color: var(--text-secondary); letter-spacing: 0.04em;
}
.db-assess-field select, .db-assess-field input, .db-assess-field textarea {
  background: var(--bg-primary); border: 1px solid var(--border-bright); color: var(--text-primary);
  font-family: var(--font-mono); font-size: 13px; padding: 8px 10px;
  border-radius: var(--r-sm); outline: none; transition: border-color 0.2s;
}
.db-assess-field select:focus, .db-assess-field input:focus, .db-assess-field textarea:focus {
  border-color: var(--accent);
}
.db-assess-field textarea { min-height: 60px; resize: vertical; }
.db-assess-hint {
  font-size: 11px; color: var(--text-muted); padding: 6px 10px; margin-top: 4px;
  background: var(--bg-elevated); border-radius: var(--r-sm); border-left: 2px solid var(--accent);
  line-height: 1.5;
}
.db-assess-hint .hint-bias {
  font-weight: 700; letter-spacing: 0.04em; font-size: 10px;
}
.db-assess-hint .hint-bias.bull { color: var(--bull); }
.db-assess-hint .hint-bias.bear { color: var(--bear); }
.db-assess-hint .hint-bias.neutral { color: var(--text-muted); }

/* ── Final Bias (Step 6) ── */
.db-final-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 14px; margin-bottom: 24px;
}
.db-final-card {
  background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--r-lg);
  padding: 18px 20px; transition: border-color 0.3s, box-shadow 0.3s;
  position: relative; overflow: hidden;
}
.db-final-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: var(--border); transition: background 0.3s;
}
.db-final-card.bias-long::before { background: linear-gradient(90deg, var(--bull), rgba(92,200,160,0.3)); }
.db-final-card.bias-short::before { background: linear-gradient(90deg, var(--bear), rgba(224,92,92,0.3)); }
.db-final-card.bias-neutral::before { background: linear-gradient(90deg, var(--neutral), rgba(136,153,187,0.3)); }
.db-final-card.bias-long { border-color: rgba(92,200,160,0.25); box-shadow: 0 0 20px rgba(92,200,160,0.06); }
.db-final-card.bias-short { border-color: rgba(224,92,92,0.25); box-shadow: 0 0 20px rgba(224,92,92,0.06); }
.db-final-card.bias-neutral { border-color: rgba(136,153,187,0.2); }

.db-final-head {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.db-final-pair {
  font-family: var(--font-display); font-weight: 800; font-size: 16px;
  color: var(--text-primary); letter-spacing: 0.02em;
}
.db-final-badge {
  font-size: 10px; font-weight: 700; letter-spacing: 0.08em;
  padding: 3px 10px; border-radius: var(--r-sm); text-transform: uppercase;
}

/* Source signals summary */
.db-final-sources {
  display: flex; gap: 6px; margin-bottom: 14px; flex-wrap: wrap;
}
.db-source-chip {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: 10px; font-weight: 600; letter-spacing: 0.04em;
  padding: 3px 9px; border-radius: 20px;
  background: var(--bg-elevated); border: 1px solid var(--border);
  color: var(--text-muted); text-transform: uppercase;
}
.db-source-chip .src-dot {
  width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
}
.db-source-chip.src-long .src-dot { background: var(--bull); box-shadow: 0 0 4px var(--bull); }
.db-source-chip.src-short .src-dot { background: var(--bear); box-shadow: 0 0 4px var(--bear); }
.db-source-chip.src-neutral .src-dot { background: var(--text-muted); }
.db-source-chip.src-none .src-dot { background: var(--border); }
.db-source-chip.src-long { color: var(--bull); border-color: rgba(92,200,160,0.2); }
.db-source-chip.src-short { color: var(--bear); border-color: rgba(224,92,92,0.2); }

/* Bias selection buttons */
.db-bias-btns {
  display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px;
}
.db-bias-btn {
  padding: 10px 0; border-radius: 6px; font-size: 12px;
  font-family: var(--font-display); font-weight: 700; letter-spacing: 0.06em;
  cursor: pointer; transition: all 0.25s; border: 1.5px solid var(--border);
  background: var(--bg-primary); color: var(--text-muted);
  display: flex; align-items: center; justify-content: center; gap: 6px;
  text-transform: uppercase;
}
.db-bias-btn:hover { border-color: var(--border-bright); color: var(--text-primary); background: var(--bg-elevated); }
.db-bias-btn.long.selected {
  background: rgba(92,200,160,0.15); color: var(--bull); border-color: var(--bull);
  box-shadow: 0 0 12px rgba(92,200,160,0.1), inset 0 0 12px rgba(92,200,160,0.05);
}
.db-bias-btn.neutral.selected {
  background: rgba(136,153,187,0.1); color: var(--neutral); border-color: var(--neutral);
  box-shadow: 0 0 12px rgba(136,153,187,0.08);
}
.db-bias-btn.short.selected {
  background: rgba(224,92,92,0.15); color: var(--bear); border-color: var(--bear);
  box-shadow: 0 0 12px rgba(224,92,92,0.1), inset 0 0 12px rgba(224,92,92,0.05);
}
.db-bias-btn svg { width: 14px; height: 14px; }

/* Per-pair mini confidence */
.db-pair-conf {
  display: flex; align-items: center; gap: 8px; margin-top: 4px;
}
.db-pair-conf-bar {
  flex: 1; height: 3px; background: var(--border); border-radius: 2px; overflow: hidden;
}
.db-pair-conf-fill {
  height: 100%; border-radius: 2px; transition: width 0.4s ease, background 0.4s;
}
.db-pair-conf-pct {
  font-family: var(--font-mono); font-size: 11px; font-weight: 700;
  min-width: 36px; text-align: right;
}

/* Overall Confidence Meter */
.db-confidence { margin-top: 24px; }
.db-conf-overview {
  background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--r-lg);
  padding: 20px 24px; display: flex; align-items: center; gap: 24px;
}
.db-conf-score {
  display: flex; flex-direction: column; align-items: center; min-width: 80px;
}
.db-conf-pct {
  font-family: var(--font-mono); font-size: 36px; font-weight: 700;
  line-height: 1; letter-spacing: -0.02em;
}
.db-conf-tier {
  font-family: var(--font-display); font-size: 11px; font-weight: 700;
  letter-spacing: 0.1em; text-transform: uppercase; margin-top: 4px;
}
.db-conf-detail { flex: 1; display: flex; flex-direction: column; gap: 8px; }
.db-conf-meter {
  display: flex; align-items: center; gap: 0;
}
.db-conf-bar {
  flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;
}
.db-conf-fill {
  height: 100%; border-radius: 4px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), background 0.4s;
}
.db-conf-label {
  font-family: var(--font-display); font-weight: 700; font-size: 13px;
  letter-spacing: 0.06em; min-width: 60px; display: none;
}
.db-conf-breakdown {
  display: flex; gap: 16px; flex-wrap: wrap;
}
.db-conf-src {
  font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 4px;
}
.db-conf-src .csrc-dot {
  width: 5px; height: 5px; border-radius: 50%;
}
.db-conf-src.aligned .csrc-dot { background: var(--bull); }
.db-conf-src.misaligned .csrc-dot { background: var(--bear); }
.db-conf-src.partial .csrc-dot { background: var(--warn); }

/* ── History ── */
.db-history-item {
  background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--r-sm);
  padding: 12px 16px; margin-bottom: 8px;
}
.db-history-head {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 6px;
}
.db-history-date { font-family: var(--font-mono); font-size: 13px; font-weight: 700; color: var(--text-primary); }
.db-history-conf { font-size: 11px; font-weight: 700; }
.db-history-pairs { display: flex; flex-wrap: wrap; gap: 6px; }
.db-history-bias {
  font-size: 11px; font-weight: 700; letter-spacing: 0.04em; padding: 2px 8px;
  border-radius: var(--r-sm);
}

/* ── Auto-fill badge ── */
.db-auto-badge {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 10px; color: var(--accent); background: var(--accent-dim);
  padding: 2px 8px; border-radius: var(--r-sm); letter-spacing: 0.04em;
  font-weight: 700; border: 1px solid rgba(200,169,110,0.2);
}

/* ── Empty ── */
.db-empty {
  text-align: center; padding: 30px 20px; color: var(--text-muted);
  font-size: 13px; border: 1px dashed var(--border); border-radius: var(--r-md);
}

@media (max-width: 600px) {
  .db-header { flex-direction: column; align-items: flex-start; }
  .db-assess-grid { grid-template-columns: 1fr; }
  .db-pair-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
  .db-final-grid { grid-template-columns: 1fr; }
  .db-conf-overview { flex-direction: column; text-align: center; }
}
</style>
</head>
<body>
<div class="nx-app">
  <div class="nx-main">
    <div class="nx-content">

  <div class="db-header">
    <h1><a href="../" style="color:inherit;text-decoration:none">NEXUS</a> · Daily <span>Bias</span></h1>
    <div>
      <div class="db-date" id="todayDate">—</div>
    </div>
  </div>

  <!-- Steps Container -->
  <div id="stepsContainer">

    <!-- STEP 1: Chọn pairs -->
    <div class="db-step active" id="step1">
      <div class="db-step-header" onclick="toggleStep(1)">
        <div class="db-step-num">1</div>
        <div class="db-step-title">Chọn pairs trade hôm nay</div>
        <span class="db-step-status pending" id="step1Status">CHƯA CHỌN</span>
      </div>
      <div class="db-step-body" id="step1Body">
        <div class="db-pair-grid" id="pairGrid"></div>
      </div>
    </div>

    <!-- STEP 2: COT Bias -->
    <div class="db-step" id="step2">
      <div class="db-step-header" onclick="toggleStep(2)">
        <div class="db-step-num">2</div>
        <div class="db-step-title">COT Bias</div>
        <span class="db-step-status pending" id="step2Status">CHỜ CHỌN PAIR</span>
      </div>
      <div class="db-step-body collapsed" id="step2Body">
        <div id="cotBiasContent"></div>
      </div>
    </div>

    <!-- STEP 3: Rate Spread -->
    <div class="db-step" id="step3">
      <div class="db-step-header" onclick="toggleStep(3)">
        <div class="db-step-num">3</div>
        <div class="db-step-title">Interest Rate Spread</div>
        <span class="db-step-status pending" id="step3Status">CHỜ</span>
      </div>
      <div class="db-step-body collapsed" id="step3Body">
        <div id="rateContent"></div>
      </div>
    </div>

    <!-- STEP 4: News Risk -->
    <div class="db-step" id="step4">
      <div class="db-step-header" onclick="toggleStep(4)">
        <div class="db-step-num">4</div>
        <div class="db-step-title">News Risk</div>
        <span class="db-step-status pending" id="step4Status">CHỜ</span>
      </div>
      <div class="db-step-body collapsed" id="step4Body">
        <div id="newsRiskContent"></div>
      </div>
    </div>

    <!-- STEP 5: Trader Assessment -->
    <div class="db-step" id="step5">
      <div class="db-step-header" onclick="toggleStep(5)">
        <div class="db-step-num">5</div>
        <div class="db-step-title">Trader Assessment</div>
        <span class="db-step-status pending" id="step5Status">CHỜ</span>
      </div>
      <div class="db-step-body collapsed" id="step5Body">
        <div id="assessContent"></div>
      </div>
    </div>

    <!-- STEP 6: Final Bias -->
    <div class="db-step" id="step6">
      <div class="db-step-header" onclick="toggleStep(6)">
        <div class="db-step-num">6</div>
        <div class="db-step-title">Final Bias & Confidence</div>
        <span class="db-step-status pending" id="step6Status">CHỜ</span>
      </div>
      <div class="db-step-body collapsed" id="step6Body">
        <div id="finalBiasContent"></div>
        <div class="db-confidence" id="confidenceSection" style="display:none">
          <div class="db-conf-overview">
            <div class="db-conf-score">
              <div class="db-conf-pct" id="confPct">0%</div>
              <div class="db-conf-tier" id="confTier">—</div>
            </div>
            <div class="db-conf-detail">
              <div class="db-conf-meter">
                <div class="db-conf-bar"><div class="db-conf-fill" id="confFill"></div></div>
                <span class="db-conf-label" id="confLabel">—</span>
              </div>
              <div class="db-conf-breakdown" id="confBreakdown"></div>
            </div>
          </div>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap; align-items:center">
          <button class="nx-btn nx-btn-primary" onclick="saveDailyBias()">Lưu Daily Bias</button>
          <button class="nx-btn nx-btn-ghost" onclick="resetAll()">Reset</button>
          <span id="saveStatus" style="font-size:11px; color:var(--text-muted); font-family:var(--font-mono);"></span>
        </div>
      </div>
    </div>

  </div>

  <!-- History -->
  <div style="margin-top:32px">
    <h2 class="nx-section-title">LỊCH SỬ DAILY BIAS</h2>
    <div id="biasHistory"></div>
  </div>

  <!-- Footer -->
  <footer class="nx-footer">
    Daily Bias Board — Tổng hợp COT + Lãi suất + News + Price Action<br>
    NEXUS — ICT Trading Command Center · v1.0
  </footer>

    </div>
  </div>
</div>

<script src="../shared/utils.js"></script>
<script src="../shared/store.js"></script>
<script src="../shared/crypto.js"></script>
<script src="../shared/sync.js"></script>
<script src="../shared/nav.js"></script>
<script>
// ═══════════════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════════════
let selectedPairs = [];     // Step 1
let cotBiasData = {};       // Step 2: { pair: { base, quote, baseBias, quoteBias, ... } }
let finalBiases = {};       // Step 6: { 'EUR/JPY': 'LONG' | 'SHORT' | 'NEUTRAL' }
let assessmentData = {};    // Step 5: { 'EUR/USD': { candle, zone, pdh, pdl, asianH, asianL, notes }, ... }
let currentAssessPair = null; // Currently active tab in Step 5

// ═══════════════════════════════════════════════════
//  INTEREST RATES — Hardcode 8 NHTW (update manually ~8 times/year)
// ═══════════════════════════════════════════════════
const CENTRAL_BANK_RATES = {
  EUR: { rate: 2.65, bank: 'ECB', updated: '2025-01' },
  GBP: { rate: 4.50, bank: 'BoE', updated: '2025-02' },
  USD: { rate: 4.50, bank: 'FED', updated: '2025-01' },
  JPY: { rate: 0.50, bank: 'BOJ', updated: '2025-01' },
  AUD: { rate: 4.10, bank: 'RBA', updated: '2025-02' },
  CAD: { rate: 3.00, bank: 'BoC', updated: '2025-01' },
  CHF: { rate: 0.50, bank: 'SNB', updated: '2024-12' },
  NZD: { rate: 3.75, bank: 'RBNZ', updated: '2025-02' },
};

// Allow user overrides stored in localStorage
function getRates() {
  const saved = Store.get('nexus_rates');
  const rates = { ...CENTRAL_BANK_RATES };
  if (saved) {
    for (const [k, v] of Object.entries(saved)) {
      if (rates[k] && v.rate !== undefined) rates[k] = { ...rates[k], rate: v.rate };
    }
  }
  return rates;
}

function saveRateOverride(currency, newRate) {
  const saved = Store.get('nexus_rates') || {};
  saved[currency] = { rate: newRate };
  Store.set('nexus_rates', saved);
}

// ═══════════════════════════════════════════════════
//  COMMON PAIRS LIST
// ═══════════════════════════════════════════════════
const TRADEABLE_PAIRS = [
  'EUR/USD', 'GBP/USD', 'USD/JPY', 'AUD/USD', 'USD/CAD', 'NZD/USD', 'USD/CHF',
  'EUR/JPY', 'GBP/JPY', 'AUD/JPY', 'NZD/JPY', 'CAD/JPY', 'CHF/JPY',
  'EUR/GBP', 'EUR/AUD', 'EUR/NZD', 'EUR/CAD', 'EUR/CHF',
  'GBP/AUD', 'GBP/NZD', 'GBP/CAD', 'GBP/CHF',
  'AUD/NZD', 'AUD/CAD', 'AUD/CHF', 'NZD/CAD', 'NZD/CHF', 'CAD/CHF'
];

// ═══════════════════════════════════════════════════
//  STEP 1: Pair Selection
// ═══════════════════════════════════════════════════
function renderStep1() {
  const grid = document.getElementById('pairGrid');
  const weeklyBias = Store.get('nexus_weekly_bias');
  const rec = (weeklyBias && weeklyBias.recommended_pairs) ? weeklyBias.recommended_pairs : [];

  grid.innerHTML = TRADEABLE_PAIRS.map(pair => {
    const sel = selectedPairs.includes(pair);
    const isRec = rec.includes(pair);
    return `<div class="db-pair-chip ${sel ? 'selected' : ''} ${isRec ? 'recommended' : ''}" onclick="togglePair('${pair}')">
      <div class="check"></div>
      ${pair}
      ${isRec ? `<span title="COT Recommended" style="margin-left:auto;color:var(--accent);font-size:12px">${SVG_ICONS.starFull}</span>` : ''}
    </div>`;
  }).join('');
  updateStep1Status();
}

function togglePair(pair) {
  const idx = selectedPairs.indexOf(pair);
  if (idx >= 0) selectedPairs.splice(idx, 1);
  else selectedPairs.push(pair);
  renderStep1();
  // Always render to handle empty state gracefully
  renderStep2();
  renderStep3();
  renderStep4();
  renderStep5();
  renderStep6();
}

function updateStep1Status() {
  const status = document.getElementById('step1Status');
  if (selectedPairs.length > 0) {
    status.textContent = `${selectedPairs.length} PAIRS`;
    status.className = 'db-step-status done';
    document.getElementById('step1').classList.add('completed');
    document.getElementById('step1').classList.remove('active');
  } else {
    status.textContent = 'CHƯA CHỌN';
    status.className = 'db-step-status pending';
    document.getElementById('step1').classList.remove('completed');
    document.getElementById('step1').classList.add('active');
  }
}

// ═══════════════════════════════════════════════════
//  STEP 2: COT Bias (auto from Tool 1)
// ═══════════════════════════════════════════════════
function renderStep2() {
  const content = document.getElementById('cotBiasContent');
  const status = document.getElementById('step2Status');
  const step = document.getElementById('step2');
  const body = document.getElementById('step2Body');

  if (!selectedPairs.length) {
    content.innerHTML = '<div class="db-empty">Chọn pairs ở Step 1 trước.</div>';
    status.textContent = 'CHỜ CHỌN PAIR';
    status.className = 'db-step-status pending';
    body.classList.add('collapsed');
    step.classList.remove('completed');
    return;
  }

  // Load weekly bias from COT Dashboard
  const weeklyBias = Store.get('nexus_weekly_bias');
  const hasBias = weeklyBias && weeklyBias.pairs && weeklyBias.pairs.length > 0;

  if (hasBias) {
    content.innerHTML = `<div class="db-auto-badge" style="margin-bottom:12px">Auto-fill từ Weekly Bias — ${weeklyBias.weekLabel || ''}</div>`;
  } else {
    content.innerHTML = `<div style="display:flex;align-items:center;gap:4px;font-size:12px;color:var(--warn);margin-bottom:10px">${SVG_ICONS.alertTriangle} Chưa có Weekly Bias. Vào COT Dashboard → Lock Weekly Bias trước.</div>`;
  }

  const biasMap = {};
  if (hasBias) {
    weeklyBias.pairs.forEach(p => { biasMap[p.pair] = p; });
  }

  // For each selected pair, show COT bias of both currencies
  const cards = selectedPairs.map(pair => {
    const [base, quote] = pair.split('/');
    const baseBias = biasMap[base];
    const quoteBias = biasMap[quote];

    cotBiasData[pair] = { base, quote, baseBias, quoteBias };

    let biasDirection = 'NEUTRAL';
    if (baseBias && quoteBias) {
      const baseIdx = baseBias.cotIndex;
      const quoteIdx = quoteBias.cotIndex;
      if (baseIdx >= 60 && quoteIdx <= 40) biasDirection = 'LONG';
      else if (baseIdx <= 40 && quoteIdx >= 60) biasDirection = 'SHORT';
      else if (baseIdx > quoteIdx + 15) biasDirection = 'LONG';
      else if (quoteIdx > baseIdx + 15) biasDirection = 'SHORT';
    }

    const biasColor = biasDirection === 'LONG' ? 'var(--bull)' : biasDirection === 'SHORT' ? 'var(--bear)' : 'var(--text-muted)';
    const biasBg = biasDirection === 'LONG' ? 'var(--bull-dim)' : biasDirection === 'SHORT' ? 'var(--bear-dim)' : 'var(--bg-hover)';

    return `<div class="db-cot-card">
      <div class="db-cot-pair">${pair}</div>
      <div style="display:flex; justify-content:center; gap:20px; margin:8px 0;">
        <div>
          <div style="font-size:11px;color:var(--text-muted)">${base}</div>
          <div class="db-cot-index" style="color:${baseBias ? getZone(baseBias.cotIndex).color : 'var(--text-muted)'}">${baseBias ? baseBias.cotIndex.toFixed(1) : '—'}</div>
          <div class="db-cot-label" style="color:${baseBias ? getZone(baseBias.cotIndex).color : 'var(--text-muted)'}">${baseBias ? baseBias.label : 'N/A'}</div>
        </div>
        <div style="display:flex;align-items:center;color:var(--text-muted);font-size:11px">vs</div>
        <div>
          <div style="font-size:11px;color:var(--text-muted)">${quote}</div>
          <div class="db-cot-index" style="color:${quoteBias ? getZone(quoteBias.cotIndex).color : 'var(--text-muted)'}">${quoteBias ? quoteBias.cotIndex.toFixed(1) : '—'}</div>
          <div class="db-cot-label" style="color:${quoteBias ? getZone(quoteBias.cotIndex).color : 'var(--text-muted)'}">${quoteBias ? quoteBias.label : 'N/A'}</div>
        </div>
      </div>
      <span class="db-cot-bias" style="color:${biasColor};background:${biasBg}">COT: ${biasDirection}</span>
    </div>`;
  });

  content.innerHTML += `<div class="db-cot-grid">${cards.join('')}</div>`;
  body.classList.remove('collapsed');
  status.textContent = hasBias ? 'AUTO' : 'THIẾU DỮ LIỆU';
  status.className = hasBias ? 'db-step-status auto' : 'db-step-status pending';
  if (hasBias) step.classList.add('completed');
}

// ═══════════════════════════════════════════════════
//  STEP 3: Interest Rate Spread
// ═══════════════════════════════════════════════════
function renderStep3() {
  const content = document.getElementById('rateContent');
  const status = document.getElementById('step3Status');
  const body = document.getElementById('step3Body');

  if (!selectedPairs.length) {
    content.innerHTML = '';
    status.textContent = 'CHỜ';
    status.className = 'db-step-status pending';
    document.getElementById('step3').classList.remove('completed');
    body.classList.add('collapsed');
    return;
  }

  const rates = getRates();

  // Get unique currencies from selected pairs
  const currencies = [...new Set(selectedPairs.flatMap(p => p.split('/')))];

  // Rate editor table
  let rateTable = `<div style="margin-bottom:16px">
    <div class="db-auto-badge" style="margin-bottom:10px">Lãi suất NHTW — edit trực tiếp nếu cần cập nhật</div>
    <table class="db-rate-table">
      <thead><tr><th>Currency</th><th>NHTW</th><th>Rate %</th><th>Cập nhật</th></tr></thead>
      <tbody>
      ${currencies.map(c => {
        const r = rates[c] || { rate: 0, bank: '?', updated: '?' };
        return `<tr>
          <td style="font-weight:700;color:var(--accent)">${c}</td>
          <td style="color:var(--text-muted)">${r.bank}</td>
          <td><input class="db-rate-input" type="text" value="${r.rate}" onchange="updateRate('${c}', this.value)" /></td>
          <td style="font-size:11px;color:var(--text-muted)">${r.updated}</td>
        </tr>`;
      }).join('')}
      </tbody>
    </table>
  </div>`;

  // Spread calculation for each pair
  let spreadCards = '<h3 style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;letter-spacing:0.08em;text-transform:uppercase;font-family:var(--font-display)">SPREAD THEO PAIR</h3>';
  spreadCards += '<table class="db-rate-table"><thead><tr><th>Pair</th><th>Base Rate</th><th>Quote Rate</th><th>Spread</th><th>Bias</th></tr></thead><tbody>';

  selectedPairs.forEach(pair => {
    const [base, quote] = pair.split('/');
    const baseRate = (rates[base] || { rate: 0 }).rate;
    const quoteRate = (rates[quote] || { rate: 0 }).rate;
    const spread = baseRate - quoteRate;
    const biasStr = spread > 0.5 ? 'LONG' : spread < -0.5 ? 'SHORT' : 'NEUTRAL';
    const biasColor = biasStr === 'LONG' ? 'var(--bull)' : biasStr === 'SHORT' ? 'var(--bear)' : 'var(--text-muted)';

    spreadCards += `<tr>
      <td style="font-weight:700">${pair}</td>
      <td>${baseRate.toFixed(2)}%</td>
      <td>${quoteRate.toFixed(2)}%</td>
      <td class="db-spread-cell ${spread >= 0 ? 'db-spread-pos' : 'db-spread-neg'}">${spread >= 0 ? '+' : ''}${spread.toFixed(2)}%</td>
      <td style="color:${biasColor};font-weight:700;font-size:12px">${biasStr}</td>
    </tr>`;
  });

  spreadCards += '</tbody></table>';

  content.innerHTML = rateTable + spreadCards;
  body.classList.remove('collapsed');
  status.textContent = 'DONE';
  status.className = 'db-step-status done';
  document.getElementById('step3').classList.add('completed');
}

function updateRate(currency, val) {
  const num = parseFloat(val);
  if (isNaN(num)) return;
  saveRateOverride(currency, num);
  renderStep3();
}

// ═══════════════════════════════════════════════════
//  STEP 4: News Risk (auto from Kill Zone's saved news)
// ═══════════════════════════════════════════════════
function renderStep4() {
  const content = document.getElementById('newsRiskContent');
  const status = document.getElementById('step4Status');
  const body = document.getElementById('step4Body');

  if (!selectedPairs.length) {
    content.innerHTML = '';
    status.textContent = 'CHỜ';
    status.className = 'db-step-status pending';
    document.getElementById('step4').classList.remove('completed');
    body.classList.add('collapsed');
    return;
  }

  // Load news from Kill Zone Timer's localStorage
  const today = new Date().toISOString().split('T')[0];
  const newsDate = localStorage.getItem('nexus_killzone_news_date');
  let news = [];
  if (newsDate === today) {
    try { news = JSON.parse(localStorage.getItem('nexus_killzone_news') || '[]'); } catch(e) {}
  }

  // Get relevant currencies
  const currencies = new Set(selectedPairs.flatMap(p => p.split('/')));

  if (news.length === 0) {
    content.innerHTML = `<div class="db-empty">
      Chưa có tin tức hôm nay.<br>
      <a href="../killzone/index.html" style="color:var(--accent);text-decoration:underline;font-size:12px">Vào Kill Zone Timer → Thêm tin</a>
    </div>`;
    status.textContent = 'KHÔNG CÓ TIN';
    status.className = 'db-step-status pending';
    body.classList.remove('collapsed');
    return;
  }

  // Filter relevant news
  const relevant = news.filter(n => currencies.has(n.currency));
  const highImpact = relevant.filter(n => n.impact === 'High');

  let html = '';
  if (relevant.length > 0) {
    html += `<div class="db-auto-badge" style="margin-bottom:10px">Auto-fill từ Kill Zone Timer</div>`;
    html += '<div class="db-news-list">';
    relevant.forEach(n => {
      const impClass = n.impact.toLowerCase();
      html += `<div class="db-news-item">
        <div class="db-news-impact ${impClass}"></div>
        <span class="db-news-time">${n.time}</span>
        <span class="db-news-currency">${n.currency}</span>
        <span class="db-news-title">${n.title}</span>
        <span style="margin-left:auto;font-size:10px;font-weight:700;color:${impClass === 'high' ? 'var(--bear)' : impClass === 'medium' ? 'var(--warn)' : 'var(--text-muted)'}">${n.impact.toUpperCase()}</span>
      </div>`;
    });
    html += '</div>';

    if (highImpact.length > 0) {
      html += `<div style="display:flex;align-items:center;gap:4px;margin-top:10px;font-size:12px;color:var(--bear);font-weight:600">${SVG_ICONS.alertTriangle} ${highImpact.length} tin HIGH IMPACT liên quan đến pairs đang trade — cẩn thận spread/volatility.</div>`;
    }
  } else {
    html += `<div style="font-size:12px;color:var(--text-muted)">Có ${news.length} tin hôm nay nhưng không liên quan đến pairs đã chọn.</div>`;
  }

  content.innerHTML = html;
  body.classList.remove('collapsed');

  if (highImpact.length > 0) {
    status.textContent = `${highImpact.length} HIGH IMPACT`;
    status.className = 'db-step-status pending';
  } else {
    status.textContent = relevant.length > 0 ? `${relevant.length} TIN` : 'AN TOÀN';
    status.className = 'db-step-status done';
    document.getElementById('step4').classList.add('completed');
  }
}

// ═══════════════════════════════════════════════════
//  STEP 5: Trader Assessment (Per-Pair Tabs)
// ═══════════════════════════════════════════════════
function getAssessForPair(pair) {
  return assessmentData[pair] || { candle: '', zone: '', pdh: '', pdl: '', asianH: '', asianL: '', notes: '' };
}

function isPairAssessed(pair) {
  const d = assessmentData[pair];
  if (!d) return false;
  return Object.values(d).filter(v => v).length >= 2;
}

function switchAssessTab(pair) {
  // Save current tab data first
  saveCurrentAssessForm();
  currentAssessPair = pair;
  renderStep5Form();
}

function saveCurrentAssessForm() {
  if (!currentAssessPair) return;
  const data = {
    candle: document.getElementById('aCandle')?.value || '',
    zone: document.getElementById('aZone')?.value || '',
    pdh: document.getElementById('aPDH')?.value || '',
    pdl: document.getElementById('aPDL')?.value || '',
    asianH: document.getElementById('aAsianH')?.value || '',
    asianL: document.getElementById('aAsianL')?.value || '',
    notes: document.getElementById('aNotes')?.value || '',
  };
  // Only save if at least something was filled
  if (Object.values(data).some(v => v)) {
    assessmentData[currentAssessPair] = data;
  }
}

function renderStep5() {
  const content = document.getElementById('assessContent');
  const status = document.getElementById('step5Status');
  const body = document.getElementById('step5Body');

  if (!selectedPairs.length) {
    content.innerHTML = '';
    status.textContent = 'CHỜ';
    status.className = 'db-step-status pending';
    document.getElementById('step5').classList.remove('completed');
    body.classList.add('collapsed');
    currentAssessPair = null;
    return;
  }

  // Default to first pair if no tab selected or current tab removed
  if (!currentAssessPair || !selectedPairs.includes(currentAssessPair)) {
    currentAssessPair = selectedPairs[0];
  }

  // Build tabs + form
  const tabsHtml = `<div class="db-assess-tabs">
    ${selectedPairs.map(pair => {
      const active = pair === currentAssessPair ? 'active' : '';
      const filled = isPairAssessed(pair);
      return `<div class="db-assess-tab ${active}" onclick="switchAssessTab('${pair}')">
        ${pair}
        <span class="tab-dot ${filled ? 'filled' : 'empty'}"></span>
      </div>`;
    }).join('')}
  </div>`;

  content.innerHTML = tabsHtml + '<div id="assessFormContainer"></div>';
  body.classList.remove('collapsed');
  renderStep5Form();
  updateStep5Status();
}

function renderStep5Form() {
  const container = document.getElementById('assessFormContainer');
  if (!container || !currentAssessPair) return;
  const d = getAssessForPair(currentAssessPair);

  container.innerHTML = `
    <div class="db-assess-grid">
      <div class="db-assess-field">
        <label>D1 Candle Pattern</label>
        <select id="aCandle" onchange="updateAssessment(); showCandleHint()">
          <option value="">— Chọn mẫu hình —</option>
          <option value="Bullish Engulfing">Bullish Engulfing — Nến tăng nuốt</option>
          <option value="Bearish Engulfing">Bearish Engulfing — Nến giảm nuốt</option>
          <option value="Bullish Pin Bar">Bullish Pin Bar — Nến búa</option>
          <option value="Bearish Pin Bar">Bearish Pin Bar — Nến sao băng</option>
          <option value="Doji / Inside Bar">Doji / Inside Bar — Do dự / Nằm trong</option>
          <option value="Morning Star">Morning Star — Sao mai (3 nến)</option>
          <option value="Evening Star">Evening Star — Sao hôm (3 nến)</option>
          <option value="No Clear Pattern">Không có mẫu hình rõ</option>
        </select>
        <div id="candleHint"></div>
      </div>
      <div class="db-assess-field">
        <label>Current Price Zone</label>
        <select id="aZone" onchange="updateAssessment(); showZoneHint()">
          <option value="">— Chọn vùng giá —</option>
          <option value="Premium (above EQ)">Premium — Giá đang ở vùng đắt</option>
          <option value="Equilibrium">Equilibrium — Vùng cân bằng</option>
          <option value="Discount (below EQ)">Discount — Giá đang ở vùng rẻ</option>
        </select>
        <div id="zoneHint"></div>
      </div>
      <div class="db-assess-field">
        <label>PDH (Đỉnh ngày hôm qua)</label>
        <input type="text" id="aPDH" placeholder="1.0890" autocomplete="off" onchange="updateAssessment()">
      </div>
      <div class="db-assess-field">
        <label>PDL (Đáy ngày hôm qua)</label>
        <input type="text" id="aPDL" placeholder="1.0820" autocomplete="off" onchange="updateAssessment()">
      </div>
      <div class="db-assess-field">
        <label>Asian High (Biên trên phiên Á)</label>
        <input type="text" id="aAsianH" placeholder="—" autocomplete="off" onchange="updateAssessment()">
      </div>
      <div class="db-assess-field">
        <label>Asian Low (Biên dưới phiên Á)</label>
        <input type="text" id="aAsianL" placeholder="—" autocomplete="off" onchange="updateAssessment()">
      </div>
      <div class="db-assess-field full">
        <label>Ghi chú (Structure, key levels, OB/FVG...)</label>
        <textarea id="aNotes" placeholder="VD: D1 vừa sweep PDH, đang pullback về OB H4..." onchange="updateAssessment()"></textarea>
      </div>
    </div>`;

  // Restore values for the active pair
  if (d.candle) document.getElementById('aCandle').value = d.candle;
  if (d.zone) document.getElementById('aZone').value = d.zone;
  if (d.pdh) document.getElementById('aPDH').value = d.pdh;
  if (d.pdl) document.getElementById('aPDL').value = d.pdl;
  if (d.asianH) document.getElementById('aAsianH').value = d.asianH;
  if (d.asianL) document.getElementById('aAsianL').value = d.asianL;
  if (d.notes) document.getElementById('aNotes').value = d.notes;
  showCandleHint();
  showZoneHint();

  // Update tab active state
  document.querySelectorAll('.db-assess-tab').forEach(tab => {
    tab.classList.toggle('active', tab.textContent.trim().startsWith(currentAssessPair));
  });
}

function updateAssessment() {
  if (!currentAssessPair) return;
  assessmentData[currentAssessPair] = {
    candle: document.getElementById('aCandle')?.value || '',
    zone: document.getElementById('aZone')?.value || '',
    pdh: document.getElementById('aPDH')?.value || '',
    pdl: document.getElementById('aPDL')?.value || '',
    asianH: document.getElementById('aAsianH')?.value || '',
    asianL: document.getElementById('aAsianL')?.value || '',
    notes: document.getElementById('aNotes')?.value || '',
  };

  // Update tab dot indicator
  document.querySelectorAll('.db-assess-tab').forEach(tab => {
    const pairName = tab.textContent.trim().split('\n')[0].trim();
    const dot = tab.querySelector('.tab-dot');
    if (dot) {
      dot.className = 'tab-dot ' + (isPairAssessed(pairName) ? 'filled' : 'empty');
    }
  });

  updateStep5Status();
  // Re-render Step 6 so source chips reflect updated assessment data
  renderStep6();
}

function updateStep5Status() {
  const status = document.getElementById('step5Status');
  const assessedCount = selectedPairs.filter(p => isPairAssessed(p)).length;
  if (assessedCount > 0) {
    status.textContent = `${assessedCount}/${selectedPairs.length} DONE`;
    status.className = 'db-step-status done';
    document.getElementById('step5').classList.add('completed');
  } else {
    status.textContent = 'NHẬP LIỆU';
    status.className = 'db-step-status pending';
  }
}

// ── Hint helpers ──
// SVG candle drawing helpers
function svgCandle(x, color, wickTop, bodyTop, bodyBot, wickBot, w=12) {
  const fill = color === 'bull' ? '#5CC8A0' : color === 'bear' ? '#E05C5C' : '#8899BB';
  const wc = color === 'bull' ? '#5CC8A0' : color === 'bear' ? '#E05C5C' : '#8899BB';
  return `<line x1="${x+w/2}" y1="${wickTop}" x2="${x+w/2}" y2="${wickBot}" stroke="${wc}" stroke-width="1.5"/>` +
         `<rect x="${x}" y="${bodyTop}" width="${w}" height="${Math.max(2, bodyBot-bodyTop)}" rx="1" fill="${fill}" stroke="${wc}" stroke-width="0.5"/>`;
}

const CANDLE_SVGS = {
  'Bullish Engulfing': `<svg width="56" height="56" viewBox="0 0 56 56">
    ${svgCandle(10, 'bear', 10, 18, 36, 42, 10)}
    ${svgCandle(26, 'bull', 6, 12, 44, 50, 16)}
    <text x="28" y="55" fill="#5CC8A0" font-size="7" text-anchor="middle">↑</text>
  </svg>`,
  'Bearish Engulfing': `<svg width="56" height="56" viewBox="0 0 56 56">
    ${svgCandle(10, 'bull', 10, 18, 36, 42, 10)}
    ${svgCandle(26, 'bear', 6, 12, 44, 50, 16)}
    <text x="28" y="55" fill="#E05C5C" font-size="7" text-anchor="middle">↓</text>
  </svg>`,
  'Bullish Pin Bar': `<svg width="36" height="56" viewBox="0 0 36 56">
    ${svgCandle(10, 'bull', 8, 12, 20, 50, 14)}
    <text x="18" y="55" fill="#5CC8A0" font-size="7" text-anchor="middle">↑</text>
  </svg>`,
  'Bearish Pin Bar': `<svg width="36" height="56" viewBox="0 0 36 56">
    ${svgCandle(10, 'bear', 6, 36, 44, 48, 14)}
    <text x="18" y="55" fill="#E05C5C" font-size="7" text-anchor="middle">↓</text>
  </svg>`,
  'Doji / Inside Bar': `<svg width="56" height="56" viewBox="0 0 56 56">
    ${svgCandle(6, 'bear', 8, 16, 40, 48, 14)}
    ${svgCandle(26, 'neutral', 18, 26, 30, 38, 14)}
    <text x="28" y="55" fill="#8899BB" font-size="7" text-anchor="middle">?</text>
  </svg>`,
  'Morning Star': `<svg width="72" height="56" viewBox="0 0 72 56">
    ${svgCandle(4, 'bear', 8, 14, 40, 46, 12)}
    ${svgCandle(24, 'neutral', 36, 38, 44, 48, 10)}
    ${svgCandle(42, 'bull', 6, 12, 38, 44, 12)}
    <text x="36" y="55" fill="#5CC8A0" font-size="7" text-anchor="middle">↑↑</text>
  </svg>`,
  'Evening Star': `<svg width="72" height="56" viewBox="0 0 72 56">
    ${svgCandle(4, 'bull', 10, 16, 42, 48, 12)}
    ${svgCandle(24, 'neutral', 6, 8, 14, 18, 10)}
    ${svgCandle(42, 'bear', 8, 14, 40, 46, 12)}
    <text x="36" y="55" fill="#E05C5C" font-size="7" text-anchor="middle">↓↓</text>
  </svg>`,
  'No Clear Pattern': `<svg width="36" height="56" viewBox="0 0 36 56">
    <text x="18" y="32" fill="#8899BB" font-size="18" text-anchor="middle">?</text>
  </svg>`,
};

const CANDLE_HINTS = {
  'Bullish Engulfing': {
    desc: 'Nến xanh lớn "nuốt" hoàn toàn thân nến đỏ nhỏ trước đó. Xuất hiện ở đáy → phe mua đã chiếm quyền kiểm soát.',
    bias: 'bull', biasText: 'BULLISH'
  },
  'Bearish Engulfing': {
    desc: 'Nến đỏ lớn "nuốt" hoàn toàn thân nến xanh nhỏ trước đó. Xuất hiện ở đỉnh → phe bán đã chiếm quyền kiểm soát.',
    bias: 'bear', biasText: 'BEARISH'
  },
  'Bullish Pin Bar': {
    desc: 'Nến búa: Bóng dưới rất dài (≥2x thân), thân nhỏ nằm trên. Phe mua từ chối giá thấp, "đánh lên" mạnh.',
    bias: 'bull', biasText: 'BULLISH'
  },
  'Bearish Pin Bar': {
    desc: 'Nến sao băng: Bóng trên rất dài (≥2x thân), thân nhỏ nằm dưới. Phe bán từ chối giá cao, "đè xuống" mạnh.',
    bias: 'bear', biasText: 'BEARISH'
  },
  'Doji / Inside Bar': {
    desc: 'Doji: Thân rất nhỏ (mở = đóng). Inside Bar: Nến nằm gọn trong range nến trước. Thị trường do dự → chờ breakout.',
    bias: 'neutral', biasText: 'TRUNG LẬP — CHỜ'
  },
  'Morning Star': {
    desc: 'Tổ hợp 3 nến ở đáy: ①Nến đỏ dài → ②Nến nhỏ (do dự) → ③Nến xanh dài vượt 50% nến ①. Đảo chiều tăng rất mạnh.',
    bias: 'bull', biasText: 'BULLISH MẠNH'
  },
  'Evening Star': {
    desc: 'Tổ hợp 3 nến ở đỉnh: ①Nến xanh dài → ②Nến nhỏ (do dự) → ③Nến đỏ dài vượt 50% nến ①. Đảo chiều giảm rất mạnh.',
    bias: 'bear', biasText: 'BEARISH MẠNH'
  },
  'No Clear Pattern': {
    desc: 'Không nhận diện được mẫu hình nến rõ ràng trên D1. Nên chờ thêm một phiên, hoặc giảm size nếu vẫn quyết định vào lệnh.',
    bias: 'neutral', biasText: 'KHÔNG RÕ'
  },
};

const ZONE_HINTS = {
  'Premium (above EQ)': {
    desc: 'Giá đang nằm trên vùng cân bằng (50% range). Đây là vùng đắt → lý tưởng để tìm kèo SHORT. Nếu bạn muốn LONG ở vùng này thì cần xác nhận rất mạnh.',
    bias: 'bear', biasText: 'ƯU TIÊN SHORT'
  },
  'Equilibrium': {
    desc: 'Giá đang ở vùng cân bằng (gần 50% range). Không rõ ưu thế bên nào. Chờ giá di chuyển về Premium hoặc Discount.',
    bias: 'neutral', biasText: 'CHỜ RÕ HƠN'
  },
  'Discount (below EQ)': {
    desc: 'Giá đang nằm dưới vùng cân bằng. Đây là vùng rẻ → lý tưởng để tìm kèo LONG. Nếu bạn muốn SHORT ở vùng này thì cần xác nhận rất mạnh.',
    bias: 'bull', biasText: 'ƯU TIÊN LONG'
  },
};

function showCandleHint() {
  const el = document.getElementById('candleHint');
  if (!el) return;
  const val = document.getElementById('aCandle')?.value;
  const h = CANDLE_HINTS[val];
  const svg = CANDLE_SVGS[val];
  if (!h) { el.innerHTML = ''; return; }
  el.innerHTML = `<div class="db-assess-hint" style="display:flex;align-items:flex-start;gap:10px;">
    ${svg ? `<div style="flex-shrink:0;background:rgba(0,0,0,0.3);border-radius:4px;padding:4px;display:flex;align-items:center;justify-content:center">${svg}</div>` : ''}
    <div>${h.desc}<br><span class="hint-bias ${h.bias}">${h.biasText}</span></div>
  </div>`;
}

function showZoneHint() {
  const el = document.getElementById('zoneHint');
  if (!el) return;
  const val = document.getElementById('aZone')?.value;
  const h = ZONE_HINTS[val];
  if (!h) { el.innerHTML = ''; return; }
  el.innerHTML = `<div class="db-assess-hint">${h.desc}<br><span class="hint-bias ${h.bias}">${h.biasText}</span></div>`;
}

// ═══════════════════════════════════════════════════
//  STEP 6: Final Bias & Confidence
// ═══════════════════════════════════════════════════

// Helper: compute source biases for a given pair
function getSourceBiases(pair) {
  const [base, quote] = pair.split('/');
  const sources = {};

  // 1. COT
  const weeklyBias = Store.get('nexus_weekly_bias');
  if (weeklyBias && weeklyBias.pairs) {
    const baseCot = weeklyBias.pairs.find(p => p.pair === base);
    const quoteCot = weeklyBias.pairs.find(p => p.pair === quote);
    if (baseCot && quoteCot) {
      if (baseCot.cotIndex >= 60 && quoteCot.cotIndex <= 40) sources.cot = 'LONG';
      else if (baseCot.cotIndex <= 40 && quoteCot.cotIndex >= 60) sources.cot = 'SHORT';
      else sources.cot = 'NEUTRAL';
    } else {
      sources.cot = null;
    }
  } else {
    sources.cot = null;
  }

  // 2. Rate spread
  const rates = getRates();
  const baseRate = (rates[base] || { rate: 0 }).rate;
  const quoteRate = (rates[quote] || { rate: 0 }).rate;
  const spread = baseRate - quoteRate;
  if (spread > 0.5) sources.rate = 'LONG';
  else if (spread < -0.5) sources.rate = 'SHORT';
  else sources.rate = 'NEUTRAL';

  // 3. Candle
  const pairAssess = assessmentData[pair] || {};
  const bullishCandles = ['Bullish Engulfing', 'Bullish Pin Bar', 'Morning Star'];
  const bearishCandles = ['Bearish Engulfing', 'Bearish Pin Bar', 'Evening Star'];
  if (pairAssess.candle) {
    if (bullishCandles.includes(pairAssess.candle)) sources.candle = 'LONG';
    else if (bearishCandles.includes(pairAssess.candle)) sources.candle = 'SHORT';
    else sources.candle = 'NEUTRAL';
  } else {
    sources.candle = null;
  }

  // 4. Zone
  if (pairAssess.zone) {
    if (pairAssess.zone.includes('Discount')) sources.zone = 'LONG';
    else if (pairAssess.zone.includes('Premium')) sources.zone = 'SHORT';
    else sources.zone = 'NEUTRAL';
  } else {
    sources.zone = null;
  }

  return sources;
}

// Helper: compute per-pair confidence score
function calcPairConfidence(pair) {
  const bias = finalBiases[pair];
  if (!bias) return 0;
  const [base, quote] = pair.split('/');
  const src = getSourceBiases(pair);
  let conf = 0;

  // COT (30%)
  if (src.cot !== null) {
    if (src.cot === bias) conf += 30;
    else if (src.cot !== 'NEUTRAL' && src.cot !== bias) conf -= 10;
  }

  // Rate (25%)
  if (src.rate === bias) conf += 25;
  else if (src.rate !== 'NEUTRAL' && src.rate !== bias) conf -= 5;

  // Candle (20%)
  if (src.candle !== null) {
    if (src.candle === bias) conf += 20;
  }

  // Zone (15%)
  if (src.zone !== null) {
    if (src.zone === bias) conf += 15;
    else if (src.zone !== 'NEUTRAL' && src.zone !== bias) conf -= 5;
  }

  // News (10%)
  const today = new Date().toISOString().split('T')[0];
  const newsDate = localStorage.getItem('nexus_killzone_news_date');
  let news = [];
  if (newsDate === today) {
    try { news = JSON.parse(localStorage.getItem('nexus_killzone_news') || '[]'); } catch(e) {}
  }
  const highImpact = news.filter(n => n.impact === 'High' && (n.currency === base || n.currency === quote));
  if (highImpact.length === 0) conf += 10;
  else conf -= 5;

  return Math.max(0, Math.min(100, conf));
}

function renderStep6() {
  // Capture any unsaved Step 5 form data before computing sources
  saveCurrentAssessForm();

  const content = document.getElementById('finalBiasContent');
  const body = document.getElementById('step6Body');

  if (!selectedPairs.length) {
    content.innerHTML = '';
    document.getElementById('step6Status').textContent = 'CHỜ';
    document.getElementById('step6Status').className = 'db-step-status pending';
    document.getElementById('step6').classList.remove('completed');
    body.classList.add('collapsed');
    document.getElementById('confidenceSection').style.display = 'none';
    return;
  }

  const arrowUp = `<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M8 13V3M4 6l4-3.5L12 6"/></svg>`;
  const arrowDown = `<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M8 3v10M4 10l4 3.5 4-3.5"/></svg>`;
  const arrowSide = `<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 8h10M10 5l3 3-3 3"/></svg>`;

  const cards = selectedPairs.map(pair => {
    const currentBias = finalBiases[pair] || '';
    const biasClass = currentBias ? `bias-${currentBias.toLowerCase()}` : '';
    const src = getSourceBiases(pair);
    const pairConf = currentBias ? calcPairConfidence(pair) : 0;

    // Source signal chips
    const srcEntries = [
      { key: 'COT', val: src.cot },
      { key: 'Rate', val: src.rate },
      { key: 'Candle', val: src.candle },
      { key: 'Zone', val: src.zone },
    ];
    const sourceChips = srcEntries.map(s => {
      const cls = s.val === null ? 'src-none'
                : s.val === 'LONG' ? 'src-long'
                : s.val === 'SHORT' ? 'src-short'
                : 'src-neutral';
      const label = s.val === null ? '—'
                  : s.val === 'LONG' ? '↑'
                  : s.val === 'SHORT' ? '↓'
                  : '○';
      return `<span class="db-source-chip ${cls}"><span class="src-dot"></span>${s.key} ${label}</span>`;
    }).join('');

    // Badge for selected bias
    let badgeHtml = '';
    if (currentBias) {
      const bc = currentBias === 'LONG' ? 'color:var(--bull);background:var(--bull-dim)'
               : currentBias === 'SHORT' ? 'color:var(--bear);background:var(--bear-dim)'
               : 'color:var(--neutral);background:rgba(136,153,187,0.08)';
      badgeHtml = `<span class="db-final-badge" style="${bc}">${currentBias}</span>`;
    }

    // Per-pair confidence bar
    const confColor = pairConf >= 70 ? 'var(--bull)' : pairConf >= 40 ? 'var(--warn)' : 'var(--bear)';
    const confGrad = pairConf >= 70 ? 'linear-gradient(90deg, var(--bull), #3dffc8)'
                   : pairConf >= 40 ? 'linear-gradient(90deg, var(--warn), var(--accent))'
                   : 'linear-gradient(90deg, var(--bear), var(--warn))';
    const confBarHtml = currentBias ? `<div class="db-pair-conf">
      <div class="db-pair-conf-bar"><div class="db-pair-conf-fill" style="width:${pairConf}%;background:${confGrad}"></div></div>
      <span class="db-pair-conf-pct" style="color:${confColor}">${pairConf}%</span>
    </div>` : '';

    return `<div class="db-final-card ${biasClass}">
      <div class="db-final-head">
        <div class="db-final-pair">${pair}</div>
        ${badgeHtml}
      </div>
      <div class="db-final-sources">${sourceChips}</div>
      <div class="db-bias-btns">
        <button class="db-bias-btn long ${currentBias === 'LONG' ? 'selected' : ''}" onclick="setBias('${pair}','LONG')">${arrowUp} Long</button>
        <button class="db-bias-btn neutral ${currentBias === 'NEUTRAL' ? 'selected' : ''}" onclick="setBias('${pair}','NEUTRAL')">${arrowSide} Neutral</button>
        <button class="db-bias-btn short ${currentBias === 'SHORT' ? 'selected' : ''}" onclick="setBias('${pair}','SHORT')">${arrowDown} Short</button>
      </div>
      ${confBarHtml}
    </div>`;
  });

  content.innerHTML = `<div class="db-final-grid">${cards.join('')}</div>`;
  body.classList.remove('collapsed');

  updateConfidence();
}

function setBias(pair, bias) {
  finalBiases[pair] = bias;
  renderStep6();
}

function updateConfidence() {
  const status = document.getElementById('step6Status');
  const confSection = document.getElementById('confidenceSection');

  const biasCount = selectedPairs.filter(p => finalBiases[p]).length;
  if (biasCount === 0) {
    status.textContent = 'CHỌN BIAS';
    status.className = 'db-step-status pending';
    confSection.style.display = 'none';
    return;
  }

  // Calculate average confidence
  let totalConf = 0;
  let pairsWithBias = 0;

  selectedPairs.forEach(pair => {
    if (!finalBiases[pair]) return;
    pairsWithBias++;
    totalConf += calcPairConfidence(pair);
  });

  const avgConf = pairsWithBias > 0 ? Math.round(totalConf / pairsWithBias) : 0;

  // Determine tier
  let tierText, tierColor, barGrad;
  if (avgConf >= 70) {
    tierText = 'HIGH'; tierColor = 'var(--bull)';
    barGrad = 'linear-gradient(90deg, var(--bull), #3dffc8)';
  } else if (avgConf >= 40) {
    tierText = 'MEDIUM'; tierColor = 'var(--accent)';
    barGrad = 'linear-gradient(90deg, var(--warn), var(--accent))';
  } else {
    tierText = 'LOW'; tierColor = 'var(--bear)';
    barGrad = 'linear-gradient(90deg, var(--bear), var(--warn))';
  }

  // Render confidence overview
  confSection.style.display = '';

  const pctEl = document.getElementById('confPct');
  const tierEl = document.getElementById('confTier');
  const fill = document.getElementById('confFill');
  const label = document.getElementById('confLabel');
  const breakdown = document.getElementById('confBreakdown');

  pctEl.textContent = avgConf + '%';
  pctEl.style.color = tierColor;
  tierEl.textContent = tierText;
  tierEl.style.color = tierColor;

  fill.style.width = avgConf + '%';
  fill.style.background = barGrad;
  label.textContent = tierText;
  label.style.color = tierColor;

  // Source alignment breakdown
  let aligned = 0, misaligned = 0, partial = 0;
  selectedPairs.forEach(pair => {
    if (!finalBiases[pair]) return;
    const src = getSourceBiases(pair);
    const bias = finalBiases[pair];
    ['cot', 'rate', 'candle', 'zone'].forEach(k => {
      if (src[k] === null) return;
      if (src[k] === bias) aligned++;
      else if (src[k] !== 'NEUTRAL' && src[k] !== bias) misaligned++;
      else partial++;
    });
  });
  breakdown.innerHTML = `
    <span class="db-conf-src aligned"><span class="csrc-dot"></span>${aligned} aligned</span>
    <span class="db-conf-src partial"><span class="csrc-dot"></span>${partial} neutral</span>
    <span class="db-conf-src misaligned"><span class="csrc-dot"></span>${misaligned} conflict</span>
    <span style="font-size:11px;color:var(--text-muted);margin-left:auto">${biasCount}/${selectedPairs.length} pairs set</span>
  `;

  status.textContent = `${avgConf}% — ${tierText}`;
  status.className = avgConf >= 70 ? 'db-step-status done' : 'db-step-status pending';
  if (biasCount >= selectedPairs.length) {
    document.getElementById('step6').classList.add('completed');
  }
}

// ═══════════════════════════════════════════════════
//  TOGGLE / UI
// ═══════════════════════════════════════════════════
function toggleStep(num) {
  const body = document.getElementById(`step${num}Body`);
  body.classList.toggle('collapsed');
}

// ═══════════════════════════════════════════════════
//  SAVE DAILY BIAS
// ═══════════════════════════════════════════════════
function saveDailyBias() {
  if (!selectedPairs.length || !Object.keys(finalBiases).length) {
    showToast('Chưa có bias để lưu', 'warn');
    return;
  }

  const today = new Date().toISOString().split('T')[0];
  const entry = {
    date: today,
    dateDisplay: new Date().toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }),
    pairs: selectedPairs.map(p => ({
      pair: p,
      bias: finalBiases[p] || 'NEUTRAL',
      cotBias: cotBiasData[p] || null,
    })),
    assessment: assessmentData,
    confidence: parseInt(document.getElementById('confLabel')?.textContent === 'HIGH' ? 80 :
                         document.getElementById('confLabel')?.textContent === 'MEDIUM' ? 55 : 30),
    savedAt: new Date().toISOString(),
  };

  // Load existing history
  let history = Store.get('nexus_daily_bias') || [];
  // Replace today's entry if exists
  const existingIdx = history.findIndex(h => h.date === today);
  if (existingIdx >= 0) history[existingIdx] = entry;
  else history.unshift(entry);

  // Keep last 30 days
  if (history.length > 30) history.length = 30;

  Store.set('nexus_daily_bias', history);

  showToast(`${SVG_ICONS.check} Đã lưu Daily Bias — ${selectedPairs.length} pairs`);
  document.getElementById('saveStatus').textContent = `Saved ${new Date().toLocaleTimeString('vi-VN', {hour:'2-digit',minute:'2-digit'})}`;
  renderHistory();
}

// ═══════════════════════════════════════════════════
//  RESET
// ═══════════════════════════════════════════════════
function resetAll() {
  if (!confirm('Reset tất cả selections?')) return;
  selectedPairs = [];
  cotBiasData = {};
  finalBiases = {};
  assessmentData = {};

  // Reset all step states
  for (let i = 1; i <= 6; i++) {
    const step = document.getElementById(`step${i}`);
    step.classList.remove('completed', 'active');
    const body = document.getElementById(`step${i}Body`);
    body.classList.add('collapsed');
  }
  document.getElementById('step1').classList.add('active');
  document.getElementById('step1Body').classList.remove('collapsed');

  renderStep1();
  ['cotBiasContent','rateContent','newsRiskContent','assessContent','finalBiasContent'].forEach(id => {
    document.getElementById(id).innerHTML = '';
  });
  document.getElementById('confidenceSection').style.display = 'none';

  // Reset statuses
  for (let i = 2; i <= 6; i++) {
    document.getElementById(`step${i}Status`).textContent = 'CHỜ';
    document.getElementById(`step${i}Status`).className = 'db-step-status pending';
  }
  updateStep1Status();
}

// ═══════════════════════════════════════════════════
//  HISTORY
// ═══════════════════════════════════════════════════
function renderHistory() {
  const container = document.getElementById('biasHistory');
  const history = Store.get('nexus_daily_bias') || [];

  if (!history.length) {
    container.innerHTML = '<div class="db-empty">Chưa có lịch sử. Hoàn thành 6 bước và bấm "Lưu Daily Bias".</div>';
    return;
  }

  container.innerHTML = history.slice(0, 10).map(h => {
    const confColor = h.confidence >= 70 ? 'var(--bull)' : h.confidence >= 40 ? 'var(--accent)' : 'var(--bear)';
    const confLabel = h.confidence >= 70 ? 'HIGH' : h.confidence >= 40 ? 'MED' : 'LOW';

    return `<div class="db-history-item">
      <div class="db-history-head">
        <span class="db-history-date">${h.dateDisplay || h.date}</span>
        <span class="db-history-conf" style="color:${confColor}">${confLabel} (${h.confidence || 0}%)</span>
      </div>
      <div class="db-history-pairs">
        ${h.pairs.map(p => {
          const biasColor = p.bias === 'LONG' ? 'var(--bull)' : p.bias === 'SHORT' ? 'var(--bear)' : 'var(--text-muted)';
          const biasBg = p.bias === 'LONG' ? 'var(--bull-dim)' : p.bias === 'SHORT' ? 'var(--bear-dim)' : 'var(--bg-hover)';
          return `<span class="db-history-bias" style="color:${biasColor};background:${biasBg}">${p.pair} ${p.bias}</span>`;
        }).join('')}
      </div>
    </div>`;
  }).join('');
}

// ═══════════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════════
// Set date
const now = new Date();
const days = ['Chủ nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];
document.getElementById('todayDate').textContent =
  `${days[now.getDay()]}, ${now.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;

// Check if today's bias already saved → load it
const todayStr = now.toISOString().split('T')[0];
const savedHistory = Store.get('nexus_daily_bias') || [];
const todayEntry = savedHistory.find(h => h.date === todayStr);

if (todayEntry) {
  // Restore selections
  selectedPairs = todayEntry.pairs.map(p => p.pair);
  todayEntry.pairs.forEach(p => { finalBiases[p.pair] = p.bias; });
  if (todayEntry.assessment) {
    // Backward compat: old format was flat { candle, zone, ... }, new is per-pair
    const a = todayEntry.assessment;
    if (a && typeof a === 'object' && !a.candle && !a.zone) {
      // Already per-pair format
      assessmentData = a;
    } else if (a && (a.candle || a.zone)) {
      // Old flat format → assign to all pairs
      todayEntry.pairs.forEach(p => { assessmentData[p.pair] = { ...a }; });
    }
  }
} else {
  // New day — user selects pairs manually
  // Recommended pairs are still visually highlighted in Step 1
}

renderStep1();
if (selectedPairs.length > 0) {
  renderStep2();
  renderStep3();
  renderStep4();
  renderStep5();
  renderStep6();
}
renderHistory();
</script>
</body>
</html>
