<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUS — COT Dashboard</title>
<meta name="description" content="NEXUS COT Dashboard — COT Index 52 tuần, Matrix 8 cặp tiền, Ranking, Pair Strength Grid, Signals tự động.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../shared/style.css">
<style>
  /* ── COT-specific aliases → Design System tokens ── */
  /* This bridges local var names used throughout JS templates */
  :root {
    --bg: var(--bg-primary);
    --surface: var(--bg-surface);
    --text: var(--text-primary);
    --muted: var(--text-secondary);
    --red: var(--bear);
    --green: var(--bull);
    --yellow: var(--warn);
    /* --border, --border-bright, --accent, --neutral already match shared/style.css */
  }


  /* Tabs */
  .tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 0; }
  .tab-btn {
    font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700;
    letter-spacing: 0.12em; text-transform: uppercase;
    padding: 10px 20px; background: none; border: none;
    color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent;
    margin-bottom: -1px; transition: color 0.2s, border-color 0.2s;
  }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-btn:hover:not(.active) { color: var(--text); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* Grid */
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 24px; }
  .card-label { font-size: 12px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 14px; }

  .field { display: flex; flex-direction: column; gap: 5px; }
  label { font-size: 13px; color: var(--muted); letter-spacing: 0.08em; }

  input[type="text"], select {
    background: var(--bg); border: 1px solid var(--border-bright);
    color: var(--text); font-family: 'Space Mono', monospace;
    font-size: 16px; padding: 11px 14px; border-radius: 2px;
    outline: none; transition: border-color 0.2s; width: 100%;
  }
  input[type="text"]:focus, select:focus { border-color: var(--accent); }
  input[type="text"].input-error { border-color: var(--red); background: rgba(224,92,92,0.05); }
  .input-hint { font-size: 12px; color: var(--muted); margin-top: 2px; letter-spacing: 0.03em; }
  .input-hint.ok { color: var(--green); }
  .input-hint.error { color: var(--red); }

  .btn-calc {
    width: 100%; background: var(--accent); color: #0a0c0f;
    border: none; font-family: 'Syne', sans-serif; font-weight: 700;
    font-size: 14px; letter-spacing: 0.1em; text-transform: uppercase;
    padding: 13px; border-radius: 2px; cursor: pointer; margin-top: 4px;
    transition: opacity 0.2s, transform 0.1s;
  }
  .btn-calc:hover { opacity: 0.85; }
  .btn-calc:active { transform: scale(0.99); }





  .btn-row { display: flex; gap: 8px; margin-top: 12px; }
  .btn-sm {
    background: none; border: 1px solid var(--border-bright); color: var(--muted);
    font-family: 'Space Mono', monospace; font-size: 12px; letter-spacing: 0.06em;
    padding: 5px 10px; border-radius: 2px; cursor: pointer;
    transition: color 0.2s, border-color 0.2s;
  }
  .btn-sm:hover { color: var(--text); border-color: var(--muted); }
  .btn-sm.accent-btn { border-color: var(--accent); color: var(--accent); }
  .btn-sm.accent-btn:hover { background: rgba(200,169,110,0.1); }

  /* Reference table */
  .ref-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 16px; }
  .ref-title { padding: 12px 18px; font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { padding: 10px 16px; text-align: left; font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); border-bottom: 1px solid var(--border); font-weight: 400; white-space: nowrap; }
  td { padding: 11px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  .zone-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 7px; vertical-align: middle; }
  .action-note { color: var(--muted); font-size: 12px; }

  /* ── COT MATRIX ─────────────────────────────────────── */
  .matrix-container { display: none; }
  .matrix-container.show { display: block; }

  .matrix-header-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 16px; flex-wrap: wrap; gap: 10px;
  }
  .matrix-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 800; letter-spacing: 0.05em; }
  .matrix-week { font-size: 12px; color: var(--muted); letter-spacing: 0.08em; }

  .matrix-table-wrap { overflow-x: auto; margin-bottom: 16px; }
  .matrix-table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 700px; }
  .matrix-table th { padding: 11px 14px; text-align: left; font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); border-bottom: 2px solid var(--border-bright); font-weight: 400; white-space: nowrap; }
  .matrix-table td { padding: 12px 14px; border-bottom: 1px solid var(--border); vertical-align: middle; white-space: nowrap; }
  .matrix-table tr:last-child td { border-bottom: none; }
  .matrix-table tr:hover td { background: rgba(255,255,255,0.02); }
  .pair-tag { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; }
  .trend-up { color: var(--green); }
  .trend-dn { color: var(--red); }
  .trend-flat { color: var(--muted); }

  .cot-bar-wrap { display: flex; align-items: center; gap: 8px; }
  .cot-bar-track { width: 100%; height: 4px; background: var(--border-bright); border-radius: 2px; flex-shrink: 0; }
  .cot-bar-fill { height: 100%; border-radius: 2px; transition: width 0.4s; }
  .cot-val { font-weight: 700; min-width: 38px; text-align: right; font-size: 14px; }

  /* Ranking */
  .ranking-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 20px; margin-bottom: 16px; }
  .ranking-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 14px; }
  .ranking-list { display: flex; flex-direction: column; gap: 6px; }
  .ranking-item { display: flex; align-items: center; gap: 10px; }
  .rank-num { width: 24px; font-size: 12px; color: var(--muted); flex-shrink: 0; }
  .rank-pair { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; width: 48px; flex-shrink: 0; }
  .rank-bar-track { flex: 1; height: 4px; background: var(--border-bright); border-radius: 2px; }
  .rank-bar-fill { height: 100%; border-radius: 2px; }
  .rank-idx { font-size: 13px; font-weight: 700; width: 42px; text-align: right; flex-shrink: 0; }
  .rank-label { font-size: 11px; color: var(--muted); width: 85px; flex-shrink: 0; text-align: right; }

  /* Best pairs */
  .pairs-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 20px; margin-bottom: 16px; }
  .pairs-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 14px; }
  .pairs-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
  @media (max-width: 600px) { .pairs-grid { grid-template-columns: 1fr; } }
  .pairs-section-label { font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 8px; }
  .pair-chip { display: inline-block; padding: 3px 8px; border-radius: 2px; font-size: 13px; font-weight: 700; margin: 2px 2px; letter-spacing: 0.03em; }


  /* ── GITHUB CONFIG BANNER ─────────────────────────── */
  .gh-config-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 4px;
    padding: 20px; margin-bottom: 16px; transition: all 0.3s;
  }
  .gh-config-card.collapsed { padding: 10px 20px; }
  .gh-config-header {
    display: flex; align-items: center; justify-content: space-between;
    gap: 10px; flex-wrap: wrap;
  }
  .gh-config-title {
    font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700;
    letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted);
  }
  .gh-config-title .gh-icon { color: var(--accent); margin-right: 6px; }
  .gh-config-body { margin-top: 14px; }
  .gh-config-body.hidden { display: none; }
  .gh-config-row {
    display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px;
    align-items: end;
  }
  @media (max-width: 600px) { .gh-config-row { grid-template-columns: 1fr; } }
  .gh-config-row .field label { font-size: 12px; }
  .gh-config-row input { font-size: 14px; padding: 8px 10px; }
  .gh-status-row {
    display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
  }
  .gh-status-text {
    font-size: 12px; color: var(--muted); letter-spacing: 0.04em;
  }
  .gh-status-text .gh-repo-link {
    color: var(--accent); font-weight: 700; text-decoration: none;
  }
  .gh-status-text .gh-repo-link:hover { text-decoration: underline; }
  .btn-gh-save {
    background: var(--accent); color: #0a0c0f; border: none;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 12px;
    letter-spacing: 0.1em; text-transform: uppercase;
    padding: 8px 16px; border-radius: 2px; cursor: pointer;
    transition: opacity 0.2s; white-space: nowrap;
  }
  .btn-gh-save:hover { opacity: 0.85; }
  .btn-gh-edit {
    background: none; border: 1px solid var(--border-bright); color: var(--muted);
    font-family: 'Space Mono', monospace; font-size: 11px; letter-spacing: 0.06em;
    padding: 4px 10px; border-radius: 2px; cursor: pointer;
    transition: color 0.15s, border-color 0.15s; white-space: nowrap;
  }
  .btn-gh-edit:hover { color: var(--text); border-color: var(--muted); }

  /* ── FETCH CFTC BUTTON ──────────────────────────────── */
  .gh-fetch-row {
    display: flex; align-items: center; gap: 10px; margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .btn-fetch-cftc {
    background: var(--green); color: #0a0c0f; border: none;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 13px;
    letter-spacing: 0.08em; text-transform: uppercase;
    padding: 10px 20px; border-radius: 2px; cursor: pointer;
    transition: opacity 0.2s, background 0.3s, transform 0.1s;
    display: inline-flex; align-items: center; gap: 8px;
    position: relative; overflow: hidden;
  }
  .btn-fetch-cftc:hover:not(:disabled) { opacity: 0.88; }
  .btn-fetch-cftc:active:not(:disabled) { transform: scale(0.98); }
  .btn-fetch-cftc:disabled { opacity: 0.35; cursor: not-allowed; }
  .btn-fetch-cftc.loading { background: var(--accent); pointer-events: none; }
  .btn-fetch-cftc.success {
    background: var(--green);
    animation: flash-green 0.6s ease;
  }
  .btn-fetch-cftc.error { background: var(--red); }
  @keyframes flash-green {
    0%   { box-shadow: 0 0 0 0 rgba(92,200,160,0.5); }
    50%  { box-shadow: 0 0 16px 4px rgba(92,200,160,0.3); }
    100% { box-shadow: none; }
  }
  .fetch-spinner {
    display: inline-block; width: 14px; height: 14px;
    border: 2px solid rgba(0,0,0,0.2); border-top-color: #0a0c0f;
    border-radius: 50%; animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .fetch-status {
    font-size: 12px; color: var(--muted); letter-spacing: 0.04em;
    line-height: 1.5;
  }
  .fetch-status.error { color: var(--red); }
  .fetch-status.warn { color: var(--yellow); }
  .fetch-cache-info {
    font-size: 11px; color: var(--muted); letter-spacing: 0.04em;
    padding: 4px 0; line-height: 1.6;
  }
  .fetch-cache-info .cache-label { color: var(--accent); font-weight: 700; }

  /* ── DATA SOURCE BADGE ──────────────────────────────── */
  .data-source-badge {
    font-size: 10px; letter-spacing: 0.08em; text-transform: uppercase;
    padding: 2px 8px; border-radius: 2px; font-weight: 700;
    white-space: nowrap;
  }
  .data-source-badge.auto {
    color: var(--green); background: rgba(92,200,160,0.1);
    border: 1px solid rgba(92,200,160,0.2);
  }


  /* ── EXPORT PANEL ─────────────────────────────────── */
  .export-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 16px; display: none; }
  .export-panel.show { display: block; }
  .export-panel-head { padding: 12px 18px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 8px; }
  .export-panel-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--accent); }
  .export-fmt-tabs { display: flex; gap: 4px; }
  .efmt-btn {
    font-family: 'Space Mono', monospace; font-size: 12px; letter-spacing: 0.06em;
    padding: 5px 12px; background: none; border: 1px solid var(--border-bright);
    color: var(--muted); cursor: pointer; border-radius: 2px; transition: all 0.15s;
  }
  .efmt-btn:hover { color: var(--text); border-color: var(--muted); }
  .efmt-btn.active { background: rgba(200,169,110,0.12); border-color: var(--accent); color: var(--accent); }
  .export-body { padding: 0; position: relative; }
  .export-textarea {
    width: 100%; min-height: 280px; max-height: 420px;
    background: #070910; color: #8fa8c0;
    font-family: 'Space Mono', monospace; font-size: 13px; line-height: 1.7;
    padding: 16px 20px; border: none; resize: vertical; outline: none;
    display: block;
  }
  .export-actions { display: flex; gap: 8px; padding: 12px 18px; border-top: 1px solid var(--border); background: var(--bg); flex-wrap: wrap; align-items: center; }
  .exp-filename { font-size: 12px; color: var(--muted); margin-left: auto; letter-spacing: 0.05em; }


  /* ── MOMENTUM / CHANGE % ─────────────────────────── */
  .momentum-tag {
    font-size: 10px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
    padding: 2px 6px; border-radius: 2px; white-space: nowrap;
  }
  .momentum-tag.accel { color: var(--green); background: rgba(92,200,160,0.1); }
  .momentum-tag.decel { color: var(--yellow); background: rgba(224,192,92,0.1); }
  .momentum-tag.stable { color: var(--muted); background: rgba(136,153,187,0.06); }
  .change-pct { font-size: 12px; font-weight: 700; }

  /* ── OI CONFLUENCE BADGE ─────────────────────────── */
  .oi-badge {
    font-size: 9px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
    padding: 2px 6px; border-radius: 2px; white-space: nowrap;
  }
  .oi-badge.strong { color: #0a0c0f; background: var(--green); }
  .oi-badge.reversal { color: #0a0c0f; background: var(--yellow); }
  .oi-badge.weak { color: var(--muted); background: rgba(136,153,187,0.12); border: 1px solid var(--border); }

  /* ── OI CONFLUENCE STAR ──────────────────────────── */
  .oi-star { font-size: 11px; margin-left: 3px; vertical-align: middle; }
  .oi-star.confirmed { color: var(--green); }
  .oi-star.weak { color: var(--muted); opacity: 0.5; }
  .oi-star.diverge { color: var(--yellow); }
  .pair-chip .oi-conf-label {
    font-size: 9px; opacity: 0.7; margin-left: 4px; letter-spacing: 0.06em;
  }
  .psgrid-oi-dot {
    display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-left: 3px; vertical-align: middle;
  }

  /* ── 4-WEEK HISTORY ──────────────────────────────── */
  .history4w-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 16px; }
  .history4w-header {
    padding: 14px 18px; cursor: pointer; display: flex; align-items: center; gap: 8px;
    font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700;
    letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted);
    transition: color 0.15s; user-select: none;
  }
  .history4w-header:hover { color: var(--text); }
  .history4w-header .toggle-arrow { transition: transform 0.2s; }
  .history4w-header.open .toggle-arrow { transform: rotate(90deg); }
  .history4w-body { display: none; padding: 0 18px 16px; }
  .history4w-body.open { display: block; }
  .h4w-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
  .h4w-item {
    background: var(--bg); border: 1px solid var(--border); border-radius: 3px; padding: 12px;
  }
  .h4w-pair { font-weight: 700; font-size: 13px; margin-bottom: 8px; }
  .h4w-row { display: flex; align-items: center; gap: 6px; font-size: 12px; padding: 3px 0; }
  .h4w-label { color: var(--muted); width: 50px; flex-shrink: 0; font-size: 11px; }
  .h4w-val { font-weight: 700; width: 70px; flex-shrink: 0; text-align: right; }
  .h4w-bar { flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
  .h4w-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
  .h4w-avg { font-size: 11px; color: var(--muted); border-top: 1px dashed var(--border); margin-top: 6px; padding-top: 6px; }
  .h4w-avg-val { font-weight: 700; }
  .h4w-avg-diff { font-size: 10px; font-weight: 700; padding: 1px 4px; border-radius: 2px; }

  /* ── SIGNALS / DIVERGENCE ────────────────────────── */
  .signals-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 18px; margin-bottom: 16px; }
  .signals-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--accent); margin-bottom: 14px; }
  .signal-item {
    display: flex; align-items: flex-start; gap: 10px; padding: 8px 0;
    border-bottom: 1px solid var(--border); font-size: 13px;
  }
  .signal-item:last-child { border-bottom: none; }
  .signal-icon { font-size: 16px; flex-shrink: 0; width: 24px; text-align: center; }
  .signal-type { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); padding: 2px 6px; border-radius: 2px; background: rgba(136,153,187,0.08); flex-shrink: 0; }
  .signal-detail { color: var(--text); line-height: 1.5; }
  .signal-pair { font-weight: 700; }
  .no-signals { color: var(--muted); font-size: 13px; font-style: italic; }
  .signals-manual { margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); }
  .signals-manual label { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--muted); cursor: pointer; margin-bottom: 8px; }
  .signals-manual input[type="checkbox"] { accent-color: var(--accent); width: 16px; height: 16px; }
  .signals-manual textarea {
    width: 100%; min-height: 40px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 2px; color: var(--text); font-family: 'Space Mono', monospace;
    font-size: 12px; padding: 8px 10px; resize: vertical; outline: none; margin-top: 6px;
  }
  .signals-manual textarea:focus { border-color: var(--accent); }

  /* ── PAIR STRENGTH MATRIX 8×8 ────────────────────── */
  .psgrid-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 18px; margin-bottom: 16px; }
  .psgrid-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 14px; }
  .psgrid-wrap { overflow-x: auto; }
  .psgrid-table { border-collapse: collapse; }
  .psgrid-table th, .psgrid-table td { width: 48px; height: 38px; text-align: center; font-size: 11px; font-weight: 700; border: 1px solid var(--border); }
  .psgrid-table th { color: var(--muted); font-size: 10px; letter-spacing: 0.08em; background: var(--bg); position: sticky; }
  .psgrid-table th:first-child { left: 0; z-index: 2; }
  .psgrid-table thead th { top: 0; z-index: 1; }
  .psgrid-table td { cursor: default; transition: transform 0.1s; position: relative; }
  .psgrid-table td:hover { transform: scale(1.15); z-index: 5; box-shadow: 0 0 10px rgba(200,169,110,0.3); }
  .psgrid-table td.diag { background: var(--bg); cursor: default; }
  .psgrid-table td.diag:hover { transform: none; box-shadow: none; }
  .psgrid-legend { display: flex; gap: 14px; margin-top: 10px; font-size: 11px; color: var(--muted); flex-wrap: wrap; }
  .psgrid-legend-item { display: flex; align-items: center; gap: 4px; }
  .psgrid-legend-dot { width: 12px; height: 12px; border-radius: 2px; }

  /* ── ACTION PLAN ─────────────────────────────────── */
  .actionplan-card { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 18px; margin-bottom: 16px; }
  .actionplan-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--accent); margin-bottom: 14px; }
  .ap-pairs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
  @media (max-width: 600px) { .ap-pairs-grid { grid-template-columns: 1fr; } }
  .ap-pair-row {
    background: var(--bg); border: 1px solid var(--border); border-radius: 3px; padding: 12px;
  }
  .ap-pair-label { font-weight: 700; font-size: 13px; margin-bottom: 8px; }
  .ap-pair-row select, .ap-pair-row input[type="text"] {
    width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 2px;
    color: var(--text); font-family: 'Space Mono', monospace; font-size: 12px;
    padding: 6px 8px; outline: none; margin-top: 4px;
  }
  .ap-pair-row select:focus, .ap-pair-row input[type="text"]:focus { border-color: var(--accent); }
  .ap-row-label { font-size: 11px; color: var(--muted); letter-spacing: 0.06em; margin-top: 8px; }
  .ap-notes-wrap { margin-top: 14px; }
  .ap-notes-wrap textarea {
    width: 100%; min-height: 60px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 2px; color: var(--text); font-family: 'Space Mono', monospace;
    font-size: 12px; padding: 10px 12px; resize: vertical; outline: none;
  }
  .ap-notes-wrap textarea:focus { border-color: var(--accent); }
  .ap-saved-hint { font-size: 11px; color: var(--green); margin-top: 6px; opacity: 0; transition: opacity 0.3s; }
  .ap-saved-hint.show { opacity: 1; }


</style>
</head>
<body>
<div class="nx-app">
  <div class="nx-main">
    <div class="nx-content">

  <div class="nx-page-header">
    <h1 class="nx-title"><a href="../index.html" style="color:inherit;text-decoration:none">NEXUS</a> · COT <span class="hl">Dashboard</span></h1>
    <p class="nx-subtitle">Commitment of Traders · 52-Week Normalized Positioning · Macro Bias Filter</p>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('matrix')">⬢ COT Matrix</button>
    <button class="tab-btn" onclick="switchTab('ref')">⊞ Bảng Tham Chiếu</button>
  </div>



  <!-- ══ TAB 2: COT MATRIX ══════════════════════════════════ -->
  <div class="tab-panel active" id="tab-matrix">

    <!-- ═══ GITHUB CONFIG BANNER ═══ -->
    <div class="gh-config-card" id="ghConfigCard">
      <div class="gh-config-header">
        <span class="gh-config-title"><span class="gh-icon">⬡</span>GitHub Auto-Fetch CFTC</span>
        <span id="ghHeaderRight"></span>
      </div>
      <div class="gh-config-body" id="ghConfigBody">
        <div class="gh-config-row">
          <div class="field">
            <label>GitHub Username</label>
            <input type="text" id="ghUsername" placeholder="your-username" autocomplete="off" />
          </div>
          <div class="field">
            <label>Tên Repo</label>
            <input type="text" id="ghRepo" placeholder="cot-data" autocomplete="off" />
          </div>
          <button class="btn-gh-save" onclick="saveGhConfig()">Lưu</button>
        </div>
      </div>
    </div>

    <!-- ═══ FETCH CFTC BUTTON ═══ -->
    <div class="gh-fetch-row" id="ghFetchRow">
      <button class="btn-fetch-cftc" id="btnFetchCftc" onclick="fetchCftcFromGitHub()" disabled
        title="Chưa cấu hình GitHub — hãy nhập Username và Repo ở trên">
        ⬡ Lấy Dữ Liệu CFTC
      </button>
      <span class="fetch-status" id="fetchStatus"></span>
    </div>
    <div class="fetch-cache-info" id="fetchCacheInfo"></div>


    <!-- Matrix output -->
    <div class="matrix-container" id="matrixOutput">
      <div class="ref-card">
        <div class="ref-title">
          <span id="matrixTitleText">COT MATRIX</span>
          <span style="display:flex;align-items:center;gap:8px">
            <span class="data-source-badge" id="dataSourceBadge" style="display:none"></span>
            <span id="matrixWeekText" style="font-size:9px;color:var(--muted)"></span>
          </span>
        </div>
        <div class="matrix-table-wrap">
          <table class="matrix-table" id="matrixTable">
            <thead>
              <tr>
                <th style="min-width:70px">Đồng tiền</th>
                <th style="text-align:right">Net Position</th>
                <th style="text-align:right">Thay đổi</th>
                <th>Momentum</th>
                <th style="text-align:right">Open Interest</th>
                <th style="min-width:140px">COT Index</th>
              </tr>
            </thead>
            <tbody id="matrixBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Ranking -->
      <div class="ranking-card">
        <div class="ranking-title">⊕ Ranking Sức Mạnh Đồng Tiền (Mạnh → Yếu)</div>
        <div class="ranking-list" id="rankingList"></div>
      </div>

      <!-- Best Pairs -->
      <div class="pairs-card">
        <div class="pairs-title">⊕ Best Pairs Theo COT</div>
        <div class="pairs-grid" id="pairsGrid"></div>
      </div>

      <!-- 4-Week History (collapsible) -->
      <div class="history4w-card" id="history4wCard" style="display:none">
        <div class="history4w-header" id="history4wHeader" onclick="toggle4wHistory()">
          <span class="toggle-arrow">▸</span> Lịch Sử 4 Tuần &amp; So Sánh Trung Bình
        </div>
        <div class="history4w-body" id="history4wBody"></div>
      </div>

      <!-- Pair Strength Matrix 8x8 -->
      <div class="psgrid-card" id="psgridCard" style="display:none">
        <div class="psgrid-title">◫ Ma Trận Sức Mạnh Cặp Tiền</div>
        <div class="psgrid-wrap" id="psgridWrap"></div>
        <div class="psgrid-legend">
          <div class="psgrid-legend-item"><div class="psgrid-legend-dot" style="background:var(--green)"></div> Long mạnh</div>
          <div class="psgrid-legend-item"><div class="psgrid-legend-dot" style="background:rgba(92,200,160,0.4)"></div> Long nhẹ</div>
          <div class="psgrid-legend-item"><div class="psgrid-legend-dot" style="background:var(--border)"></div> Trung tính</div>
          <div class="psgrid-legend-item"><div class="psgrid-legend-dot" style="background:rgba(224,92,92,0.4)"></div> Short nhẹ</div>
          <div class="psgrid-legend-item"><div class="psgrid-legend-dot" style="background:var(--red)"></div> Short mạnh</div>
          <div class="psgrid-legend-item" style="margin-left:auto; opacity:0.8; font-family:var(--font-mono); font-size:10px; letter-spacing:0.02em;">
            <span class="psgrid-oi-dot" style="background:#fff; opacity:0.6; margin:0 6px 0 0;"></span> Chấm màu: Dòng tiền (OI) xác nhận
          </div>
        </div>
      </div>

      <!-- Signals / Divergence Checklist -->
      <div class="signals-card" id="signalsCard" style="display:none">
        <div class="signals-title"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> Tín Hiệu Đặc Biệt</div>
        <div id="signalsAutoList"></div>
        <div class="signals-manual">
          <label><input type="checkbox" id="sigDivergence"> Phát hiện Divergence COT vs Price</label>
          <label><input type="checkbox" id="sigOther"> Tín hiệu khác cần lưu ý</label>
          <textarea id="sigNotes" placeholder="Ghi chú tín hiệu thủ công..."></textarea>
        </div>
      </div>

      <!-- Action Plan -->
      <div class="actionplan-card" id="actionplanCard" style="display:none">
        <div class="actionplan-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg> Kế Hoạch Tuần Này</div>
        <div class="ap-pairs-grid" id="apPairsGrid"></div>
        <div class="ap-notes-wrap">
          <div class="ap-row-label">GHI CHÚ TỔNG</div>
          <textarea id="apNotes" placeholder="Ghi chú chiến lược tuần này..." oninput="saveActionPlan()"></textarea>
        </div>
        <div class="ap-saved-hint" id="apSavedHint"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px"><path d="M20 6 9 17l-5-5"/></svg> Đã lưu tự động</div>
      </div>

      <!-- Export Panel -->
      <div class="export-panel" id="exportPanel">
        <div class="export-panel-head">
          <span class="export-panel-title">⬇ Xuất Kết Quả</span>
          <div class="export-fmt-tabs">
            <button class="efmt-btn active" id="efmt-md"   onclick="switchExportFmt('md')">Markdown</button>
            <button class="efmt-btn"        id="efmt-json" onclick="switchExportFmt('json')">JSON</button>
            <button class="efmt-btn"        id="efmt-csv"  onclick="switchExportFmt('csv')">CSV</button>
            <button class="efmt-btn"        id="efmt-txt"  onclick="switchExportFmt('txt')">Summary</button>
          </div>
        </div>
        <div class="export-body">
          <textarea class="export-textarea" id="exportTextarea" readonly spellcheck="false"></textarea>
        </div>
        <div class="export-actions">
          <button class="btn-sm accent-btn" onclick="copyExport()">⎘ Copy</button>
          <button class="btn-sm accent-btn" onclick="downloadExport()">⬇ Tải về</button>
          <span class="exp-filename" id="expFilename"></span>
        </div>
      </div>

      <!-- Lock Weekly Bias -->
      <div class="actionplan-card" id="lockBiasCard" style="display:none">
        <div class="actionplan-title">Lock Weekly Bias</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:14px;">Lock bias tuần này để chia sẻ với Daily Bias Board và các tool khác.</div>
        <div id="lockBiasGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;"></div>
        <div style="display:flex;gap:8px;margin-top:14px;align-items:center;">
          <button class="btn-calc" onclick="lockWeeklyBias()" style="width:auto;padding:10px 20px;font-size:12px;">Lock Bias</button>
          <button class="btn-sm" onclick="clearWeeklyBias()" style="font-size:11px;">Xoá Lock</button>
          <span id="lockBiasStatus" style="font-size:11px;color:var(--green);margin-left:auto;opacity:0;transition:opacity 0.3s;"></span>
        </div>
      </div>

      <!-- Alert History -->
      <div class="signals-card" id="alertHistoryCard" style="display:none">
        <div class="signals-title">Alert History</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:10px;">Lịch sử tín hiệu qua các tuần — giúp phát hiện mẫu lặp lại.</div>
        <div id="alertHistoryList"></div>
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn-sm accent-btn" onclick="saveCurrentAlerts()">Lưu Tín Hiệu Tuần Này</button>
          <button class="btn-sm" onclick="clearAlertHistory()" style="margin-left:auto;">Xoá Lịch Sử</button>
        </div>
      </div>

    </div>
  </div>

  <!-- ══ TAB 3: REFERENCE ══════════════════════════════════ -->
  <div class="tab-panel" id="tab-ref">
    <div class="ref-card">
      <div class="ref-title"><span>Bảng Tham Chiếu COT Index</span></div>
      <table>
        <thead>
          <tr><th>COT Index</th><th>Ý Nghĩa</th><th>ICT Bias</th><th>Hành Động</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="zone-dot" style="background:var(--red)"></span>0 – 10</td>
            <td>Cực kỳ bearish</td><td><span style="color:var(--red)">EXTREME BEAR</span></td>
            <td class="action-note"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg> Cẩn thận reversal tăng</td>
          </tr>
          <tr>
            <td><span class="zone-dot" style="background:#e07a5c"></span>10 – 25</td>
            <td>Bearish mạnh</td><td><span style="color:#e07a5c">BEARISH</span></td>
            <td class="action-note">Short bias – monitor</td>
          </tr>
          <tr>
            <td><span class="zone-dot" style="background:var(--yellow)"></span>25 – 40</td>
            <td>Bearish vừa</td><td><span style="color:var(--yellow)">BEARISH MILD</span></td>
            <td class="action-note">Short bias bình thường</td>
          </tr>
          <tr>
            <td><span class="zone-dot" style="background:var(--neutral)"></span>40 – 60</td>
            <td>Neutral</td><td><span style="color:var(--neutral)">NEUTRAL</span></td>
            <td class="action-note">Cần tín hiệu ICT khác</td>
          </tr>
          <tr>
            <td><span class="zone-dot" style="background:#8bc88a"></span>60 – 75</td>
            <td>Bullish vừa</td><td><span style="color:#8bc88a">BULLISH MILD</span></td>
            <td class="action-note">Long bias bình thường</td>
          </tr>
          <tr>
            <td><span class="zone-dot" style="background:var(--green)"></span>75 – 90</td>
            <td>Bullish mạnh</td><td><span style="color:var(--green)">BULLISH</span></td>
            <td class="action-note">Long bias – monitor</td>
          </tr>
          <tr>
            <td><span class="zone-dot" style="background:#3dffc8"></span>90 – 100</td>
            <td>Cực kỳ bullish</td><td><span style="color:#3dffc8">EXTREME BULL</span></td>
            <td class="action-note"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg> Cẩn thận reversal giảm</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <footer class="nx-footer">
    COT Index = (Net Hiện Tại − Net Thấp Nhất 52T) ÷ (Net Cao Nhất − Net Thấp Nhất) × 100<br>
    Nguồn dữ liệu: CFTC.gov · Cập nhật mỗi thứ Sáu · Dùng kết hợp ICT HTF Narrative &amp; Daily Bias
  </footer>

    </div>
  </div>
</div>

<script src="../shared/utils.js"></script>
<script src="../shared/store.js"></script>
<script src="../shared/crypto.js"></script>
<script src="../shared/sync.js"></script>
<script src="../shared/nav.js"></script>
<script>

// ═══════════════════════════════════════════════════
//  TAB
// ═══════════════════════════════════════════════════
function switchTab(id) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  event.currentTarget.classList.add('active');
}

// ═══════════════════════════════════════════════════
//  MATRIX — data (populated by auto-fetch)
// ═══════════════════════════════════════════════════
let matrixEntries = [];

// ═══════════════════════════════════════════════════
//  GENERATE MATRIX
// ═══════════════════════════════════════════════════

function generateMatrix() {
  if (matrixEntries.length < 2) return;

  // Sort by COT Index descending for ranking
  const sorted = [...matrixEntries].sort((a, b) => b.idxNum - a.idxNum);

  // ── #1: Fill table with new columns ──
  const tbody = document.getElementById('matrixBody');
  tbody.innerHTML = matrixEntries.map(e => {
    const z = getZone(e.idxNum);
    const delta = e.delta !== undefined ? e.delta : ((e.prev !== null && !isNaN(e.prev)) ? e.cur - e.prev : null);
    const deltaStr = delta !== null
      ? `<span style="color:${delta>=0?'var(--green)':'var(--red)'};font-weight:700">${delta>=0?'+':''}${fmtVN(Math.round(delta))}</span>`
      : '<span style="color:var(--muted)">—</span>';

    // Change %
    const changePct = (delta !== null && e.prev !== null && e.prev !== 0) ? (delta / Math.abs(e.prev) * 100) : null;
    const changePctStr = changePct !== null
      ? `<span class="change-pct" style="color:${changePct>=0?'var(--green)':'var(--red)'}">${changePct>=0?'+':''}${changePct.toFixed(1)}%</span>`
      : '<span style="color:var(--muted)">—</span>';

    // Momentum
    const prevDelta = e.prev_delta !== undefined ? e.prev_delta : null;
    let momentumStr = '<span style="color:var(--muted)">—</span>';
    if (delta !== null && prevDelta !== null) {
      const absCur = Math.abs(delta), absPrev = Math.abs(prevDelta);
      if (absCur > absPrev * 1.2) momentumStr = '<span class="momentum-tag accel">▲ Tăng tốc</span>';
      else if (absCur < absPrev * 0.8) momentumStr = '<span class="momentum-tag decel">▽ Giảm tốc</span>';
      else momentumStr = '<span class="momentum-tag stable">— Ổn định</span>';
    }

    const trendClass = (e.t4||'').includes('Tăng') ? 'trend-up' : (e.t4||'').includes('Giảm') ? 'trend-dn' : 'trend-flat';

    // OI with confluence badge
    const oi = (e.oi !== undefined && e.oi !== null) ? e.oi : null;
    const oiDelta = (e.oi_delta !== undefined && e.oi_delta !== null) ? e.oi_delta : null;
    let oiStr = '<span style="color:var(--muted)">—</span>';
    if (oi !== null) {
      let oiDeltaStr = '';
      if (oiDelta !== null) {
        const oiDColor = oiDelta >= 0 ? 'var(--green)' : 'var(--red)';
        const oiDSign = oiDelta >= 0 ? '+' : '';
        oiDeltaStr = `<div style="color:${oiDColor};font-size:10px;margin-top:2px;font-family:'Space Mono',monospace">Δ ${oiDSign}${fmtVN(oiDelta)}</div>`;
      }
      let badge = '';
      if (oiDelta !== null && delta !== null) {
        const deltaAligned = (oiDelta > 0) && ((delta > 0 && e.cur > 0) || (delta < 0 && e.cur < 0));
        if (deltaAligned) badge = '<span class="oi-badge strong" style="margin-top:4px;display:inline-block">STRONG</span>';
        else if (oiDelta > 0) badge = '<span class="oi-badge reversal" style="margin-top:4px;display:inline-block">REVERSAL?</span>';
        else badge = '<span class="oi-badge weak" style="margin-top:4px;display:inline-block">WEAK</span>';
      }
      oiStr = `<div style="font-weight:700;font-family:'Space Mono',monospace">${fmtVN(oi)}</div>` + oiDeltaStr + badge;
    }

    return `<tr>
      <td><span class="pair-tag" style="color:${z.color}">${e.pair}</span></td>
      <td style="text-align:right">
        <div style="font-weight:700;font-size:14px;font-family:'Space Mono',monospace">${fmtVN(e.cur)}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px" title="Tuần trước">Prev: <span style="font-family:'Space Mono',monospace">${e.prev !== null ? fmtVN(e.prev) : '—'}</span></div>
      </td>
      <td style="text-align:right">
        <div style="font-family:'Space Mono',monospace;font-size:13px">${deltaStr}</div>
        <div style="font-size:11px;margin-top:4px;font-family:'Space Mono',monospace">${changePctStr}</div>
      </td>
      <td>
        <div style="margin-bottom:6px">${momentumStr}</div>
        <div><span class="${trendClass}">${e.t4 || '—'}</span></div>
      </td>
      <td style="text-align:right;font-size:12px;line-height:1.4">
        ${oiStr}
      </td>
      <td>
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:6px">
          <span style="color:${z.color};font-weight:700;font-size:10px;text-transform:uppercase">${z.label}</span>
          <span class="cot-val" style="color:${z.color};font-size:14px;font-family:'Space Mono',monospace">${fmtIdx(e.idxNum)}</span>
        </div>
        <div>
          <div class="cot-bar-track"><div class="cot-bar-fill" style="width:${e.idxNum}%;background:${z.color}"></div></div>
        </div>
      </td>
    </tr>`;
  }).join('');

  // ── Ranking ──
  const rankEl = document.getElementById('rankingList');
  rankEl.innerHTML = sorted.map((e, i) => {
    const z = getZone(e.idxNum);
    const isStrongest = i === 0;
    const isWeakest = i === sorted.length - 1;
    const tag = isStrongest ? ' ← Strongest' : isWeakest ? ' ← Weakest' : '';
    return `<div class="ranking-item">
      <span class="rank-num">${i+1}.</span>
      <span class="rank-pair" style="color:${z.color}">${e.pair}</span>
      <div class="rank-bar-track"><div class="rank-bar-fill" style="width:${e.idxNum}%;background:${z.color}"></div></div>
      <span class="rank-idx" style="color:${z.color}">${fmtIdx(e.idxNum)}</span>
      <span class="rank-label" style="color:${z.color}">${z.label}${tag}</span>
    </div>`;
  }).join('');

  // ── Best Pairs ──
  const bulls = sorted.filter(e => e.idxNum >= 60);
  const bears = sorted.filter(e => e.idxNum <= 40);
  const neutrals = sorted.filter(e => e.idxNum > 40 && e.idxNum < 60);

  // ── OI Confluence helper ──
  function getOIConfluence(e) {
    if (e.oi == null || e.oi_delta == null) return { type: 'none', label: '', star: '' };
    const delta = e.delta !== undefined ? e.delta : ((e.prev !== null && !isNaN(e.prev)) ? e.cur - e.prev : 0);
    const aligned = (e.oi_delta > 0) && ((delta > 0 && e.cur > 0) || (delta < 0 && e.cur < 0));
    if (aligned) return { type: 'confirmed', label: `OI ${SVG_ICONS.check}`, star: `<span class="oi-star confirmed" title="OI xác nhận xu hướng">${SVG_ICONS.starFull}</span>` };
    if (e.oi_delta > 0 && ((delta > 0 && e.cur < 0) || (delta < 0 && e.cur > 0))) return { type: 'diverge', label: `OI ${SVG_ICONS.alertTriangle}`, star: `<span class="oi-star diverge" title="OI mâu thuẫn — reversal?">${SVG_ICONS.starHalf}</span>` };
    return { type: 'weak', label: 'OI ↓', star: `<span class="oi-star weak" title="OI giảm — tín hiệu yếu">${SVG_ICONS.starHalf}</span>` };
  }

  const longPairs = [];
  bulls.forEach(b => {
    bears.slice().reverse().forEach(br => {
      let score = b.idxNum - br.idxNum;
      // OI Confluence bonus: +10 if both sides have OI confirmation
      const bConf = getOIConfluence(b);
      const brConf = getOIConfluence(br);
      let oiTag = '';
      if (bConf.type === 'confirmed' && (brConf.type === 'confirmed' || brConf.type === 'weak')) {
        score += 10; oiTag = SVG_ICONS.starFull;
      } else if (bConf.type === 'confirmed' || brConf.type === 'confirmed') {
        score += 5; oiTag = SVG_ICONS.starHalf;
      }
      longPairs.push({ pair: `${b.pair}/${br.pair}`, score, oiTag });
    });
  });
  longPairs.sort((a,b) => b.score - a.score);

  const shortPairs = longPairs.map(p => {
    const parts = p.pair.split('/');
    return { pair: `${parts[1]}/${parts[0]}`, score: p.score, oiTag: p.oiTag };
  });

  const avoidPairs = [];
  neutrals.forEach((a, i) => neutrals.slice(i+1).forEach(b => avoidPairs.push(`${a.pair}/${b.pair}`)));

  const pairsEl = document.getElementById('pairsGrid');
  pairsEl.innerHTML = `
    <div>
      <div class="pairs-section-label" style="color:var(--green)">↑ LONG (Mạnh/Yếu)</div>
      ${longPairs.slice(0,5).map(p => `<span class="pair-chip" style="color:var(--green);background:rgba(92,200,160,0.1);border:1px solid rgba(92,200,160,0.2)">${p.pair}${p.oiTag ? '<span class="oi-conf-label">'+p.oiTag+'</span>':''}</span>`).join('') || '<span style="color:var(--muted);font-size:11px">—</span>'}
    </div>
    <div>
      <div class="pairs-section-label" style="color:var(--red)">↓ SHORT (Yếu/Mạnh)</div>
      ${shortPairs.slice(0,5).map(p => `<span class="pair-chip" style="color:var(--red);background:rgba(224,92,92,0.1);border:1px solid rgba(224,92,92,0.2)">${p.pair}${p.oiTag ? '<span class="oi-conf-label">'+p.oiTag+'</span>':''}</span>`).join('') || '<span style="color:var(--muted);font-size:11px">—</span>'}
    </div>
    <div>
      <div class="pairs-section-label" style="display:flex;align-items:center;gap:4px;color:var(--muted)">${SVG_ICONS.alertTriangle} TRÁNH (Neutral vs Neutral)</div>
      ${avoidPairs.slice(0,4).map(p => `<span class="pair-chip" style="color:var(--muted);background:rgba(136,153,187,0.08);border:1px solid rgba(136,153,187,0.15)">${p}</span>`).join('') || '<span style="color:var(--muted);font-size:11px">—</span>'}
    </div>
  `;

  // ── #3: 4-Week History ──
  render4wHistory(matrixEntries, sorted);

  // ── #5: Pair Strength Matrix 8×8 ──
  renderPairStrengthGrid(sorted);

  // ── #4: Signals ──
  renderSignals(matrixEntries);

  // ── #6: Action Plan ──
  renderActionPlan(longPairs, shortPairs);

  // Week label
  const now = new Date();
  const weekLabel = _matrixWeekOverride || ('Tuần ' + now.toLocaleDateString('vi-VN', {day:'2-digit',month:'2-digit',year:'numeric'}));
  document.getElementById('matrixTitleText').textContent = 'COT MATRIX';
  document.getElementById('matrixWeekText').textContent = weekLabel;

  // Data source badge — always auto
  const badge = document.getElementById('dataSourceBadge');
  badge.className = 'data-source-badge auto';
  badge.textContent = '⬡ CFTC Auto · ' + weekLabel;
  badge.style.display = 'inline-block';

  // Store for export
  _matrixData = { entries: matrixEntries, sorted, longPairs, shortPairs, avoidPairs, weekLabel };

  // Show export panel, default to Markdown
  switchExportFmt('md');
  document.getElementById('exportPanel').classList.add('show');

  document.getElementById('matrixOutput').className = 'matrix-container show';
  document.getElementById('matrixOutput').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ═══════════════════════════════════════════════════
//  4-WEEK HISTORY SECTION
// ═══════════════════════════════════════════════════
function toggle4wHistory() {
  const header = document.getElementById('history4wHeader');
  const body = document.getElementById('history4wBody');
  header.classList.toggle('open');
  body.classList.toggle('open');
}

function render4wHistory(entries, sorted) {
  const hasHistory = entries.some(e => e.history_4w && e.history_4w.length >= 2);
  const card = document.getElementById('history4wCard');
  if (!hasHistory) { card.style.display = 'none'; return; }
  card.style.display = '';

  const body = document.getElementById('history4wBody');
  body.innerHTML = '<div class="h4w-grid">' + sorted.map(e => {
    const z = getZone(e.idxNum);
    const hist = e.history_4w || [e.cur];
    const allVals = hist.concat(e.avg_13w || 0, e.avg_26w || 0);
    const minV = Math.min(...allVals), maxV = Math.max(...allVals);
    const range = maxV - minV || 1;
    const barPct = v => Math.max(2, ((v - minV) / range) * 100);
    const weekLabels = ['Hiện tại', 'W-1', 'W-2', 'W-3'];

    let html = `<div class="h4w-item">
      <div class="h4w-pair" style="color:${z.color}">${e.pair} <span style="color:${z.color};font-size:10px;opacity:0.7">${z.label}</span></div>`;

    hist.forEach((v, i) => {
      const c = i === 0 ? z.color : 'var(--muted)';
      html += `<div class="h4w-row">
        <span class="h4w-label">${weekLabels[i] || 'W-'+i}</span>
        <span class="h4w-val" style="color:${c}">${fmtVN(v)}</span>
        <div class="h4w-bar"><div class="h4w-bar-fill" style="width:${barPct(v)}%;background:${c}"></div></div>
      </div>`;
    });

    // Averages
    if (e.avg_13w !== undefined && e.avg_13w !== null) {
      const diff13 = e.cur - e.avg_13w;
      const diffColor = Math.abs(diff13) > Math.abs(e.avg_13w * 0.15) ? (diff13 > 0 ? 'var(--green)' : 'var(--red)') : 'var(--muted)';
      html += `<div class="h4w-avg">TB 3 tháng: <span class="h4w-avg-val">${fmtVN(e.avg_13w)}</span>
        <span class="h4w-avg-diff" style="color:${diffColor}">${diff13>=0?'+':''}${fmtVN(diff13)}</span></div>`;
    }
    if (e.avg_26w !== undefined && e.avg_26w !== null) {
      const diff26 = e.cur - e.avg_26w;
      const diffColor = Math.abs(diff26) > Math.abs(e.avg_26w * 0.15) ? (diff26 > 0 ? 'var(--green)' : 'var(--red)') : 'var(--muted)';
      html += `<div class="h4w-avg">TB 6 tháng: <span class="h4w-avg-val">${fmtVN(e.avg_26w)}</span>
        <span class="h4w-avg-diff" style="color:${diffColor}">${diff26>=0?'+':''}${fmtVN(diff26)}</span></div>`;
    }

    html += '</div>';
    return html;
  }).join('') + '</div>';
}

// ═══════════════════════════════════════════════════
//  PAIR STRENGTH MATRIX 8×8
// ═══════════════════════════════════════════════════
function renderPairStrengthGrid(sorted) {
  const card = document.getElementById('psgridCard');
  if (sorted.length < 3) { card.style.display = 'none'; return; }
  card.style.display = '';

  const n = sorted.length;
  let html = '<table class="psgrid-table"><thead><tr><th></th>';
  sorted.forEach(e => { html += `<th>${e.pair}</th>`; });
  html += '</tr></thead><tbody>';

  sorted.forEach((row, ri) => {
    html += `<tr><th>${row.pair}</th>`;
    sorted.forEach((col, ci) => {
      if (ri === ci) { html += '<td class="diag">—</td>'; return; }
      const spread = row.idxNum - col.idxNum;
      const abs = Math.abs(spread);
      let bg, fg;
      if (spread > 40) { bg = 'var(--green)'; fg = '#0a0c0f'; }
      else if (spread > 20) { bg = 'rgba(92,200,160,0.4)'; fg = 'var(--green)'; }
      else if (spread > -20) { bg = 'var(--border)'; fg = 'var(--muted)'; }
      else if (spread > -40) { bg = 'rgba(224,92,92,0.4)'; fg = 'var(--red)'; }
      else { bg = 'var(--red)'; fg = '#0a0c0f'; }
      // OI tooltip: show OI status for both currencies
      const rowOI = row.oi_delta != null ? (row.oi_delta >= 0 ? `OI↑${fmtVN(row.oi_delta)}` : `OI↓${fmtVN(row.oi_delta)}`) : '';
      const colOI = col.oi_delta != null ? (col.oi_delta >= 0 ? `OI↑${fmtVN(col.oi_delta)}` : `OI↓${fmtVN(col.oi_delta)}`) : '';
      const oiTip = (rowOI || colOI) ? `\n${row.pair}: ${rowOI || '—'} | ${col.pair}: ${colOI || '—'}` : '';
      // OI dot: show if both have confirming OI
      let oiDot = '';
      if (abs > 20 && row.oi_delta != null && col.oi_delta != null) {
        const rowConf = (spread > 0 && row.oi_delta > 0) || (spread < 0 && row.oi_delta < 0);
        const colConf = (spread > 0 && col.oi_delta < 0) || (spread < 0 && col.oi_delta > 0);
        if (rowConf || colConf) oiDot = `<span class="psgrid-oi-dot" style="background:${spread > 0 ? 'var(--green)' : 'var(--red)'}"></span>`;
      }
      html += `<td style="background:${bg};color:${fg}" title="${row.pair}/${col.pair}: ${spread>=0?'+':''}${spread.toFixed(0)}${oiTip}">${spread>=0?'+':''}${spread.toFixed(0)}${oiDot}</td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById('psgridWrap').innerHTML = html;
}

// ═══════════════════════════════════════════════════
//  SIGNALS / DIVERGENCE
// ═══════════════════════════════════════════════════
function renderSignals(entries) {
  const card = document.getElementById('signalsCard');
  card.style.display = '';

  const signals = [];

  entries.forEach(e => {
    const z = getZone(e.idxNum);

    // Flip detection
    if (e.prev !== null && e.prev !== undefined) {
      if ((e.prev > 0 && e.cur < 0) || (e.prev < 0 && e.cur > 0)) {
        const dir = e.cur > 0 ? 'Short → Long' : 'Long → Short';
        signals.push({ icon: SVG_ICONS.signalFlip, type: 'FLIP', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> — ${dir}. Net chuyển từ ${fmtVN(e.prev)} sang ${fmtVN(e.cur)}`, priority: 3 });
      }
    }

    // Extreme detection
    if (e.idxNum < 10) {
      signals.push({ icon: SVG_ICONS.signalWarning, type: 'EXTREME BEAR', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> — COT Index ${fmtIdx(e.idxNum)}. Cẩn thận reversal tăng.`, priority: 2 });
    } else if (e.idxNum > 90) {
      signals.push({ icon: SVG_ICONS.signalWarning, type: 'EXTREME BULL', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> — COT Index ${fmtIdx(e.idxNum)}. Cẩn thận reversal giảm.`, priority: 2 });
    }

    // Strong momentum detection
    const delta = e.delta !== undefined ? e.delta : ((e.prev !== null) ? e.cur - e.prev : null);
    const prevDelta = e.prev_delta !== undefined ? e.prev_delta : null;
    if (delta !== null && prevDelta !== null && Math.abs(delta) > Math.abs(prevDelta) * 1.8) {
      signals.push({ icon: SVG_ICONS.signalTrending, type: 'MOMENTUM', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> — Tăng tốc mạnh. Δ tuần: ${fmtVN(delta)} vs tuần trước: ${fmtVN(prevDelta)}`, priority: 1 });
    }

    // ── OI Signals ──
    if (e.oi != null && e.oi_prev != null && e.oi_delta != null) {
      const oiChangePct = (e.oi_delta / e.oi_prev) * 100;
      // OI Surge: >10% change
      if (Math.abs(oiChangePct) > 10) {
        const dir = oiChangePct > 0 ? 'tăng' : 'giảm';
        signals.push({ icon: SVG_ICONS.signalFlame, type: 'OI SURGE', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> — OI ${dir} <strong>${Math.abs(oiChangePct).toFixed(1)}%</strong> (${fmtVN(e.oi_delta)}). Dòng tiền ${dir === 'tăng' ? 'mới đổ vào' : 'rút ra mạnh'}.`, priority: 2 });
      }
      // OI Divergence: Net tăng nhưng OI giảm (hoặc ngược lại)
      if (delta !== null) {
        const netUp = delta > 0;
        const oiDown = e.oi_delta < 0;
        if (netUp && oiDown && Math.abs(oiChangePct) > 3) {
          signals.push({ icon: SVG_ICONS.signalShuffle, type: 'OI DIVERG', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> — Net Position tăng nhưng OI giảm ${Math.abs(oiChangePct).toFixed(1)}%. Tín hiệu <strong>short-covering</strong>, không phải dòng tiền mới.`, priority: 2 });
        } else if (!netUp && !oiDown && Math.abs(oiChangePct) > 3) {
          signals.push({ icon: SVG_ICONS.signalShuffle, type: 'OI DIVERG', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> — Net Position giảm nhưng OI tăng ${Math.abs(oiChangePct).toFixed(1)}%. Dòng tiền mới đang <strong>short</strong>.`, priority: 2 });
        }
      }
      // OI Exhaustion: OI giảm khi ở vùng Extreme
      if ((e.idxNum > 90 || e.idxNum < 10) && e.oi_delta < 0 && Math.abs(oiChangePct) > 2) {
        signals.push({ icon: SVG_ICONS.signalExhaust, type: 'OI EXHAUST', detail: `<span class="signal-pair" style="color:${z.color}">${e.pair}</span> — Đang ở ${e.idxNum > 90 ? 'EXTREME BULL' : 'EXTREME BEAR'} nhưng OI giảm ${Math.abs(oiChangePct).toFixed(1)}%. Xu hướng có thể <strong>cạn kiệt động lực</strong>.`, priority: 3 });
      }
    }
  });

  signals.sort((a, b) => b.priority - a.priority);

  const listEl = document.getElementById('signalsAutoList');
  if (signals.length === 0) {
    listEl.innerHTML = '<div class="no-signals">Không có tín hiệu đặc biệt tuần này. Thị trường tương đối ổn định.</div>';
  } else {
    listEl.innerHTML = signals.map(s => `
      <div class="signal-item">
        <span class="signal-icon">${s.icon}</span>
        <span class="signal-type">${s.type}</span>
        <span class="signal-detail">${s.detail}</span>
      </div>
    `).join('');
  }
}

// ═══════════════════════════════════════════════════
//  ACTION PLAN
// ═══════════════════════════════════════════════════
let _apSaveTimer = null;

function renderActionPlan(longPairs, shortPairs) {
  const card = document.getElementById('actionplanCard');
  card.style.display = '';

  const topLong = longPairs.slice(0, 2);
  const topShort = shortPairs.slice(0, 2);
  const pairs = [...topLong.map(p => ({ pair: p.pair, bias: 'Long' })), ...topShort.map(p => ({ pair: p.pair, bias: 'Short' }))];
  if (pairs.length === 0) pairs.push({ pair: 'EUR/USD', bias: 'Neutral' });

  // Load saved plan
  const weekLabel = _matrixWeekOverride || '';
  const saved = loadActionPlan(weekLabel);

  const grid = document.getElementById('apPairsGrid');
  grid.innerHTML = pairs.map((p, i) => {
    const savedPair = saved && saved.pairs && saved.pairs[i] ? saved.pairs[i] : {};
    return `<div class="ap-pair-row">
      <div class="ap-pair-label">${p.pair}</div>
      <div class="ap-row-label">BIAS</div>
      <select id="apBias${i}" onchange="saveActionPlan()">
        <option value="Long" ${(savedPair.bias || p.bias)==='Long'?'selected':''}>Long</option>
        <option value="Short" ${(savedPair.bias || p.bias)==='Short'?'selected':''}>Short</option>
        <option value="Neutral" ${(savedPair.bias || p.bias)==='Neutral'?'selected':''}>Neutral</option>
      </select>
      <div class="ap-row-label">CONFIDENCE</div>
      <select id="apConf${i}" onchange="saveActionPlan()">
        <option value="Cao" ${(savedPair.conf)==='Cao'?'selected':''}>Cao</option>
        <option value="TB" ${(!savedPair.conf || savedPair.conf==='TB')?'selected':''}>Trung bình</option>
        <option value="Thấp" ${(savedPair.conf)==='Thấp'?'selected':''}>Thấp</option>
      </select>
      <div class="ap-row-label">VÙNG GIÁ CHỜ</div>
      <input type="text" id="apZone${i}" placeholder="Ví dụ: 1.0800 – 1.0850" value="${savedPair.zone || ''}" oninput="saveActionPlan()">
    </div>`;
  }).join('');

  // Auto-set Confidence from OI confluence (only if no saved plan)
  if (!saved || !saved.pairs || saved.pairs.length === 0) {
    pairs.forEach((p, i) => {
      const pairParts = p.pair.split('/');
      const base = matrixEntries.find(e => e.pair === pairParts[0]);
      const quote = matrixEntries.find(e => e.pair === pairParts[1]);
      let autoConf = 'TB';
      if (base && quote) {
        const baseOI = base.oi_delta != null ? base.oi_delta : 0;
        const quoteOI = quote.oi_delta != null ? quote.oi_delta : 0;
        const baseAligned = (p.bias === 'Long' && baseOI > 0) || (p.bias === 'Short' && baseOI < 0);
        const quoteAligned = (p.bias === 'Long' && quoteOI < 0) || (p.bias === 'Short' && quoteOI > 0);
        if (baseAligned && quoteAligned) autoConf = 'Cao';
        else if (baseAligned || quoteAligned) autoConf = 'TB';
        else autoConf = 'Thấp';
      }
      const confEl = document.getElementById('apConf' + i);
      if (confEl) confEl.value = autoConf;
    });
  }

  // Restore notes
  document.getElementById('apNotes').value = (saved && saved.notes) || '';

  // Store pair count for saving
  document.getElementById('actionplanCard').dataset.pairCount = pairs.length;
  document.getElementById('actionplanCard').dataset.pairs = JSON.stringify(pairs.map(p => p.pair));
}

function saveActionPlan() {
  clearTimeout(_apSaveTimer);
  _apSaveTimer = setTimeout(() => {
    const weekLabel = _matrixWeekOverride || '';
    const pairCount = parseInt(document.getElementById('actionplanCard').dataset.pairCount || '0');
    const pairNames = JSON.parse(document.getElementById('actionplanCard').dataset.pairs || '[]');
    const pairs = [];
    for (let i = 0; i < pairCount; i++) {
      pairs.push({
        pair: pairNames[i] || '',
        bias: (document.getElementById('apBias'+i) || {}).value || 'Neutral',
        conf: (document.getElementById('apConf'+i) || {}).value || 'TB',
        zone: (document.getElementById('apZone'+i) || {}).value || ''
      });
    }
    const plan = {
      pairs,
      notes: document.getElementById('apNotes').value,
      savedAt: new Date().toISOString()
    };
    localStorage.setItem('cot_actionplan_' + weekLabel, JSON.stringify(plan));
    const hint = document.getElementById('apSavedHint');
    hint.classList.add('show');
    setTimeout(() => hint.classList.remove('show'), 2000);
  }, 500);
}

function loadActionPlan(weekLabel) {
  try { return JSON.parse(localStorage.getItem('cot_actionplan_' + weekLabel) || 'null'); }
  catch(e) { return null; }
}

// ═══════════════════════════════════════════════════
//  EXPORT
// ═══════════════════════════════════════════════════
let _matrixData = null;

let _currentFmt = 'md';

function switchExportFmt(fmt) {
  _currentFmt = fmt;
  ['md','json','csv','txt'].forEach(f => {
    document.getElementById('efmt-' + f).classList.toggle('active', f === fmt);
  });
  if (!_matrixData) return;
  const content = buildExport(fmt);
  document.getElementById('exportTextarea').value = content;
  const ext = fmt === 'txt' ? 'txt' : fmt === 'json' ? 'json' : fmt === 'csv' ? 'csv' : 'md';
  const slug = (_matrixData.weekLabel || 'cot').replace(/\s/g,'-').replace(/\//g,'-');
  document.getElementById('expFilename').textContent = `COT-Matrix-${slug}.${ext}`;
}

function buildExport(fmt) {
  const { entries, sorted, longPairs, shortPairs, avoidPairs, weekLabel } = _matrixData;

  if (fmt === 'md') return buildMarkdown(entries, sorted, longPairs, shortPairs, avoidPairs, weekLabel);
  if (fmt === 'json') return buildJSON(entries, weekLabel);
  if (fmt === 'csv') return buildCSV(entries, weekLabel);
  if (fmt === 'txt') return buildSummary(sorted, longPairs, shortPairs, avoidPairs, weekLabel);
  return '';
}

// ── Shared: build signals for export (plain text, no HTML) ──
function buildSignalsForExport(entries) {
  const signals = [];
  entries.forEach(e => {
    const z = getZone(e.idxNum);
    // Flip detection
    if (e.prev !== null && e.prev !== undefined) {
      if ((e.prev > 0 && e.cur < 0) || (e.prev < 0 && e.cur > 0)) {
        const dir = e.cur > 0 ? 'Short → Long' : 'Long → Short';
        signals.push({ icon: SVG_ICONS.refresh, type: 'FLIP', plainDetail: `${e.pair} — ${dir}. Net chuyển từ ${fmtVN(e.prev)} sang ${fmtVN(e.cur)}`, priority: 3 });
      }
    }
    // Extreme detection
    if (e.idxNum < 10) {
      signals.push({ icon: SVG_ICONS.alertTriangle, type: 'EXTREME BEAR', plainDetail: `${e.pair} — COT Index ${fmtIdx(e.idxNum)}. Cẩn thận reversal tăng.`, priority: 2 });
    } else if (e.idxNum > 90) {
      signals.push({ icon: SVG_ICONS.alertTriangle, type: 'EXTREME BULL', plainDetail: `${e.pair} — COT Index ${fmtIdx(e.idxNum)}. Cẩn thận reversal giảm.`, priority: 2 });
    }
    // Strong momentum detection
    const delta = e.delta !== undefined ? e.delta : ((e.prev !== null) ? e.cur - e.prev : null);
    const prevDelta = e.prev_delta !== undefined ? e.prev_delta : null;
    if (delta !== null && prevDelta !== null && Math.abs(delta) > Math.abs(prevDelta) * 1.8) {
      signals.push({ icon: SVG_ICONS.trendingUp, type: 'MOMENTUM', plainDetail: `${e.pair} — Tăng tốc mạnh. Δ tuần: ${fmtVN(delta)} vs tuần trước: ${fmtVN(prevDelta)}`, priority: 1 });
    }
    // OI Signals for export
    if (e.oi != null && e.oi_prev != null && e.oi_delta != null) {
      const oiChangePct = (e.oi_delta / e.oi_prev) * 100;
      if (Math.abs(oiChangePct) > 10) {
        const dir = oiChangePct > 0 ? 'tăng' : 'giảm';
        signals.push({ icon: SVG_ICONS.zap, type: 'OI SURGE', plainDetail: `${e.pair} — OI ${dir} ${Math.abs(oiChangePct).toFixed(1)}% (${fmtVN(e.oi_delta)}). Dòng tiền ${dir === 'tăng' ? 'mới đổ vào' : 'rút ra mạnh'}.`, priority: 2 });
      }
      if (delta !== null) {
        const netUp = delta > 0, oiDown = e.oi_delta < 0;
        if (netUp && oiDown && Math.abs(oiChangePct) > 3) {
          signals.push({ icon: SVG_ICONS.shuffle, type: 'OI DIVERG', plainDetail: `${e.pair} — Net tăng nhưng OI giảm ${Math.abs(oiChangePct).toFixed(1)}%. Short-covering, không phải dòng tiền mới.`, priority: 2 });
        } else if (!netUp && !oiDown && Math.abs(oiChangePct) > 3) {
          signals.push({ icon: SVG_ICONS.shuffle, type: 'OI DIVERG', plainDetail: `${e.pair} — Net giảm nhưng OI tăng ${Math.abs(oiChangePct).toFixed(1)}%. Dòng tiền mới đang short.`, priority: 2 });
        }
      }
      if ((e.idxNum > 90 || e.idxNum < 10) && e.oi_delta < 0 && Math.abs(oiChangePct) > 2) {
        signals.push({ icon: SVG_ICONS.signalExhaust, type: 'OI EXHAUST', plainDetail: `${e.pair} — ${e.idxNum > 90 ? 'EXTREME BULL' : 'EXTREME BEAR'} nhưng OI giảm ${Math.abs(oiChangePct).toFixed(1)}%. Xu hướng cạn kiệt động lực.`, priority: 3 });
      }
    }
  });
  signals.sort((a, b) => b.priority - a.priority);
  return signals;
}

// ── Markdown ──
function buildMarkdown(entries, sorted, longPairs, shortPairs, avoidPairs, weekLabel) {
  let md = `# COT MATRIX — ${weekLabel}\n`;
  md += `> Nguồn: CFTC.gov · Phương pháp: ICT · Generated: ${new Date().toLocaleString('vi-VN')}\n\n---\n\n`;

  md += `## COT Matrix\n\n`;
  md += `| Đồng tiền | Net hiện tại | Net thấp 52T | Net cao 52T | Net tuần trước | Δ Tuần | Change % | Momentum | Xu hướng 4T | COT Index | Đánh giá |\n`;
  md += `|-----------|-------------:|-------------:|------------:|---------------:|-------:|---------:|----------|-------------|----------:|---------|\n`;
  entries.forEach(e => {
    const z = getZone(e.idxNum);
    const delta = e.delta !== undefined ? e.delta : (e.prev !== null ? e.cur - e.prev : null);
    const dStr = delta !== null ? (delta >= 0 ? `+${fmtVN(Math.round(delta))}` : fmtVN(Math.round(delta))) : '—';
    const changePct = (delta !== null && e.prev !== null && e.prev !== 0) ? (delta / Math.abs(e.prev) * 100).toFixed(1) + '%' : '—';
    let momentum = '—';
    if (e.prev_delta !== undefined && e.prev_delta !== null && delta !== null) {
      const absCur = Math.abs(delta), absPrev = Math.abs(e.prev_delta);
      if (absCur > absPrev * 1.2) momentum = '▲ Tăng tốc';
      else if (absCur < absPrev * 0.8) momentum = '▽ Giảm tốc';
      else momentum = '— Ổn định';
    }
    md += `| **${e.pair}** | ${fmtVN(e.cur)} | ${fmtVN(e.lo)} | ${fmtVN(e.hi)} | ${e.prev !== null ? fmtVN(e.prev) : '—'} | ${dStr} | ${changePct} | ${momentum} | ${e.t4 || '—'} | **${fmtIdx(e.idxNum)}** | ${z.label} |\n`;
  });

  md += `\n---\n\n## Ranking (Mạnh → Yếu)\n\n`;
  sorted.forEach((e, i) => {
    const z = getZone(e.idxNum);
    const bar = '█'.repeat(Math.round(e.idxNum / 10)) + '░'.repeat(10 - Math.round(e.idxNum / 10));
    const tag = i === 0 ? ' ← **Strongest**' : i === sorted.length - 1 ? ' ← **Weakest**' : '';
    md += `${i+1}. **${e.pair}** \`${bar}\` ${fmtIdx(e.idxNum)} — ${z.label}${tag}\n`;
  });

  // 4-Week History section
  const hasHistory = entries.some(e => e.history_4w && e.history_4w.length >= 2);
  if (hasHistory) {
    md += `\n---\n\n## Lịch Sử 4 Tuần\n\n`;
    md += `| Đồng tiền | W-3 | W-2 | W-1 | Hiện tại | TB 3 tháng | Δ vs TB3 | TB 6 tháng | Δ vs TB6 |\n`;
    md += `|-----------|----:|----:|----:|---------:|-----------:|---------:|-----------:|---------:|\n`;
    sorted.forEach(e => {
      const hist = e.history_4w || [e.cur];
      const w3 = hist[3] !== undefined ? fmtVN(hist[3]) : '—';
      const w2 = hist[2] !== undefined ? fmtVN(hist[2]) : '—';
      const w1 = hist[1] !== undefined ? fmtVN(hist[1]) : '—';
      const w0 = fmtVN(hist[0]);
      const avg13 = e.avg_13w != null ? fmtVN(e.avg_13w) : '—';
      const avg26 = e.avg_26w != null ? fmtVN(e.avg_26w) : '—';
      const d13 = e.avg_13w != null ? ((e.cur - e.avg_13w) >= 0 ? '+' : '') + fmtVN(e.cur - e.avg_13w) : '—';
      const d26 = e.avg_26w != null ? ((e.cur - e.avg_26w) >= 0 ? '+' : '') + fmtVN(e.cur - e.avg_26w) : '—';
      md += `| **${e.pair}** | ${w3} | ${w2} | ${w1} | ${w0} | ${avg13} | ${d13} | ${avg26} | ${d26} |\n`;
    });
  }

  // OI section (if data available)
  const hasOI = entries.some(e => e.oi != null);
  if (hasOI) {
    md += `\n---\n\n## Open Interest\n\n`;
    md += `| Đồng tiền | OI | Δ OI | Confluence |\n`;
    md += `|-----------|---:|-----:|------------|\n`;
    entries.forEach(e => {
      const oi = e.oi != null ? fmtVN(e.oi) : '—';
      const oiD = e.oi_delta != null ? ((e.oi_delta >= 0 ? '+' : '') + fmtVN(e.oi_delta)) : '—';
      let conf = '—';
      if (e.oi != null && e.oi_delta != null) {
        const delta = e.delta !== undefined ? e.delta : (e.prev !== null ? e.cur - e.prev : 0);
        if (e.oi_delta > 0 && delta > 0) conf = 'STRONG';
        else if (e.oi_delta > 0 && delta < 0) conf = 'REVERSAL?';
        else if (e.oi_delta <= 0) conf = 'WEAK';
      }
      md += `| **${e.pair}** | ${oi} | ${oiD} | ${conf} |\n`;
    });
  }

  md += `\n---\n\n## Best Pairs Theo COT\n\n`;
  md += `### ↑ LONG\n`;
  if (longPairs.length) longPairs.slice(0,5).forEach(p => { md += `- \`${p.pair}\`\n`; });
  else md += `- —\n`;
  md += `\n### ↓ SHORT\n`;
  if (shortPairs.length) shortPairs.slice(0,5).forEach(p => { md += `- \`${p.pair}\`\n`; });
  else md += `- —\n`;
  md += `\n### Tránh\n`;
  if (avoidPairs.length) avoidPairs.slice(0,4).forEach(p => { md += `- \`${p}\`\n`; });
  else md += `- —\n`;

  // Signals section
  const signals = buildSignalsForExport(entries);
  md += `\n---\n\n## Tín Hiệu Đặc Biệt\n\n`;
  if (signals.length === 0) {
    md += `Không có tín hiệu đặc biệt tuần này.\n`;
  } else {
    signals.forEach(s => { md += `- ${s.icon} **${s.type}**: ${s.plainDetail}\n`; });
  }

  // Action Plan section
  const savedPlan = loadActionPlan(weekLabel);
  if (savedPlan && savedPlan.pairs && savedPlan.pairs.length > 0) {
    md += `\n---\n\n## Kế Hoạch Tuần Này\n\n`;
    savedPlan.pairs.forEach(p => {
      md += `- **${p.pair}** — Bias: ${p.bias || 'Neutral'}, Confidence: ${p.conf || 'TB'}${p.zone ? ', Vùng giá: ' + p.zone : ''}\n`;
    });
    if (savedPlan.notes) {
      md += `\n**Ghi chú:**\n${savedPlan.notes}\n`;
    }
  }

  md += `\n---\n\n## Bảng Tham Chiếu\n\n`;
  md += `| COT Index | Đánh giá | Bias |\n|-----------|----------|------|\n`;
  md += `| 0–10 | EXTREME BEAR | Cẩn thận reversal tăng |\n`;
  md += `| 10–25 | BEARISH | Short bias – monitor |\n`;
  md += `| 25–40 | BEARISH MILD | Short bias bình thường |\n`;
  md += `| 40–60 | NEUTRAL | Cần tín hiệu ICT khác |\n`;
  md += `| 60–75 | BULLISH MILD | Long bias bình thường |\n`;
  md += `| 75–90 | BULLISH | Long bias – monitor |\n`;
  md += `| 90–100 | EXTREME BULL | Cẩn thận reversal giảm |\n`;
  return md;
}

// ── JSON ──
function buildJSON(entries, weekLabel) {
  const data = {
    meta: { weekLabel, generated: new Date().toISOString(), source: 'CFTC.gov', method: 'ICT COT Index Calculator' },
    entries: entries.map(e => ({
      pair: e.pair,
      cur: e.cur,
      prev: e.prev,
      lo: e.lo,
      hi: e.hi,
      t4: e.t4 || '',
      cotIndex: parseFloat(e.idxNum.toFixed(2)),
      label: getZone(e.idxNum).label,
      delta: e.delta, prev_delta: e.prev_delta,
      oi: e.oi, oi_delta: e.oi_delta,
      history_4w: e.history_4w,
      avg_13w: e.avg_13w, avg_26w: e.avg_26w
    }))
  };
  return JSON.stringify(data, null, 2);
}

// ── CSV ──
function buildCSV(entries, weekLabel) {
  const header = ['Pair','Net Current','Net Prev','Net Low 52W','Net High 52W','Delta Week','Change%','Momentum','Trend 4W','OI','OI Delta','COT Index','Label'];
  const rows = entries.map(e => {
    const delta = e.delta !== undefined ? e.delta : (e.prev !== null ? e.cur - e.prev : '');
    const changePct = (delta !== '' && e.prev !== null && e.prev !== 0) ? (delta / Math.abs(e.prev) * 100).toFixed(1) : '';
    let momentum = '';
    if (e.prev_delta !== undefined && e.prev_delta !== null && delta !== '') {
      const absCur = Math.abs(delta), absPrev = Math.abs(e.prev_delta);
      if (absCur > absPrev * 1.2) momentum = 'Tăng tốc';
      else if (absCur < absPrev * 0.8) momentum = 'Giảm tốc';
      else momentum = 'Ổn định';
    }
    return [
      e.pair, e.cur, e.prev ?? '', e.lo, e.hi,
      delta !== '' ? Math.round(delta) : '',
      changePct,
      momentum,
      e.t4 || '',
      e.oi != null ? e.oi : '',
      e.oi_delta != null ? e.oi_delta : '',
      e.idxNum.toFixed(2),
      getZone(e.idxNum).label
    ].join(',');
  });
  return `# COT Matrix - ${weekLabel}\n` + header.join(',') + '\n' + rows.join('\n');
}

// ── Text Summary ──
function buildSummary(sorted, longPairs, shortPairs, avoidPairs, weekLabel) {
  let t = `COT MATRIX — ${weekLabel}\n`;
  t += '='.repeat(48) + '\n\n';

  t += 'RANKING (Mạnh → Yếu):\n';
  sorted.forEach((e, i) => {
    const z = getZone(e.idxNum);
    const tag = i === 0 ? ' ← Strongest' : i === sorted.length - 1 ? ' ← Weakest' : '';
    const bar = '█'.repeat(Math.round(e.idxNum / 10)) + '░'.repeat(10 - Math.round(e.idxNum / 10));
    t += `  ${i+1}. ${e.pair.padEnd(4)} [${bar}] ${fmtIdx(e.idxNum).padStart(5)}  ${z.label}${tag}\n`;
  });

  t += '\nBEST PAIRS THEO COT:\n';
  t += '  ↑ LONG:  ' + (longPairs.slice(0,5).map(p => p.pair).join('  ') || '—') + '\n';
  t += '  ↓ SHORT: ' + (shortPairs.slice(0,5).map(p => p.pair).join('  ') || '—') + '\n';
  t += '  TRÁNH: ' + (avoidPairs.slice(0,4).join('  ') || '—') + '\n';

  // OI Overview block
  const hasOI = sorted.some(e => e.oi != null);
  if (hasOI) {
    t += '\n' + '-'.repeat(48) + '\n';
    t += 'OPEN INTEREST:\n';
    sorted.forEach(e => {
      if (e.oi == null) return;
      const oiD = e.oi_delta != null ? (e.oi_delta >= 0 ? '+' : '') + fmtVN(e.oi_delta) : '—';
      const delta = e.delta !== undefined ? e.delta : (e.prev !== null ? e.cur - e.prev : 0);
      let conf = '—';
      if (e.oi_delta != null) {
        const aligned = (e.oi_delta > 0) && ((delta > 0 && e.cur > 0) || (delta < 0 && e.cur < 0));
        if (aligned) conf = 'STRONG';
        else if (e.oi_delta > 0) conf = 'REVERSAL?';
        else conf = 'WEAK';
      }
      t += `  ${e.pair.padEnd(4)} OI: ${fmtVN(e.oi).padStart(10)}  Δ: ${oiD.padStart(8)}  ${conf}\n`;
    });
  }

  // Signals block
  const signals = buildSignalsForExport(sorted);
  t += '\n' + '-'.repeat(48) + '\n';
  t += 'TÍN HIỆU ĐẶC BIỆT:\n';
  if (signals.length === 0) {
    t += '  Không có tín hiệu đặc biệt tuần này.\n';
  } else {
    signals.forEach(s => { t += `  ${s.icon} ${s.type}: ${s.plainDetail}\n`; });
  }

  // Action Plan block
  const savedPlan = loadActionPlan(weekLabel);
  if (savedPlan && savedPlan.pairs && savedPlan.pairs.length > 0) {
    t += '\n' + '-'.repeat(48) + '\n';
    t += 'KẾ HOẠCH TUẦN NÀY:\n';
    savedPlan.pairs.forEach(p => {
      t += `  ${p.pair} — Bias: ${p.bias || 'Neutral'}, Confidence: ${p.conf || 'TB'}${p.zone ? ', Vùng giá: ' + p.zone : ''}\n`;
    });
    if (savedPlan.notes) {
      t += `  Ghi chú: ${savedPlan.notes}\n`;
    }
  }

  t += '\n' + '-'.repeat(48) + '\n';
  t += `Generated: ${new Date().toLocaleString('vi-VN')}\n`;
  t += 'Nguồn: CFTC.gov · ICT COT Index Calculator\n';
  return t;
}

// ── Actions ──
function copyExport() {
  const txt = document.getElementById('exportTextarea').value;
  navigator.clipboard.writeText(txt).then(() => showToast(`${SVG_ICONS.check} Đã copy!`)).catch(() => {
    document.getElementById('exportTextarea').select();
    document.execCommand('copy');
    showToast(`${SVG_ICONS.check} Đã copy!`);
  });
}

function downloadExport() {
  const txt = document.getElementById('exportTextarea').value;
  const filename = document.getElementById('expFilename').textContent || 'cot-matrix.md';
  const mimeMap = { md: 'text/markdown', json: 'application/json', csv: 'text/csv', txt: 'text/plain' };
  const ext = filename.split('.').pop();
  const blob = new Blob([txt], { type: (mimeMap[ext] || 'text/plain') + ';charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
  showToast('⬇ Đang tải về...');
}


// ═══════════════════════════════════════════════════
//  GITHUB CONFIG + AUTO-FETCH
// ═══════════════════════════════════════════════════
let _matrixWeekOverride = null; // set by auto-fetch, used by generateMatrix

// ── GitHub Config: Save / Edit / Init ──
function saveGhConfig() {
  const user = document.getElementById('ghUsername').value.trim();
  const repo = document.getElementById('ghRepo').value.trim();
  if (!user || !repo) { alert('Vui lòng nhập cả Username và Tên Repo.'); return; }
  if (!/^[a-zA-Z0-9_.-]+$/.test(user) || !/^[a-zA-Z0-9_.-]+$/.test(repo)) {
    alert('Username hoặc Repo chứa ký tự không hợp lệ.\nChỉ cho phép: a-z, 0-9, dấu chấm, gạch dưới, gạch ngang.');
    return;
  }
  localStorage.setItem('gh_username', user);
  localStorage.setItem('gh_repo', repo);
  showToast(`${SVG_ICONS.check} Đã lưu cấu hình GitHub`);
  renderGhConfigCollapsed(user, repo);
  enableFetchButton();
}

function editGhConfig() {
  const card = document.getElementById('ghConfigCard');
  card.classList.remove('collapsed');
  const body = document.getElementById('ghConfigBody');
  body.classList.remove('hidden');
  // Restore form inputs
  body.innerHTML = `
    <div class="gh-config-row">
      <div class="field">
        <label>GitHub Username</label>
        <input type="text" id="ghUsername" placeholder="your-username" autocomplete="off"
          value="${localStorage.getItem('gh_username') || ''}" />
      </div>
      <div class="field">
        <label>Tên Repo</label>
        <input type="text" id="ghRepo" placeholder="cot-data" autocomplete="off"
          value="${localStorage.getItem('gh_repo') || ''}" />
      </div>
      <button class="btn-gh-save" onclick="saveGhConfig()">Lưu</button>
    </div>`;
  document.getElementById('ghHeaderRight').innerHTML = '';
}

function renderGhConfigCollapsed(user, repo) {
  const card = document.getElementById('ghConfigCard');
  card.classList.add('collapsed');
  const body = document.getElementById('ghConfigBody');
  body.classList.add('hidden');
  document.getElementById('ghHeaderRight').innerHTML = `
    <div class="gh-status-row">
      <span class="gh-status-text">
        <a class="gh-repo-link" href="https://github.com/${user}/${repo}" target="_blank" rel="noopener">${user}/${repo}</a>
      </span>
      <button class="btn-gh-edit" onclick="editGhConfig()" style="display:flex;align-items:center;gap:4px">${SVG_ICONS.edit} Sửa</button>
    </div>`;
}

function enableFetchButton() {
  const btn = document.getElementById('btnFetchCftc');
  btn.disabled = false;
  btn.title = '';
  // Check if cache exists for current week → show "Làm mới" label
  const cached = loadCftcCache();
  if (cached) {
    btn.innerHTML = '⬡ Làm Mới Dữ Liệu CFTC';
  } else {
    btn.innerHTML = '⬡ Lấy Dữ Liệu CFTC';
  }
}

function initGhConfig() {
  const user = localStorage.getItem('gh_username');
  const repo = localStorage.getItem('gh_repo');
  if (user && repo) {
    renderGhConfigCollapsed(user, repo);
    enableFetchButton();
    document.getElementById('ghUsername').value = user;
    document.getElementById('ghRepo').value = repo;
  }
}

// ── Cache ──
function saveCftcCache(payload) {
  const cacheObj = {
    timestamp: new Date().toISOString(),
    data: payload
  };
  localStorage.setItem('cftc_cache', JSON.stringify(cacheObj));
}

function loadCftcCache() {
  try {
    const raw = localStorage.getItem('cftc_cache');
    if (!raw) return null;
    return JSON.parse(raw);
  } catch(e) { return null; }
}

function renderCacheInfo() {
  const el = document.getElementById('fetchCacheInfo');
  const cached = loadCftcCache();
  if (!cached) { el.innerHTML = ''; return; }

  const ts = new Date(cached.timestamp);
  const meta = cached.data && cached.data.meta;
  const weekLabel = meta ? meta.weekLabel : '?';
  const dateStr = ts.toLocaleDateString('vi-VN', {day:'2-digit',month:'2-digit',year:'numeric'});
  const timeStr = ts.toLocaleTimeString('vi-VN', {hour:'2-digit',minute:'2-digit'});

  el.innerHTML = `<span class="cache-label">Cache:</span> Dữ liệu tuần <strong>${weekLabel}</strong> — cache từ ${dateStr} lúc ${timeStr}`;
}

// ── Fetch from GitHub ──
async function fetchCftcFromGitHub() {
  const user = localStorage.getItem('gh_username');
  const repo = localStorage.getItem('gh_repo');
  if (!user || !repo) { showToast(`${SVG_ICONS.alertTriangle} Chưa cấu hình GitHub`, 'warn'); return; }

  const btn = document.getElementById('btnFetchCftc');
  const statusEl = document.getElementById('fetchStatus');

  // Loading state
  btn.className = 'btn-fetch-cftc loading';
  btn.innerHTML = '<span class="fetch-spinner"></span> Đang tải...';
  btn.disabled = true;
  statusEl.textContent = '';
  statusEl.className = 'fetch-status';

  const url = `https://raw.githubusercontent.com/${user}/${repo}/main/data/cot-latest.json`;

  try {
    const res = await fetch(url);

    if (!res.ok) {
      // ── Case: 404 ──
      if (res.status === 404) {
        btn.className = 'btn-fetch-cftc error';
        btn.innerHTML = SVG_ICONS.x + ' Không tìm thấy file';
        statusEl.innerHTML = '404 — File <code>data/cot-latest.json</code> chưa tồn tại.<br>GitHub Actions có thể chưa chạy lần đầu, hoặc file path khác.';
        statusEl.className = 'fetch-status error';
        resetFetchBtnAfter(4000);
        return;
      }

      // ── Case: 403 (private repo) ──
      if (res.status === 403) {
        btn.className = 'btn-fetch-cftc error';
        btn.innerHTML = SVG_ICONS.x + ' Repo Private';
        statusEl.innerHTML = '403 — Repo có thể là private.<br>Hãy đổi repo sang <strong>public</strong> hoặc kiểm tra lại tên repo.';
        statusEl.className = 'fetch-status error';
        resetFetchBtnAfter(4000);
        return;
      }

      throw new Error(`HTTP ${res.status}`);
    }

    const text = await res.text();
    let payload;
    try {
      payload = JSON.parse(text);
    } catch(e) {
      // ── Case: JSON sai format ──
      btn.className = 'btn-fetch-cftc error';
      btn.innerHTML = SVG_ICONS.x + ' JSON lỗi format';
      statusEl.innerHTML = `File JSON không parse được: ${e.message.slice(0,80)}<br><a href="https://github.com/${user}/${repo}/blob/main/scripts/fetch_cot.py" target="_blank" style="color:var(--accent)">Xem script fetch_cot.py →</a>`;
      statusEl.className = 'fetch-status error';
      resetFetchBtnAfter(4000);
      return;
    }

    // Validate structure
    if (!payload.entries || !Array.isArray(payload.entries) || payload.entries.length === 0) {
      btn.className = 'btn-fetch-cftc error';
      btn.innerHTML = SVG_ICONS.x + ' Dữ liệu rỗng';
      statusEl.innerHTML = 'JSON có format đúng nhưng thiếu <code>entries</code> hoặc entries rỗng.';
      statusEl.className = 'fetch-status error';
      resetFetchBtnAfter(4000);
      return;
    }

    // Validate required fields in entries
    const requiredFields = ['pair', 'cur', 'lo', 'hi'];
    const missingFields = [];
    for (const entry of payload.entries) {
      for (const f of requiredFields) {
        if (entry[f] === undefined || entry[f] === null) {
          missingFields.push(`${entry.pair || '?'}: thiếu '${f}'`);
        }
      }
    }
    if (missingFields.length > 0) {
      btn.className = 'btn-fetch-cftc error';
      btn.innerHTML = SVG_ICONS.x + ' Field thiếu';
      statusEl.innerHTML = `Các field bắt buộc bị thiếu:<br>${missingFields.slice(0,5).join('<br>')}<br><a href="https://github.com/${user}/${repo}/blob/main/scripts/fetch_cot.py" target="_blank" style="color:var(--accent)">Kiểm tra script →</a>`;
      statusEl.className = 'fetch-status error';
      resetFetchBtnAfter(4000);
      return;
    }

    // ── Case: Stale data (> 10 days old) ──
    if (payload.meta && payload.meta.fetchedAt) {
      const fetchedDate = new Date(payload.meta.fetchedAt);
      const daysDiff = (Date.now() - fetchedDate.getTime()) / (1000 * 60 * 60 * 24);
      if (daysDiff > 10) {
        statusEl.innerHTML = `<span style="display:flex;align-items:center;gap:4px">${SVG_ICONS.alertTriangle} Dữ liệu đã cũ (${Math.floor(daysDiff)} ngày trước). Có thể GitHub Actions đã không chạy gần đây.`;
        statusEl.className = 'fetch-status warn';
      }
    }

    // ── Success → populate matrix ──
    saveCftcCache(payload);
    renderCacheInfo();

    // Convert entries to matrixEntries format
    matrixEntries = payload.entries.slice(0, 8).map(e => {
      const cur = typeof e.cur === 'number' ? e.cur : parseVN(e.cur);
      const prev = (e.prev !== null && e.prev !== undefined) ? (typeof e.prev === 'number' ? e.prev : parseVN(e.prev)) : null;
      const lo = typeof e.lo === 'number' ? e.lo : parseVN(e.lo);
      const hi = typeof e.hi === 'number' ? e.hi : parseVN(e.hi);
      const range = hi - lo;
      const idxNum = range > 0 ? Math.min(100, Math.max(0, ((cur - lo) / range) * 100)) : 50;
      return {
        pair: e.pair,
        cur, prev: (prev !== null && !isNaN(prev)) ? prev : null,
        lo, hi,
        t4: e.t4 || '',
        idxNum: e.idxNum !== undefined ? e.idxNum : idxNum,
        delta: e.delta, prev_delta: e.prev_delta,
        oi: e.oi, oi_prev: e.oi_prev, oi_delta: e.oi_delta,
        history_4w: e.history_4w, avg_13w: e.avg_13w, avg_26w: e.avg_26w
      };
    });


    // Set data source info
    const weekLabel = payload.meta ? payload.meta.weekLabel : '';
    _matrixWeekOverride = weekLabel ? `Tuần ${weekLabel}` : null;

    // Auto-generate matrix
    generateMatrix();

    // Success state
    btn.className = 'btn-fetch-cftc success';
    btn.innerHTML = SVG_ICONS.check + ' Đã tải xong!';
    const entryCount = payload.entries.length;
    if (!statusEl.innerHTML.includes('alertTriangle')) {
      statusEl.textContent = `Thành công — ${entryCount} đồng tiền từ ${weekLabel || 'CFTC'}`;
    }
    showToast(`${SVG_ICONS.check} Đã tải ${entryCount} đồng tiền từ CFTC`);

    resetFetchBtnAfter(3000);

  } catch(err) {
    // ── Case: Network offline / other errors ──
    btn.className = 'btn-fetch-cftc error';
    btn.innerHTML = SVG_ICONS.x + ' Lỗi kết nối';

    const cached = loadCftcCache();
    if (cached && cached.data && cached.data.entries) {
      statusEl.innerHTML = `Không thể kết nối: ${err.message}.<br>` +
        `<button class="btn-gh-edit" onclick="loadFromCache()" style="margin-top:6px">↻ Dùng cache lần trước</button>`;
    } else {
      statusEl.innerHTML = `Không thể kết nối: ${err.message}.<br>Kiểm tra kết nối mạng và thử lại.`;
    }
    statusEl.className = 'fetch-status error';
    resetFetchBtnAfter(4000);
  }
}

function loadFromCache() {
  const cached = loadCftcCache();
  if (!cached || !cached.data || !cached.data.entries) {
    showToast(`${SVG_ICONS.alertTriangle} Không có cache`, 'warn');
    return;
  }

  const payload = cached.data;
  matrixEntries = payload.entries.slice(0, 8).map(e => {
    const cur = typeof e.cur === 'number' ? e.cur : parseVN(e.cur);
    const prev = (e.prev !== null && e.prev !== undefined) ? (typeof e.prev === 'number' ? e.prev : parseVN(e.prev)) : null;
    const lo = typeof e.lo === 'number' ? e.lo : parseVN(e.lo);
    const hi = typeof e.hi === 'number' ? e.hi : parseVN(e.hi);
    return {
      pair: e.pair, cur, prev: (prev !== null && !isNaN(prev)) ? prev : null,
      lo, hi, t4: e.t4 || '',
      idxNum: e.idxNum !== undefined ? e.idxNum : 50,
      delta: e.delta, prev_delta: e.prev_delta,
      oi: e.oi, oi_prev: e.oi_prev, oi_delta: e.oi_delta,
      history_4w: e.history_4w, avg_13w: e.avg_13w, avg_26w: e.avg_26w
    };
  });


  const weekLabel = payload.meta ? payload.meta.weekLabel : '';
  _matrixWeekOverride = weekLabel ? `Tuần ${weekLabel}` : null;
  generateMatrix();

  document.getElementById('fetchStatus').textContent = `Đã load từ cache — ${weekLabel}`;
  document.getElementById('fetchStatus').className = 'fetch-status';
  showToast(`${SVG_ICONS.check} Đã load ${matrixEntries.length} đồng tiền từ cache`);
}

function resetFetchBtnAfter(ms) {
  setTimeout(() => {
    const btn = document.getElementById('btnFetchCftc');
    btn.className = 'btn-fetch-cftc';
    btn.disabled = false;
    const cached = loadCftcCache();
    btn.innerHTML = cached ? '⬡ Làm Mới Dữ Liệu CFTC' : '⬡ Lấy Dữ Liệu CFTC';
  }, ms);
}



// ═══════════════════════════════════════════════════
//  LOCK WEEKLY BIAS
// ═══════════════════════════════════════════════════
function renderLockBiasGrid(sorted) {
  const card = document.getElementById('lockBiasCard');
  card.style.display = '';
  const grid = document.getElementById('lockBiasGrid');
  const saved = loadLockedBias();
  grid.innerHTML = sorted.map(e => {
    const z = getZone(e.idxNum);
    const lockedVal = saved && saved.pairs ? (saved.pairs.find(p => p.pair === e.pair) || {}).bias : null;
    const biasLabel = e.idxNum >= 60 ? 'LONG' : e.idxNum <= 40 ? 'SHORT' : 'NEUTRAL';
    const isLocked = lockedVal !== undefined && lockedVal !== null;
    return `<div style="background:var(--bg);border:1px solid ${isLocked ? z.color : 'var(--border)'};border-radius:3px;padding:10px;text-align:center;">
      <div style="font-weight:700;font-size:13px;color:${z.color}">${e.pair}</div>
      <div style="font-size:11px;color:var(--muted);margin:4px 0">${fmtIdx(e.idxNum)} — ${z.label}</div>
      <div style="font-size:12px;font-weight:700;color:${biasLabel === 'LONG' ? 'var(--green)' : biasLabel === 'SHORT' ? 'var(--red)' : 'var(--muted)'}">${lockedVal || biasLabel}</div>
    </div>`;
  }).join('');
}

function lockWeeklyBias() {
  if (!matrixEntries.length) return;
  const sorted = [...matrixEntries].sort((a, b) => b.idxNum - a.idxNum);
  const pairs = sorted.map(e => ({
    pair: e.pair,
    cotIndex: e.idxNum,
    bias: e.idxNum >= 60 ? 'LONG' : e.idxNum <= 40 ? 'SHORT' : 'NEUTRAL',
    label: getZone(e.idxNum).label
  }));
  const bulls = sorted.filter(e => e.idxNum >= 60);
  const bears = sorted.filter(e => e.idxNum <= 40);
  const recommended_pairs = [];
  bulls.forEach(b => {
    bears.forEach(br => {
      recommended_pairs.push(`${b.pair}/${br.pair}`);
      recommended_pairs.push(`${br.pair}/${b.pair}`);
    });
  });

  const lock = {
    pairs,
    recommended_pairs,
    weekLabel: _matrixWeekOverride || new Date().toLocaleDateString('vi-VN'),
    lockedAt: new Date().toISOString()
  };
  localStorage.setItem('nexus_weekly_bias', JSON.stringify(lock));
  const status = document.getElementById('lockBiasStatus');
  status.innerHTML = SVG_ICONS.check + ' Đã lock bias!';
  status.style.opacity = '1';
  setTimeout(() => status.style.opacity = '0', 2500);
  showToast(`${SVG_ICONS.check} Weekly Bias đã lock — có thể dùng trong Daily Bias Board`);
  renderLockBiasGrid(sorted);
}

function clearWeeklyBias() {
  if (!confirm('Xoá Weekly Bias đã lock?')) return;
  localStorage.removeItem('nexus_weekly_bias');
  showToast('Đã xoá Weekly Bias lock');
  if (matrixEntries.length) {
    const sorted = [...matrixEntries].sort((a, b) => b.idxNum - a.idxNum);
    renderLockBiasGrid(sorted);
  }
}

function loadLockedBias() {
  try { return JSON.parse(localStorage.getItem('nexus_weekly_bias') || 'null'); }
  catch(e) { return null; }
}

// ═══════════════════════════════════════════════════
//  ALERT HISTORY
// ═══════════════════════════════════════════════════
function saveCurrentAlerts() {
  if (!matrixEntries.length) { showToast(`${SVG_ICONS.alertTriangle} Chưa có Matrix data`, 'warn'); return; }
  const signals = buildSignalsForExport(matrixEntries);
  const entry = {
    weekLabel: _matrixWeekOverride || new Date().toLocaleDateString('vi-VN'),
    savedAt: new Date().toISOString(),
    signals: signals.map(s => ({ type: s.type, detail: s.plainDetail, priority: s.priority }))
  };
  const history = loadAlertHistory();
  // Avoid duplicate weeks
  const existing = history.findIndex(h => h.weekLabel === entry.weekLabel);
  if (existing >= 0) history[existing] = entry;
  else history.unshift(entry);
  // Keep last 12 weeks
  if (history.length > 12) history.length = 12;
  localStorage.setItem('nexus_alerts', JSON.stringify(history));
  showToast(`${SVG_ICONS.check} Đã lưu ${entry.signals.length} tín hiệu cho ${entry.weekLabel}`);
  renderAlertHistory();
}

function loadAlertHistory() {
  try { return JSON.parse(localStorage.getItem('nexus_alerts') || '[]'); }
  catch(e) { return []; }
}

function clearAlertHistory() {
  if (!confirm('Xoá toàn bộ Alert History?')) return;
  localStorage.removeItem('nexus_alerts');
  renderAlertHistory();
  showToast('Đã xoá Alert History');
}

function renderAlertHistory() {
  const card = document.getElementById('alertHistoryCard');
  card.style.display = '';
  const el = document.getElementById('alertHistoryList');
  const history = loadAlertHistory();
  if (!history.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:10px 0;">Chưa có lịch sử. Nhấn "Lưu Tín Hiệu" sau khi tạo Matrix.</div>';
    return;
  }
  el.innerHTML = history.map(h => {
    const d = new Date(h.savedAt);
    const dateStr = d.toLocaleDateString('vi-VN', {day:'2-digit',month:'2-digit'});
    return `<div style="border-bottom:1px solid var(--border);padding:10px 0;">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
        <span style="font-weight:700;font-size:13px;">${h.weekLabel}</span>
        <span style="font-size:11px;color:var(--muted);">${dateStr} · ${h.signals.length} tín hiệu</span>
      </div>
      ${h.signals.length ? h.signals.slice(0, 5).map(s =>
        `<div style="font-size:12px;color:var(--muted);padding:2px 0;">
          <span style="font-size:10px;font-weight:700;color:var(--text);background:rgba(136,153,187,0.08);padding:1px 5px;border-radius:2px;">${s.type}</span>
          ${s.detail}
        </div>`
      ).join('') : '<div style="font-size:12px;color:var(--muted);font-style:italic;">Không có tín hiệu</div>'}
      ${h.signals.length > 5 ? `<div style="font-size:11px;color:var(--muted);margin-top:4px;">+${h.signals.length - 5} tín hiệu khác</div>` : ''}
    </div>`;
  }).join('');
}

// Patch generateMatrix to also render Lock Bias + Alert History
const _origGenerateMatrix = generateMatrix;
generateMatrix = function() {
  _origGenerateMatrix();
  if (matrixEntries.length >= 2) {
    const sorted = [...matrixEntries].sort((a, b) => b.idxNum - a.idxNum);
    renderLockBiasGrid(sorted);
    renderAlertHistory();
  }
};

// ═══════════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════════
initGhConfig();
renderCacheInfo();
renderAlertHistory();
</script>
</body>
</html>
